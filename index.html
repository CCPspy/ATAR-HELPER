<!-- 
    ATAR HELPER v2.0 | INTERFACE UPDATE
    LAYER ARCHITECTURE: GATEWAY -> CONFIG -> ARENA -> DEBRIEF
    PROPERTY OF ERIC / CCPSPY
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ATAR Helper v2.0</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* Dark Premium Background */
            color: #e2e8f0;
            overflow: hidden;
            touch-action: none;
        }

        /* --- GLASSMORPHISM SYSTEM --- */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .glass-pill {
            background: rgba(2, 6, 23, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s ease;
        }
        .glass-input:focus { outline: none; border-color: #3b82f6; background: rgba(0, 0, 0, 0.6); }

        /* --- UTILITIES --- */
        .text-gradient {
            background: linear-gradient(to right, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        /* --- ANIMATIONS --- */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        
        .slide-in-right { animation: slideRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            border-radius: 50%; background: #34d399; margin-top: -6px; cursor: pointer;
            box-shadow: 0 0 10px rgba(52, 211, 153, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: rgba(255,255,255,0.1); border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- GLOBAL CONSTANTS ---
        const MATH_SYMBOLS = [
            { label: 'π', val: '\\pi ' },
            { label: 'θ', val: '\\theta ' },
            { label: 'x²', val: '^2 ' },
            { label: '√', val: '\\sqrt{} ' },
            { label: '∫', val: '\\int ' },
            { label: 'frac', val: '\\frac{}{} ' },
            { label: '∞', val: '\\infty ' },
            { label: '≤', val: '\\le ' },
        ];

        const CURRICULUM = {
            "Methods": { "Year 11": ["Functions", "Trig", "Prob", "Calculus"], "Year 12": ["Calculus II", "Integrals", "Random Var", "Logarithms", "Stats"] },
            "Specialist": { "Year 11": ["Combinatorics", "Vectors", "Geometry", "Matrices"], "Year 12": ["Complex II", "Vectors 3D", "Diff Eq", "Integration II"] },
            "Physics": { "Year 11": ["Heat", "Nuclear", "Circuits", "Motion"], "Year 12": ["Gravity", "Electromagnetism", "Revolutions", "Quantum"] },
            "Chemistry": { "Year 11": ["Atomic", "Bonding", "Organic", "Solutions"], "Year 12": ["Equilibrium", "Acids", "Redox", "Synthesis"] }
        };

        // --- AI ENGINE (SIMPLIFIED FOR SCOPE) ---
        let GEMINI_KEYS = []; 
        let MANUAL_KEY = "";
        let SUBJECT_CONTEXT = "";

        const AI_ENGINE = {
            init: async () => {
                try {
                    const res = await fetch(`GE.txt?v=${new Date().getTime()}`);
                    if(res.ok) GEMINI_KEYS = (await res.text()).split('\n').filter(k=>k.length>10).map(k=>k.trim());
                } catch(e) { console.warn("No Auto-Keys"); }
            },
            call: async (prompt, img = null, json = false) => {
                const key = MANUAL_KEY || GEMINI_KEYS[Math.floor(Math.random()*GEMINI_KEYS.length)];
                if(!key) throw new Error("No API Key");
                
                const parts = [{ text: prompt }];
                if(img) parts.push({ inline_data: { mime_type: "image/png", data: img.split(',')[1] } });

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts }],
                        generationConfig: { responseMimeType: json ? "application/json" : "text/plain" }
                    })
                });
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            }
        };

        // --- COMPONENTS ---

        // 1. Math Render Component
        const Latex = ({ text }) => {
            const html = useMemo(() => {
                if(!text) return "";
                return text.replace(/\$([^$]+)\$/g, (_, tex) => {
                    try { return katex.renderToString(tex, { throwOnError: false }); } 
                    catch { return tex; }
                });
            }, [text]);
            return <div className="font-serif text-lg leading-loose" dangerouslySetInnerHTML={{__html: html}} />;
        };

        // 2. Whiteboard Component (Canvas)
        const Whiteboard = ({ tool, color, triggerClear, onDraw }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const ctxRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                const parent = canvas.parentElement;
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;
                const ctx = canvas.getContext('2d');
                ctx.lineCap = "round";
                ctx.lineJoin = "round";
                ctxRef.current = ctx;

                const handleResize = () => {
                    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
                    canvas.width = parent.clientWidth;
                    canvas.height = parent.clientHeight;
                    ctx.putImageData(img,0,0);
                    ctx.lineCap = "round"; ctx.lineJoin = "round";
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                if(triggerClear > 0 && ctxRef.current) {
                    ctxRef.current.clearRect(0,0,canvasRef.current.width, canvasRef.current.height);
                }
            }, [triggerClear]);

            const getPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x, y };
            };

            const start = (e) => {
                setIsDrawing(true);
                const {x, y} = getPos(e);
                ctxRef.current.beginPath();
                ctxRef.current.moveTo(x, y);
                onDraw && onDraw(canvasRef.current);
            };

            const move = (e) => {
                if(!isDrawing) return;
                const {x, y} = getPos(e);
                ctxRef.current.lineWidth = tool === 'eraser' ? 20 : 2;
                ctxRef.current.globalCompositeOperation = tool === 'eraser' ? 'destination-out' : 'source-over';
                ctxRef.current.strokeStyle = color;
                ctxRef.current.lineTo(x, y);
                ctxRef.current.stroke();
            };

            return (
                <canvas 
                    ref={canvasRef}
                    className="absolute inset-0 z-0 touch-none cursor-crosshair"
                    onMouseDown={start} onMouseMove={move} onMouseUp={()=>setIsDrawing(false)}
                    onTouchStart={start} onTouchMove={move} onTouchEnd={()=>setIsDrawing(false)}
                />
            );
        };

        // --- MAIN APP ---
        const App = () => {
            // View State
            const [view, setView] = useState('GATEWAY'); // GATEWAY, CONFIG, ARENA, DEBRIEF
            
            // User & Config State
            const [user, setUser] = useState('');
            const [config, setConfig] = useState({
                subject: 'Methods',
                level: 'Year 12',
                qCount: 5,
                mode: 'Comprehensive', // or Targeted
                selectedTopics: [],
                extraInstructions: '',
                apiKeyOverride: ''
            });

            // Session State
            const [questions, setQuestions] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [timer, setTimer] = useState(0);
            const [sessionActive, setSessionActive] = useState(false);
            
            // Arena UI State
            const [wbTool, setWbTool] = useState('pen');
            const [wbColor, setWbColor] = useState('#ffffff');
            const [clearTrig, setClearTrig] = useState(0);
            const [qCardOpen, setQCardOpen] = useState(true);
            const [mathKbOpen, setMathKbOpen] = useState(false);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [drawerMode, setDrawerMode] = useState('CHAT'); // CHAT or RESULT
            const [inputVal, setInputVal] = useState('');
            const [messages, setMessages] = useState([]);
            const [feedback, setFeedback] = useState(null);
            const [loading, setLoading] = useState(false);
            const canvasRef = useRef(null);

            // Init
            useEffect(() => { AI_ENGINE.init(); }, []);
            
            // Timer Logic
            useEffect(() => {
                let interval;
                if(sessionActive) interval = setInterval(() => setTimer(t=>t+1), 1000);
                return () => clearInterval(interval);
            }, [sessionActive]);

            // --- HANDLERS ---

            const handleInitialize = () => {
                if(user.trim().length > 1) setView('CONFIG');
            };

            const toggleTopic = (t) => {
                setConfig(prev => {
                    const exists = prev.selectedTopics.includes(t);
                    const newTopics = exists ? prev.selectedTopics.filter(x=>x!==t) : [...prev.selectedTopics, t];
                    return { ...prev, selectedTopics: newTopics };
                });
            };

            const startSession = async () => {
                if(config.apiKeyOverride) MANUAL_KEY = config.apiKeyOverride;
                
                setLoading(true);
                // Mock generating placeholders for immediate UI response
                const placeholders = Array(config.qCount).fill().map((_, i) => ({
                    id: i, status: 'pending', text: 'Loading Question...', topic: 'General', marks: 3
                }));
                setQuestions(placeholders);
                setView('ARENA');
                setSessionActive(true);
                setDrawerOpen(false);

                // Start Async Generation (Background)
                const topics = config.mode === 'Targeted' && config.selectedTopics.length > 0 
                    ? config.selectedTopics 
                    : CURRICULUM[config.subject][config.level];
                
                // Generate first question immediately
                await generateQuestion(0, topics);
                setLoading(false);
                
                // Lazy load rest
                for(let i=1; i<config.qCount; i++) {
                    generateQuestion(i, topics);
                }
            };

            const generateQuestion = async (index, topicList) => {
                const topic = topicList[Math.floor(Math.random() * topicList.length)];
                const prompt = `
                    Subject: WACE ATAR ${config.subject} ${config.level}. Topic: ${topic}.
                    Instructions: ${config.extraInstructions}.
                    Generate 1 math question. JSON Format: {"text": "LaTeX string", "answer": "short ans", "marks": 3}.
                `;
                try {
                    const resStr = await AI_ENGINE.call(prompt, null, true);
                    const data = JSON.parse(resStr);
                    setQuestions(prev => {
                        const next = [...prev];
                        next[index] = { ...next[index], ...data, status: 'active' };
                        return next;
                    });
                } catch(e) { console.error(e); }
            };

            const submitAnswer = async () => {
                setLoading(true);
                const q = questions[currentQIndex];
                const canvasImg = canvasRef.current ? canvasRef.current.toDataURL() : null;
                
                const prompt = `
                    Grade this student. 
                    Question: ${q.text}. Correct Answer: ${q.answer}. 
                    Student Input: ${inputVal}.
                    Max Marks: ${q.marks}.
                    Analyze the image if provided for working marks.
                    JSON Output: {"mark": number, "correct": boolean, "positives": "txt", "improvements": "txt"}.
                `;
                
                try {
                    const resStr = await AI_ENGINE.call(prompt, canvasImg, true);
                    const res = JSON.parse(resStr);
                    setFeedback(res);
                    
                    setQuestions(prev => {
                        const next = [...prev];
                        next[currentQIndex].status = res.correct ? 'correct' : 'wrong';
                        next[currentQIndex].score = res.mark;
                        return next;
                    });

                    setDrawerMode('RESULT');
                    setDrawerOpen(true);
                } catch(e) { alert("Grading Error"); }
                setLoading(false);
            };

            const handleGiveUp = () => {
                const q = questions[currentQIndex];
                setFeedback({
                    mark: 0, correct: false, 
                    positives: "Question Surrendered", 
                    improvements: `The correct answer was: ${q.answer}`
                });
                setQuestions(prev => {
                    const next = [...prev];
                    next[currentQIndex].status = 'wrong';
                    return next;
                });
                setDrawerMode('RESULT');
                setDrawerOpen(true);
            };

            const sendChat = async () => {
                if(!inputVal) return;
                const txt = inputVal; 
                setInputVal('');
                setMessages(prev => [...prev, {role:'user', text: txt}]);
                
                const context = `Current Q: ${questions[currentQIndex]?.text}. Subject: ${config.subject}.`;
                try {
                    const res = await AI_ENGINE.call(`Context: ${context}. User asked: ${txt}. Reply concisely.`, null, false);
                    setMessages(prev => [...prev, {role:'ai', text: res}]);
                } catch(e) {}
            };

            // --- RENDERERS ---

            // LAYER 1: GATEWAY
            if (view === 'GATEWAY') return (
                <div className="h-screen w-full flex items-center justify-center relative">
                    {/* Background decoration */}
                    <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-[#020617] -z-10"></div>
                    
                    <div className="glass-panel w-full max-w-md rounded-2xl p-8 flex flex-col items-center gap-6 fade-in border-t border-white/20">
                        <div className="w-full text-center pb-6 border-b border-blue-500/30 relative">
                            <h1 className="text-4xl font-extrabold tracking-tight text-gradient">ATAR HELPER</h1>
                            <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-20 h-1 bg-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.8)] rounded-full"></div>
                        </div>

                        <div className="w-full space-y-2">
                            <label className="text-xs font-bold text-slate-400 tracking-widest ml-1">IDENTITY</label>
                            <input 
                                type="text" 
                                placeholder="ENTER SURNAME" 
                                className="w-full bg-black/40 border border-white/10 rounded-lg py-4 px-4 text-center text-xl font-bold tracking-wider text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all uppercase placeholder-slate-600"
                                value={user}
                                onChange={(e) => setUser(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && handleInitialize()}
                            />
                        </div>

                        <button 
                            onClick={handleInitialize}
                            disabled={user.length < 2}
                            className="w-full bg-slate-100 hover:bg-white text-slate-900 font-bold py-4 rounded-lg transition-all transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_0_20px_rgba(255,255,255,0.1)]"
                        >
                            INITIALIZE SYSTEM
                        </button>
                    </div>
                </div>
            );

            // LAYER 2: CONFIG
            if (view === 'CONFIG') return (
                <div className="h-screen w-full flex items-center justify-center p-6 relative">
                     <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_top,_var(--tw-gradient-stops))] from-indigo-900/20 via-[#020617] to-[#020617] -z-10"></div>
                    
                    <div className="glass-panel w-full max-w-6xl h-[85vh] rounded-3xl flex flex-col overflow-hidden fade-in">
                        {/* Header Bar */}
                        <div className="h-20 border-b border-white/5 flex items-center justify-between px-8 bg-white/5">
                            <h2 className="text-2xl font-bold text-slate-200 tracking-tight">SESSION <span className="text-blue-400">CONFIGURATION</span></h2>
                            <div className="flex items-center gap-3 bg-black/30 px-4 py-2 rounded-full border border-white/10">
                                <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span className="font-mono text-sm text-slate-300 uppercase">{user}</span>
                            </div>
                        </div>

                        {/* 3 Column Grid */}
                        <div className="flex-1 grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-white/5">
                            
                            {/* COL 1: CORE SETTINGS */}
                            <div className="p-8 space-y-8">
                                <div className="space-y-4">
                                    <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Target Subject</label>
                                    <div className="grid grid-cols-1 gap-3">
                                        {Object.keys(CURRICULUM).map(s => (
                                            <button 
                                                key={s} 
                                                onClick={() => setConfig({...config, subject: s, selectedTopics: []})}
                                                className={`p-4 text-left rounded-xl border transition-all ${config.subject === s ? 'bg-blue-600/20 border-blue-500 text-blue-100' : 'bg-white/5 border-transparent text-slate-400 hover:bg-white/10'}`}
                                            >
                                                <div className="font-bold">{s}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Difficulty Level</label>
                                    <div className="flex gap-4">
                                        {['Year 11', 'Year 12'].map(l => (
                                            <button 
                                                key={l}
                                                onClick={() => setConfig({...config, level: l})} 
                                                className={`flex-1 py-3 rounded-lg border text-sm font-semibold transition-all ${config.level === l ? 'bg-emerald-500/20 border-emerald-500 text-emerald-100' : 'bg-white/5 border-transparent text-slate-400'}`}
                                            >
                                                {l}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <div className="flex justify-between">
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Question Volume</label>
                                        <span className="font-mono text-cyan-400">{config.qCount}</span>
                                    </div>
                                    <input type="range" min="1" max="10" value={config.qCount} onChange={(e)=>setConfig({...config, qCount: parseInt(e.target.value)})} className="w-full" />
                                </div>
                            </div>

                            {/* COL 2: FOCUS & TOPICS */}
                            <div className="p-8 flex flex-col h-full overflow-hidden">
                                <label className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-6">Study Mode</label>
                                <div className="bg-black/40 p-1 rounded-lg flex mb-6">
                                    {['Comprehensive', 'Targeted'].map(m => (
                                        <button 
                                            key={m}
                                            onClick={() => setConfig({...config, mode: m})}
                                            className={`flex-1 py-2 rounded text-sm font-medium transition-all ${config.mode === m ? 'bg-slate-700 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}
                                        >
                                            {m}
                                        </button>
                                    ))}
                                </div>

                                <div className="flex-1 overflow-y-auto custom-scroll pr-2 relative">
                                    {config.mode === 'Comprehensive' ? (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-500 text-center opacity-60">
                                            <i className="fa-solid fa-layer-group text-4xl mb-4"></i>
                                            <p>Full Curriculum<br/>Enabled</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {CURRICULUM[config.subject][config.level].map(t => (
                                                <div 
                                                    key={t}
                                                    onClick={() => toggleTopic(t)} 
                                                    className={`p-3 rounded-lg border cursor-pointer flex items-center justify-between text-sm transition-all ${config.selectedTopics.includes(t) ? 'bg-blue-900/40 border-blue-500/50 text-blue-100' : 'bg-white/5 border-transparent text-slate-400'}`}
                                                >
                                                    {t}
                                                    {config.selectedTopics.includes(t) && <i className="fa-solid fa-check text-blue-400"></i>}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* COL 3: CUSTOMIZATION */}
                            <div className="p-8 space-y-6">
                                <div className="space-y-3">
                                    <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Prompt Engineering</label>
                                    <textarea 
                                        className="w-full h-32 glass-input rounded-xl p-4 text-sm resize-none"
                                        placeholder="E.g., 'Focus on complex numbers', 'Make it extremely hard'..."
                                        value={config.extraInstructions}
                                        onChange={(e) => setConfig({...config, extraInstructions: e.target.value})}
                                    ></textarea>
                                </div>
                                
                                <div className="space-y-3">
                                    <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Materials</label>
                                    <div className="border-2 border-dashed border-white/10 rounded-xl p-6 text-center text-slate-500 hover:border-slate-500 transition-colors cursor-pointer group">
                                        <i className="fa-solid fa-file-pdf text-2xl mb-2 group-hover:text-red-400 transition-colors"></i>
                                        <p className="text-xs">Drop PDF files to context</p>
                                    </div>
                                </div>

                                <div className="space-y-3 pt-4 border-t border-white/5">
                                    <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">API Override</label>
                                    <input 
                                        type="password" 
                                        placeholder="Paste Gemini API Key (Optional)" 
                                        className="w-full glass-input p-3 rounded-lg text-xs font-mono"
                                        value={config.apiKeyOverride}
                                        onChange={(e) => setConfig({...config, apiKeyOverride: e.target.value})}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Footer Action */}
                        <button 
                            onClick={startSession}
                            className="w-full h-16 bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-lg tracking-widest transition-all uppercase flex items-center justify-center gap-3"
                        >
                            <span>Start Session</span>
                            <i className="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            );

            // LAYER 3: THE ARENA
            if (view === 'ARENA') {
                const currentQ = questions[currentQIndex];
                
                return (
                    <div className="h-screen w-full flex bg-[#020617] overflow-hidden">
                        
                        {/* 1. LEFT SIDEBAR */}
                        <div className="w-20 border-r border-white/5 bg-[#050b20] flex flex-col items-center py-6 gap-6 z-20">
                            {/* Status Dot */}
                            <div className="flex flex-col items-center gap-1">
                                <div className={`w-3 h-3 rounded-full ${loading ? 'bg-amber-400 animate-pulse' : 'bg-emerald-500 shadow-[0_0_10px_#10b981]'}`}></div>
                                <span className="text-[9px] font-bold text-slate-500 tracking-widest">{loading ? 'SYNC' : 'LIVE'}</span>
                            </div>

                            <div className="w-8 h-px bg-white/10"></div>

                            {/* Question Bubbles */}
                            <div className="flex-1 flex flex-col gap-4 overflow-y-auto custom-scroll w-full items-center py-2">
                                {questions.map((q, i) => (
                                    <button 
                                        key={i} 
                                        onClick={() => setCurrentQIndex(i)}
                                        className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm transition-all relative
                                            ${currentQIndex === i ? 'ring-2 ring-blue-400 scale-110' : ''}
                                            ${q.status === 'correct' ? 'bg-emerald-900/50 text-emerald-400 border border-emerald-500/50' : 
                                              q.status === 'wrong' ? 'bg-red-900/50 text-red-400 border border-red-500/50' : 
                                              'bg-slate-800 text-slate-400 border border-white/5 hover:bg-slate-700'}`}
                                    >
                                        {i+1}
                                        {q.status === 'pending' && <div className="absolute inset-0 rounded-full border-2 border-t-transparent border-slate-500 animate-spin opacity-50"></div>}
                                    </button>
                                ))}
                            </div>
                            
                            <button onClick={()=>setView('DEBRIEF')} className="text-red-400 hover:text-red-300 text-xl"><i className="fa-solid fa-power-off"></i></button>
                        </div>

                        {/* 2. CENTER CANVAS & OVERLAYS */}
                        <div className="flex-1 relative bg-slate-900/20">
                            
                            <Whiteboard 
                                tool={wbTool} color={wbColor} triggerClear={clearTrig} 
                                onDraw={(cvs) => canvasRef.current = cvs} 
                            />

                            {/* OVERLAY 1: Floating Toolbar */}
                            <div className="absolute top-4 left-1/2 -translate-x-1/2 glass-pill px-6 py-3 rounded-full flex items-center gap-6 z-30">
                                <button onClick={()=>setWbTool('pen')} className={`transition ${wbTool==='pen'?'text-blue-400 scale-110':'text-slate-400'}`}><i className="fa-solid fa-pen"></i></button>
                                <button onClick={()=>setWbTool('eraser')} className={`transition ${wbTool==='eraser'?'text-pink-400 scale-110':'text-slate-400'}`}><i className="fa-solid fa-eraser"></i></button>
                                <input type="color" value={wbColor} onChange={e=>setWbColor(e.target.value)} className="w-6 h-6 rounded-full bg-transparent border-none cursor-pointer" />
                                <div className="w-px h-6 bg-white/10"></div>
                                <button onClick={()=>setClearTrig(t=>t+1)} className="text-red-400 hover:text-red-300 text-xs font-bold uppercase">Clear</button>
                                <div className="w-px h-6 bg-white/10"></div>
                                <span className="font-mono text-white text-sm">⏱ {Math.floor(timer/60).toString().padStart(2,'0')}:{Math.floor(timer%60).toString().padStart(2,'0')}</span>
                            </div>

                            {/* OVERLAY 2: Question Card */}
                            <div className={`absolute top-20 left-6 z-30 transition-all duration-500 ${qCardOpen ? 'w-96' : 'w-12 overflow-hidden'}`}>
                                <div className="glass-panel rounded-2xl overflow-hidden border-l-4 border-blue-500">
                                    <div className="p-3 bg-white/5 flex justify-between items-center cursor-pointer" onClick={()=>setQCardOpen(!qCardOpen)}>
                                        <span className="text-xs font-bold text-blue-400 uppercase tracking-widest">{currentQ.topic} • {currentQ.marks} Marks</span>
                                        <i className={`fa-solid fa-chevron-${qCardOpen?'up':'down'} text-xs text-slate-500`}></i>
                                    </div>
                                    {qCardOpen && (
                                        <div className="p-5 text-slate-200">
                                            {currentQ.status === 'pending' ? (
                                                <div className="flex items-center gap-3 text-slate-500"><i className="fa-solid fa-circle-notch animate-spin"></i> Generating Question...</div>
                                            ) : (
                                                <Latex text={currentQ.text} />
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* 3. INTERACTION AREA */}
                            <div className="absolute bottom-10 left-1/2 -translate-x-1/2 w-full max-w-2xl px-4 z-40">
                                {/* Math Keyboard */}
                                <div className={`transition-all duration-300 overflow-hidden ${mathKbOpen ? 'h-16 opacity-100 mb-2' : 'h-0 opacity-0 mb-0'}`}>
                                    <div className="glass-panel p-2 rounded-xl flex justify-center gap-2">
                                        {MATH_SYMBOLS.map(sym => (
                                            <button 
                                                key={sym.label} 
                                                onClick={() => setInputVal(prev => prev + sym.val)}
                                                className="h-10 w-12 rounded bg-white/5 hover:bg-white/10 text-white font-serif"
                                            >
                                                <Latex text={`$${sym.label}$`} />
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Input Cluster */}
                                <div className="glass-pill p-2 rounded-2xl flex gap-2">
                                    <button onClick={handleGiveUp} className="bg-red-900/40 hover:bg-red-900/60 text-red-200 px-6 rounded-xl font-bold text-xs uppercase tracking-wider transition">Give Up</button>
                                    
                                    <div className="flex-1 relative">
                                        <input 
                                            value={inputVal}
                                            onChange={(e) => setInputVal(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && submitAnswer()}
                                            placeholder="Type answer here..." 
                                            className="w-full h-12 bg-black/40 rounded-xl px-4 pr-12 text-white focus:ring-1 focus:ring-blue-500 outline-none"
                                        />
                                        <button 
                                            onClick={() => setMathKbOpen(!mathKbOpen)}
                                            className={`absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white transition ${mathKbOpen ? 'text-blue-400' : ''}`}
                                        >
                                            <i className="fa-solid fa-keyboard"></i>
                                        </button>
                                    </div>

                                    <button 
                                        onClick={submitAnswer} 
                                        disabled={loading || currentQ.status === 'pending'}
                                        className="bg-blue-600 hover:bg-blue-500 text-white px-8 rounded-xl font-bold text-sm shadow-[0_0_15px_rgba(37,99,235,0.4)] disabled:opacity-50 disabled:shadow-none transition-all"
                                    >
                                        {loading ? <i className="fa-solid fa-circle-notch animate-spin"></i> : 'SUBMIT'}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* 4. RIGHT DRAWER */}
                        <div className={`fixed inset-y-0 right-0 w-[400px] bg-[#050b20] border-l border-white/10 z-50 transform transition-transform duration-300 ${drawerOpen ? 'translate-x-0 shadow-2xl' : 'translate-x-[90%]'}`}>
                            {/* Toggle Handle (Visible when closed) */}
                            <button 
                                onClick={() => setDrawerOpen(!drawerOpen)}
                                className="absolute top-1/2 -left-8 w-8 h-16 bg-[#050b20] border-l border-y border-white/10 rounded-l-xl flex items-center justify-center text-slate-400 hover:text-white"
                            >
                                <i className={`fa-solid fa-chevron-${drawerOpen?'right':'left'}`}></i>
                            </button>

                            <div className="h-full flex flex-col">
                                {/* Drawer Tabs */}
                                <div className="flex border-b border-white/10">
                                    <button 
                                        onClick={() => setDrawerMode('CHAT')} 
                                        className={`flex-1 py-4 text-xs font-bold uppercase tracking-widest ${drawerMode==='CHAT' ? 'text-blue-400 bg-blue-900/10' : 'text-slate-500 hover:text-slate-300'}`}
                                    >AI Tutor</button>
                                    <button 
                                        onClick={() => setDrawerMode('RESULT')} 
                                        className={`flex-1 py-4 text-xs font-bold uppercase tracking-widest ${drawerMode==='RESULT' ? 'text-emerald-400 bg-emerald-900/10' : 'text-slate-500 hover:text-slate-300'}`}
                                    >Results</button>
                                </div>

                                <div className="flex-1 overflow-y-auto custom-scroll p-6">
                                    {drawerMode === 'CHAT' ? (
                                        <div className="space-y-4">
                                            {messages.length === 0 && <div className="text-center text-slate-600 mt-10 text-sm">Ask me for a hint...</div>}
                                            {messages.map((m, i) => (
                                                <div key={i} className={`p-3 rounded-lg text-sm border ${m.role==='user' ? 'bg-blue-900/20 border-blue-500/30 text-blue-100 ml-4' : 'bg-slate-800 border-white/5 text-slate-300 mr-4'}`}>
                                                    <Latex text={m.text} />
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="space-y-6 animate-fade-in">
                                            {feedback ? (
                                                <>
                                                    <div className="text-center">
                                                        <div className={`text-6xl font-bold mb-2 ${feedback.correct ? 'text-emerald-400' : 'text-red-400'}`}>{feedback.mark}</div>
                                                        <div className="text-xs text-slate-500 uppercase tracking-widest">Points Awarded</div>
                                                    </div>
                                                    <div className="bg-emerald-900/20 border border-emerald-500/30 p-4 rounded-xl">
                                                        <div className="text-xs font-bold text-emerald-400 uppercase mb-2"><i className="fa-solid fa-thumbs-up mr-2"></i>Positives</div>
                                                        <p className="text-sm text-emerald-100/80 leading-relaxed"><Latex text={feedback.positives} /></p>
                                                    </div>
                                                    <div className="bg-red-900/20 border border-red-500/30 p-4 rounded-xl">
                                                        <div className="text-xs font-bold text-red-400 uppercase mb-2"><i className="fa-solid fa- wrench mr-2"></i>Improvements</div>
                                                        <p className="text-sm text-red-100/80 leading-relaxed"><Latex text={feedback.improvements} /></p>
                                                    </div>
                                                </>
                                            ) : (
                                                <div className="text-center text-slate-500 mt-10">Submit an answer to see results.</div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {drawerMode === 'CHAT' && (
                                    <div className="p-4 border-t border-white/10 bg-black/20">
                                        <div className="flex gap-2">
                                            <input 
                                                value={inputVal} 
                                                onChange={e=>setInputVal(e.target.value)} 
                                                onKeyDown={e=>e.key==='Enter' && sendChat()}
                                                className="flex-1 glass-input rounded-lg px-3 py-2 text-sm" 
                                                placeholder="Ask..." 
                                            />
                                            <button onClick={sendChat} className="bg-blue-600 text-white w-10 rounded-lg"><i className="fa-solid fa-paper-plane"></i></button>
                                        </div>
                                        <button 
                                            onClick={() => {
                                                const img = canvasRef.current.toDataURL();
                                                AI_ENGINE.call(`Check this image of working out for Q: ${currentQ.text}. Give a small hint.`, img).then(res => setMessages(p=>[...p, {role:'ai', text:res}]));
                                            }}
                                            className="w-full mt-2 text-xs text-blue-400 hover:text-blue-300 py-2 border border-blue-500/30 rounded hover:bg-blue-500/10 transition"
                                        >
                                            <i className="fa-solid fa-eye mr-2"></i> Check My Working
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>

                    </div>
                );
            }

            // LAYER 4: DEBRIEF
            if (view === 'DEBRIEF') {
                const totalScore = questions.reduce((acc, q) => acc + (q.score || 0), 0);
                const maxScore = questions.reduce((acc, q) => acc + q.marks, 0);
                const percent = Math.round((totalScore/maxScore)*100) || 0;

                const downloadPDF = () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFontSize(20); doc.text(`ATAR Helper Report - ${user}`, 20, 20);
                    doc.setFontSize(12); doc.text(`Subject: ${config.subject} | Score: ${percent}%`, 20, 30);
                    let y = 40;
                    questions.forEach((q, i) => {
                        doc.text(`Q${i+1}: ${q.status.toUpperCase()} (${q.score||0}/${q.marks})`, 20, y);
                        y += 10;
                        if(y > 280) { doc.addPage(); y = 20; }
                    });
                    doc.save('ATAR_Report.pdf');
                };

                return (
                    <div className="h-screen w-full flex items-center justify-center p-4 relative">
                        <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_bottom,_var(--tw-gradient-stops))] from-emerald-900/20 via-[#020617] to-[#020617] -z-10"></div>
                        
                        <div className="glass-panel w-full max-w-lg p-10 rounded-3xl text-center fade-in border border-white/10">
                            <h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Session Concluded</h2>
                            
                            <div className="relative inline-block mb-8">
                                <svg className="w-48 h-48 transform -rotate-90">
                                    <circle cx="96" cy="96" r="88" stroke="rgba(255,255,255,0.1)" strokeWidth="12" fill="transparent" />
                                    <circle cx="96" cy="96" r="88" stroke="#34d399" strokeWidth="12" fill="transparent" strokeDasharray={552} strokeDashoffset={552 - (552 * percent) / 100} className="transition-all duration-1000 ease-out" />
                                </svg>
                                <div className="absolute inset-0 flex flex-col items-center justify-center">
                                    <span className="text-5xl font-bold text-white">{percent}%</span>
                                    <span className="text-sm text-slate-400 mt-1">{totalScore}/{maxScore} PTS</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 mb-8">
                                <div className="bg-white/5 p-4 rounded-xl">
                                    <div className="text-xs text-slate-400 uppercase">Time</div>
                                    <div className="text-xl font-mono text-white">{Math.floor(timer/60)}m {timer%60}s</div>
                                </div>
                                <div className="bg-white/5 p-4 rounded-xl">
                                    <div className="text-xs text-slate-400 uppercase">Completed</div>
                                    <div className="text-xl font-mono text-white">{questions.filter(q=>q.status!=='pending').length}/{config.qCount}</div>
                                </div>
                            </div>

                            <div className="flex gap-4">
                                <button onClick={downloadPDF} className="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-xl font-bold text-sm transition"><i className="fa-solid fa-file-pdf mr-2"></i> DOWNLOAD PDF</button>
                                <button onClick={() => window.location.reload()} className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold text-sm transition">NEW TEST</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
