<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ATAR Helper</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- PDF.js for Database Reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&family=Caveat:wght@700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 100%);
            color: #e2e8f0;
            overflow: hidden;
            touch-action: none;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(15, 23, 42, 0.25);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(34, 211, 238, 0.6);
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.2);
            outline: none;
        }

        .premium-btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }
        .premium-btn:hover:not(:disabled) {
            background: rgba(34, 211, 238, 0.15);
            border-color: rgba(34, 211, 238, 0.6);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 0 25px rgba(34, 211, 238, 0.3);
            text-shadow: 0 0 8px rgba(34, 211, 238, 0.8);
        }
        .premium-btn:active:not(:disabled) { transform: scale(0.98); }
        .premium-btn:disabled { opacity: 0.5; cursor: wait; }

        /* Loaders & Spinners */
        .loader-ring { display: inline-block; position: relative; width: 64px; height: 64px; }
        .loader-ring div { box-sizing: border-box; display: block; position: absolute; width: 50px; height: 50px; margin: 8px; border: 4px solid #22d3ee; border-radius: 50%; animation: loader-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-color: #22d3ee transparent transparent transparent; }
        .loader-ring div:nth-child(1) { animation-delay: -0.45s; }
        .loader-ring div:nth-child(2) { animation-delay: -0.3s; }
        .loader-ring div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes loader-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @keyframes spin-border { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin-border { position: relative; z-index: 0; }
        .spin-border::before { content: ''; position: absolute; inset: -2px; border-radius: 50%; padding: 2px; background: conic-gradient(from 0deg, transparent, #22d3ee, transparent); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: spin-border 1.5s linear infinite; z-index: -1; }

        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scroll & Range */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #22d3ee; margin-top: -6px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, memo, useCallback } = React;

        // --- GLOBAL CONTEXT STORE (For PDFs) ---
        let SUBJECT_CONTEXT = ""; 

        // --- CURRICULUM DATA ---
        const CURRICULUM = {
            "Methods": { "Year 11": { "Unit 1": ["Functions", "Trig", "Prob"], "Unit 2": ["Calculus", "Exp/Log", "Series"] }, "Year 12": { "Unit 3": ["Calculus II", "Integrals", "Random Var"], "Unit 4": ["Logarithms", "Continuous Var", "Stats"] } },
            "Spec": { "Year 11": { "Unit 1": ["Combinatorics", "Vectors", "Geometry"], "Unit 2": ["Trig", "Matrices", "Complex"] }, "Year 12": { "Unit 3": ["Complex II", "Sketching", "Vectors 3D"], "Unit 4": ["Integration II", "Diff Eq", "Stats"] } },
            "Physics": { "Year 11": { "Unit 1": ["Heat", "Nuclear", "Circuits"], "Unit 2": ["Motion", "Waves", "Dynamics"] }, "Year 12": { "Unit 3": ["Gravity", "Electromagnetism"], "Unit 4": ["Revolutions", "Quantum"] } },
            "Chem": { "Year 11": { "Unit 1": ["Atomic", "Bonding", "Organic"], "Unit 2": ["Forces", "Solutions", "Gases"] }, "Year 12": { "Unit 3": ["Equilibrium", "Acids", "Redox"], "Unit 4": ["Organic II", "Polymers", "Synthesis"] } }
        };

        // --- AI ENGINE ---
        const AI_ENGINE = {
            // Check if DB exists by probing 1.pdf
            checkDatabase: async (subject, level) => {
                try {
                    const res = await fetch(`data/${subject}/${level}/1.pdf`);
                    return res.ok;
                } catch { return false; }
            },

            loadContext: async (subject, level) => {
                SUBJECT_CONTEXT = "";
                let context = "";
                // Try reading 1.pdf, 2.pdf (Max 2 files to keep generation fast)
                for (let i = 1; i <= 2; i++) {
                    try {
                        const url = `data/${subject}/${level}/${i}.pdf`;
                        const res = await fetch(url);
                        if (!res.ok) break;
                        
                        const blob = await res.blob();
                        const arrayBuffer = await blob.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        
                        // Only read first 2 pages per PDF to save tokens/time
                        for(let p=1; p<=Math.min(pdf.numPages, 2); p++) {
                            const page = await pdf.getPage(p);
                            const textContent = await page.getTextContent();
                            context += textContent.items.map(item => item.str).join(" ") + " ";
                        }
                    } catch (e) { break; }
                }
                // Limit context size
                SUBJECT_CONTEXT = context.substring(0, 1500); 
                console.log("Loaded Context Length:", SUBJECT_CONTEXT.length);
            },

            fetchWithRetry: async (prompt, jsonMode = false) => {
                const seed = Math.floor(Math.random() * 1000000);
                const url = `https://text.pollinations.ai/`;
                const body = `${prompt}\n\n(Seed: ${seed})`;
                
                try {
                    const response = await fetch(`${url}?model=openai${jsonMode ? '&json=true' : ''}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'text/plain'},
                        body: body
                    });
                    if (!response.ok) throw new Error("HTTP Error");
                    return await response.text();
                } catch (e) {
                    try {
                        const response2 = await fetch(`${url}?model=mistral${jsonMode ? '&json=true' : ''}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'text/plain'},
                            body: body
                        });
                        if (!response2.ok) throw new Error("Backup Failed");
                        return await response2.text();
                    } catch(e2) { throw new Error("AI Offline"); }
                }
            },

            generateQuestion: async (subject, level, topics) => {
                const topic = topics.length > 0 ? topics[Math.floor(Math.random() * topics.length)] : subject;
                const contextStr = SUBJECT_CONTEXT ? `Reference Material (Use this style but create NEW question): ${SUBJECT_CONTEXT}` : "";
                
                const prompt = `Create a WACE ATAR exam question for ${subject} ${level} - ${topic}.
                ${contextStr}
                INSTRUCTIONS:
                1. Return raw JSON: {"text":"Question...","topic":"${topic}","answer":"Short Answer","hint":"Hint"}.
                2. Use LaTeX for math like $x^2$.
                3. NO words like 'space', 'blank', 'page'.
                4. NO sub-questions (a,b,c). One single question only.`;
                
                try {
                    const text = await AI_ENGINE.fetchWithRetry(prompt, true);
                    const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const start = cleanText.indexOf('{');
                    const end = cleanText.lastIndexOf('}');
                    if (start === -1 || end === -1) throw new Error("JSON Error");
                    return JSON.parse(cleanText.substring(start, end+1));
                } catch (e) {
                    return {
                        text: "Error generating. Please check internet. (Fallback: Evaluate $\\int 2x dx$)",
                        topic: "System",
                        answer: "x^2 + C",
                        hint: "Power rule."
                    };
                }
            },

            checkAnswer: async (user, actual, questionText) => {
                try {
                    const prompt = `Q: ${questionText}\nReal Ans: ${actual}\nStudent Ans: ${user}\nIs correct? Return JSON: {"correct": true/false, "feedback": "Brief LaTeX feedback"}`;
                    const text = await AI_ENGINE.fetchWithRetry(prompt, true);
                    const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const start = cleanText.indexOf('{');
                    const end = cleanText.lastIndexOf('}');
                    return JSON.parse(cleanText.substring(start, end+1));
                } catch(e) {
                    const isMatch = user.replace(/\s/g,'') === actual.replace(/\s/g,'');
                    return { correct: isMatch, feedback: isMatch ? "Exact match found." : "Connection failed, tried exact match." };
                }
            },

            ask: async (prompt, systemContext) => {
                try {
                    return await AI_ENGINE.fetchWithRetry(`System: ${systemContext}. User: ${prompt}. Reply concisely with LaTeX.`, false);
                } catch(e) { return "Connection failed."; }
            }
        };

        // --- MATH RENDERER ---
        const MathText = ({ text }) => {
            if (!text) return null;
            let cleanText = text
                .replace(/Leave space for working/gi, '')
                .replace(/(?<!\\)\bspace\b/gi, ' ')
                .replace(/\\n/g, '\n'); 

            const parts = cleanText.split(/(\$[^$]+\$)/g);
            return (
                <div className="leading-relaxed tracking-normal font-sans whitespace-pre-wrap text-lg">
                    {parts.map((part, index) => {
                        if (part.startsWith('$') && part.endsWith('$')) {
                            const mathContent = part.slice(1, -1);
                            return (
                                <span key={index} className="mx-1 inline-block text-cyan-200 align-middle"
                                    dangerouslySetInnerHTML={{ __html: katex.renderToString(mathContent, { throwOnError: false, displayMode: false }) }} 
                                />
                            );
                        }
                        return <span key={index}>{part}</span>;
                    })}
                </div>
            );
        };

        // --- VISUALS ---
        const EasterEggBackground = memo(() => {
            const [items, setItems] = useState([]);
            useEffect(() => {
                setItems(Array.from({ length: 15 }, (_, i) => ({
                    id: i, char: ["∫", "∑", "π", "e", "θ"][i%5],
                    x: Math.random() * 90, y: Math.random() * 90,
                    vx: (Math.random()-0.5)*0.2, vy: (Math.random()-0.5)*0.2
                })));
            }, []);
            useEffect(() => {
                const interval = setInterval(() => {
                    setItems(prev => prev.map(p => ({
                        ...p, x: p.x+p.vx, y: p.y+p.vy, 
                        vx: (p.x<0||p.x>95)?-p.vx:p.vx, vy: (p.y<0||p.y>95)?-p.vy:p.vy
                    })));
                }, 50);
                return () => clearInterval(interval);
            }, []);
            return (
                <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">
                    {items.map(item => (
                        <div key={item.id} className="absolute text-slate-700 text-4xl opacity-20 transition-transform duration-1000"
                             style={{left: `${item.x}%`, top: `${item.y}%`}}>
                            {item.char}
                        </div>
                    ))}
                </div>
            );
        });

        const Whiteboard = memo(({ tool, color, size, triggerClear, teacherMarks, hasDrawnRef }) => {
            const canvasRef = useRef(null);
            const contextRef = useRef(null);
            
            useEffect(() => {
                const canvas = canvasRef.current;
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
                const ctx = canvas.getContext('2d');
                ctx.scale(dpr, dpr); ctx.lineCap = "round"; ctx.lineJoin = "round";
                contextRef.current = ctx;
            }, []);

            useEffect(() => {
                if (triggerClear > 0) {
                    const ctx = contextRef.current;
                    ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
                    if(hasDrawnRef) hasDrawnRef.current = false;
                }
            }, [triggerClear]);

            useEffect(() => {
                if (teacherMarks?.length) {
                    const ctx = contextRef.current;
                    ctx.save(); ctx.strokeStyle = '#ef4444'; ctx.fillStyle = '#ef4444'; ctx.lineWidth = 3; ctx.font = "bold 24px sans-serif";
                    teacherMarks.forEach((mark, i) => {
                        setTimeout(() => {
                            if (mark.type === 'tick') {
                                ctx.beginPath(); ctx.moveTo(mark.x, mark.y); ctx.lineTo(mark.x + 10, mark.y + 20); ctx.lineTo(mark.x + 40, mark.y - 40); ctx.stroke();
                            } else if (mark.type === 'cross') {
                                ctx.beginPath(); ctx.moveTo(mark.x, mark.y); ctx.lineTo(mark.x + 30, mark.y + 30); ctx.moveTo(mark.x + 30, mark.y); ctx.lineTo(mark.x, mark.y + 30); ctx.stroke();
                            }
                        }, i * 300);
                    });
                    ctx.restore();
                }
            }, [teacherMarks]);

            const startDrawing = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                contextRef.current.beginPath(); contextRef.current.moveTo(x,y);
                if(hasDrawnRef) hasDrawnRef.current = true;
                
                const moveHandler = (ev) => {
                    const mx = (ev.touches ? ev.touches[0].clientX : ev.clientX) - rect.left;
                    const my = (ev.touches ? ev.touches[0].clientY : ev.clientY) - rect.top;
                    const ctx = contextRef.current;
                    if (tool === 'eraser') { ctx.globalCompositeOperation = 'destination-out'; ctx.lineWidth = size * 5; } 
                    else { ctx.globalCompositeOperation = 'source-over'; ctx.lineWidth = size; ctx.strokeStyle = color; }
                    ctx.lineTo(mx, my); ctx.stroke();
                };
                
                const upHandler = () => {
                    window.removeEventListener(e.touches ? 'touchmove' : 'mousemove', moveHandler);
                    window.removeEventListener(e.touches ? 'touchend' : 'mouseup', upHandler);
                };
                window.addEventListener(e.touches ? 'touchmove' : 'mousemove', moveHandler);
                window.addEventListener(e.touches ? 'touchend' : 'mouseup', upHandler);
            };

            return <canvas ref={canvasRef} onMouseDown={startDrawing} onTouchStart={startDrawing} className="w-full h-full cursor-crosshair touch-none" style={{ background: 'transparent' }} />;
        });

        const Modal = ({ isOpen, message, onConfirm, onCancel, confirmText="Yes" }) => {
            if (!isOpen) return null;
            return (
                <div className="absolute inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="glass-panel p-6 rounded-2xl max-w-sm w-full text-center border border-red-500/30">
                        <div className="text-xl font-bold mb-4 text-white">Notice</div>
                        <p className="text-slate-300 mb-6">{message}</p>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white transition">Cancel</button>
                            <button onClick={onConfirm} className="flex-1 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-white transition">{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportCard = ({ questions, timer, user, subject, level, onClose }) => {
            const correct = questions.filter(q => q.status === 'correct').length;
            const score = Math.round((correct / questions.length) * 100);
            const wrongTopics = questions.filter(q => q.status === 'wrong').map(q => q.topic);
            const uniqueWeaknesses = [...new Set(wrongTopics)];

            const downloadReport = () => {
                const text = `ATAR HELPER REPORT\n------------------\nName: ${user}\nSubject: ${subject} ${level}\nDate: ${new Date().toLocaleDateString()}\n\nRESULTS:\nScore: ${score}%\nTime: ${Math.floor(timer/60)}m ${timer%60}s\n\nQUESTION BREAKDOWN:\n${questions.map((q,i) => `Q${i+1} [${q.topic}]: ${q.status.toUpperCase()}`).join('\n')}\n\nAREAS TO IMPROVE:\n${uniqueWeaknesses.length ? uniqueWeaknesses.join(', ') : 'None identified. Excellent work!'}`;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Report_${user}.txt`;
                a.click();
            };
            
            return (
                <div className="absolute inset-0 bg-black/90 backdrop-blur-md z-50 flex flex-col items-center justify-center p-4 animate-fade-in">
                    <div className="glass-panel p-8 rounded-3xl max-w-2xl w-full border border-white/10">
                        <h2 className="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">Performance Report</h2>
                        
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="bg-white/5 p-4 rounded-xl text-center">
                                <div className="text-sm text-slate-400 uppercase tracking-wider">Score</div>
                                <div className="text-4xl font-bold text-white">{score}%</div>
                            </div>
                            <div className="bg-white/5 p-4 rounded-xl text-center">
                                <div className="text-sm text-slate-400 uppercase tracking-wider">Time</div>
                                <div className="text-4xl font-bold text-white">{Math.floor(timer/60)}m {timer%60}s</div>
                            </div>
                        </div>

                        <div className="mb-6 p-4 bg-white/5 rounded-xl">
                            <div className="text-sm text-slate-400 uppercase tracking-wider mb-2">Tutor Summary</div>
                            <p className="text-sm text-slate-300 italic">
                                {score > 80 ? `Outstanding work, ${user}! You have demonstrated mastery.` : 
                                 score > 50 ? `Good effort, ${user}. Review ${uniqueWeaknesses[0] || 'your errors'} to improve.` : 
                                 `Keep practicing, ${user}. Focus on understanding the core concepts.`}
                            </p>
                        </div>

                        <div className="flex gap-4">
                            <button onClick={downloadReport} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl transition">Download Report</button>
                            <button onClick={onClose} className="flex-1 bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:scale-[1.02] transition">Return to Menu</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('menu');
            const [user, setUser] = useState('');
            const [subject, setSubject] = useState('Methods');
            const [level, setLevel] = useState('Year 12');
            const [dbStatus, setDbStatus] = useState(false); // Database connected?
            
            // Setup
            const [selectedUnit, setSelectedUnit] = useState('Whole Year');
            const [availableTopics, setAvailableTopics] = useState([]);
            const [selectedTopics, setSelectedTopics] = useState([]);
            const [questionCount, setQuestionCount] = useState(5);
            
            // Test
            const [questions, setQuestions] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [messages, setMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [isProcessing, setIsProcessing] = useState(false); 
            
            // Tools
            const [wbTool, setWbTool] = useState('pen');
            const [wbColor, setWbColor] = useState('#a5f3fc');
            const [wbSize, setWbSize] = useState(2);
            const [clearBoardTrig, setClearBoardTrig] = useState(0);
            const [teacherMarks, setTeacherMarks] = useState([]);
            const hasDrawn = useRef(false);
            const genPaused = useRef(false);
            
            // Timers
            const [isLoadingInitial, setIsLoadingInitial] = useState(false);
            const [loadingTime, setLoadingTime] = useState(0);
            const [timer, setTimer] = useState(0);
            const [modalConfig, setModalConfig] = useState(null);
            const [userTypedAns, setUserTypedAns] = useState('');

            // Init & DB Check
            useEffect(() => {
                // Check if 1.pdf exists for the default subject
                AI_ENGINE.checkDatabase('Methods', 'Year 12').then(s => setDbStatus(s));
            }, []);

            // Update Topics
            useEffect(() => {
                const yearData = CURRICULUM[subject]?.[level];
                if (yearData) {
                    let topics = [];
                    if (selectedUnit === 'Whole Year') Object.values(yearData).forEach(u => topics.push(...u));
                    else topics = yearData[selectedUnit] || [];
                    setAvailableTopics(topics);
                    setSelectedTopics(topics);
                }
                // Check DB for this specific subject
                AI_ENGINE.checkDatabase(subject, level).then(s => {
                    setDbStatus(s);
                    if(s) AI_ENGINE.loadContext(subject, level);
                });
            }, [subject, level, selectedUnit]);

            // Timer Logic
            useEffect(() => {
                let interval;
                const currentQ = questions[currentQIndex];
                if (view === 'test' && currentQ?.status !== 'generating') {
                    interval = setInterval(() => setTimer(t => t + 1), 1000);
                }
                return () => clearInterval(interval);
            }, [view, questions, currentQIndex]);

            useEffect(() => {
                let interval;
                if (isLoadingInitial) interval = setInterval(() => setLoadingTime(t => t + 0.1), 100);
                else setLoadingTime(0);
                return () => clearInterval(interval);
            }, [isLoadingInitial]);

            const backgroundGenerator = async (count, topics) => {
                const q1 = await AI_ENGINE.generateQuestion(subject, level, topics);
                setQuestions(prev => {
                    const n = [...prev]; n[0] = { ...q1, status: 'ready' }; return n;
                });
                setIsLoadingInitial(false);
                setView('test');

                for (let i = 1; i < count; i++) {
                    await new Promise(r => setTimeout(r, 2000));
                    while(genPaused.current) await new Promise(r => setTimeout(r, 1000));
                    
                    const q = await AI_ENGINE.generateQuestion(subject, level, topics);
                    setQuestions(prev => {
                        const n = [...prev]; 
                        if(n[i]) n[i] = { ...q, status: 'ready' }; 
                        return n;
                    });
                }
            };

            const startTest = async () => {
                setIsLoadingInitial(true);
                setQuestions(Array(questionCount).fill({ status: 'generating', text: 'Loading...', topic: 'Loading', answer: '', hint: '' }));
                setMessages([{role: 'system', text: `Hi ${user}, good luck! Use the board.`}]);
                setTeacherMarks([]); setClearBoardTrig(p => p+1); hasDrawn.current = false;
                setTimer(0); setCurrentQIndex(0); setUserTypedAns('');
                await backgroundGenerator(questionCount, selectedTopics);
            };

            const handleEvaluate = async () => {
                if (isProcessing) return;
                setIsProcessing(true);
                genPaused.current = true;
                
                const q = questions[currentQIndex];
                setMessages(prev => [...prev, { role: 'ai', text: "Checking working..." }]);
                
                setTimeout(async () => {
                    if (!hasDrawn.current) {
                        const hint = await AI_ENGINE.ask("Board empty. Give first step hint.", `Q: ${q.text}`);
                        setMessages(prev => [...prev, { role: 'ai', text: hint }]);
                    } else {
                        const feedback = await AI_ENGINE.ask("Student has working. Give encouragement.", `Q: ${q.text}`);
                        setMessages(prev => [...prev, { role: 'ai', text: feedback }]);
                    }
                    setIsProcessing(false);
                    genPaused.current = false;
                }, 1000);
            };

            const handleSubmitAnswer = async () => {
                if(!userTypedAns.trim() || isProcessing) return;
                setIsProcessing(true);
                genPaused.current = true;
                
                const q = questions[currentQIndex];
                setMessages(prev => [...prev, { role: 'user', text: `Submitted: ${userTypedAns}` }, { role: 'ai', text: "Verifying..." }]);

                const check = await AI_ENGINE.checkAnswer(userTypedAns, q.answer, q.text);
                
                setMessages(prev => [...prev, { role: 'ai', text: check.feedback }]);
                
                if (check.correct) {
                    setTeacherMarks([{ type: 'tick', x: window.innerWidth*0.4, y: window.innerHeight*0.4 }]);
                    setQuestions(prev => { const n = [...prev]; n[currentQIndex].status = 'correct'; return n; });
                } else {
                    setTeacherMarks([{ type: 'cross', x: window.innerWidth*0.4, y: window.innerHeight*0.4 }]);
                }
                setIsProcessing(false);
                genPaused.current = false;
            };

            const handleGiveUp = () => {
                genPaused.current = true;
                setModalConfig({
                    message: "Give up? Answer will be shown.",
                    confirmText: "Yes",
                    onConfirm: () => {
                        const q = questions[currentQIndex];
                        setMessages(prev => [...prev, { role: 'ai', text: `The answer is ${q.answer}` }]);
                        setQuestions(prev => {
                            const n = [...prev]; n[currentQIndex].status = 'wrong'; return n;
                        });
                        setTeacherMarks([{ type: 'cross', x: window.innerWidth*0.4, y: window.innerHeight*0.4 }]);
                        setModalConfig(null);
                        genPaused.current = false;
                    },
                    onCancel: () => { setModalConfig(null); genPaused.current = false; }
                });
            };

            const handleSendMessage = async () => {
                if (!chatInput.trim() || isProcessing) return;
                setIsProcessing(true);
                genPaused.current = true;
                const txt = chatInput;
                setChatInput('');
                setMessages(prev => [...prev, { role: 'user', text: txt }, { role: 'ai', text: "..." }]);
                
                const q = questions[currentQIndex];
                const res = await AI_ENGINE.ask(txt, `Q: ${q.text}. A: ${q.answer}`);
                
                setMessages(prev => {
                    const n = [...prev]; n.pop(); return [...n, { role: 'ai', text: res }];
                });
                setIsProcessing(false);
                genPaused.current = false;
            };

            const changeQuestion = (idx) => {
                if (questions[idx].status === 'generating' || isProcessing) return;
                setCurrentQIndex(idx);
                setTeacherMarks([]); setClearBoardTrig(p => p+1); hasDrawn.current = false; setUserTypedAns('');
            };

            const allDone = questions.every(q => q.status === 'correct' || q.status === 'wrong');
            const currentQ = questions[currentQIndex] || { status: 'generating' };
            const isQLoading = currentQ.status === 'generating';
            const isGraded = currentQ.status === 'correct' || currentQ.status === 'wrong';

            // --- RENDER ---
            if (view === 'menu') return (
                <div className="h-screen w-screen flex flex-col items-center justify-center p-4 relative">
                    <div className="z-10 w-full max-w-lg glass-panel rounded-3xl p-10 animate-fade-in">
                        <h1 className="text-5xl font-bold bg-gradient-to-br from-cyan-300 via-blue-500 to-purple-600 bg-clip-text text-transparent mb-2 text-center">ATAR Helper</h1>
                        <div className="flex justify-between text-xs opacity-70 mb-8 px-4">
                            <span className="tracking-widest">BY ERIC</span>
                            <span>WILLETTON SHS</span>
                        </div>
                        <input type="text" value={user} onChange={e => setUser(e.target.value)} className="w-full glass-input rounded-xl px-5 py-4 mb-4" placeholder="Enter Name..." />
                        <button onClick={() => user ? setView('setup') : alert("Enter name")} className="w-full premium-btn text-white font-bold py-4 rounded-xl">Start Session</button>
                    </div>
                    {/* Database Notice - Separate from Main Title */}
                    {!dbStatus && (
                        <div className="absolute top-10 left-10 glass-panel p-3 rounded-xl animate-fade-in border border-red-500/20 flex items-center gap-2">
                            <i className="fa-solid fa-database text-red-400"></i>
                            <span className="text-xs text-slate-300">No Database Detected (Using Cloud)</span>
                        </div>
                    )}
                    <div className="absolute bottom-4 text-[10px] text-slate-600 font-light select-none opacity-60">© {new Date().getFullYear()} ATAR Helper. All Rights Reserved.</div>
                </div>
            );

            if (view === 'setup' || view === 'topics') {
                return (
                    <div className="h-screen w-screen flex items-center justify-center p-4 relative">
                        {isLoadingInitial && (
                            <div className="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center text-center">
                                <div className="loader-ring mb-4"><div></div><div></div><div></div><div></div></div>
                                <div className="text-white font-bold text-xl">Generating Test...</div>
                                <div className="text-cyan-400 mt-2 font-mono">{loadingTime.toFixed(1)}s</div>
                                <div className="text-slate-500 text-xs mt-1">Est: {questionCount * 2.5}s total</div>
                            </div>
                        )}
                        <div className="z-10 w-full max-w-2xl glass-panel rounded-3xl p-8 animate-fade-in flex flex-col max-h-[90vh]">
                            {view === 'setup' ? (
                                <>
                                    <h2 className="text-2xl font-bold text-white mb-6">Setup</h2>
                                    <div className="grid grid-cols-2 gap-4 mb-6">
                                        <div className="space-y-2">
                                            {['Methods','Spec','Physics','Chem'].map(s => <button key={s} onClick={() => setSubject(s)} className={`w-full py-3 rounded-xl border ${subject===s?'bg-cyan-500/20 border-cyan-500 text-white':'bg-transparent border-white/10 text-slate-400'}`}>{s}</button>)}
                                        </div>
                                        <div className="space-y-2">
                                            {['Year 11','Year 12'].map(l => <button key={l} onClick={() => setLevel(l)} className={`w-full py-3 rounded-xl border ${level===l?'bg-emerald-500/20 border-emerald-500 text-white':'bg-transparent border-white/10 text-slate-400'}`}>{l}</button>)}
                                        </div>
                                    </div>
                                    <button onClick={() => setView('topics')} className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">Next</button>
                                </>
                            ) : (
                                <>
                                    <h2 className="text-2xl font-bold text-white mb-4">Topics</h2>
                                    <div className="flex gap-2 mb-4">
                                        {(level === 'Year 11' ? ['Unit 1','Unit 2','Whole Year'] : ['Unit 3','Unit 4','Whole Year']).map((u, i) => {
                                            return (
                                                <button key={u} onClick={() => setSelectedUnit(u)} className={`flex-1 py-2 rounded-lg text-sm transition ${selectedUnit===u?'bg-cyan-600 text-white':'bg-white/5 text-slate-400'}`}>
                                                    {u}
                                                </button>
                                            )
                                        })}
                                    </div>
                                    <div className="flex-1 overflow-y-auto mb-4 space-y-2 pr-2 custom-scroll">
                                        {availableTopics.map(topic => (
                                            <div key={topic} onClick={() => selectedTopics.includes(topic) ? setSelectedTopics(p => p.filter(x => x!==topic)) : setSelectedTopics(p => [...p, topic])}
                                                className={`p-3 rounded-lg border cursor-pointer flex justify-between ${selectedTopics.includes(topic)?'bg-cyan-500/20 border-cyan-500 text-white':'border-white/10 text-slate-500'}`}>
                                                {topic} {selectedTopics.includes(topic) && <i className="fa-solid fa-check"></i>}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mb-6">
                                        <div className="flex justify-between text-xs text-slate-400 mb-2"><span>Questions: {questionCount}</span></div>
                                        <input type="range" min="1" max="10" value={questionCount} onChange={e => setQuestionCount(parseInt(e.target.value))} className="w-full" />
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={() => setView('setup')} className="flex-1 premium-btn py-3 rounded-xl text-slate-400">Back</button>
                                        <button onClick={startTest} className="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">Start Test</button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            if (view === 'report') {
                return <ReportCard questions={questions} timer={timer} user={user} subject={subject} level={level} onClose={() => setView('topics')} />
            }

            // TEST VIEW
            return (
                <div className="h-screen w-screen flex overflow-hidden bg-black/40 backdrop-blur-sm">
                    <Modal isOpen={!!modalConfig} message={modalConfig?.message} confirmText={modalConfig?.confirmText} cancelText={modalConfig?.cancelText} onConfirm={modalConfig?.onConfirm} onCancel={() => setModalConfig(null)} />
                    
                    {/* SIDEBAR */}
                    <div className="w-20 glass-panel border-r border-white/5 flex flex-col items-center py-6 gap-4 z-30 pt-24">
                        <button onClick={() => setModalConfig({ message: "Exit to topics?", confirmText: "Exit", cancelText: "Cancel", onConfirm: () => { setView('topics'); setModalConfig(null); }})} className="text-slate-400 hover:text-red-400 mb-2">
                            <i className="fa-solid fa-arrow-left text-xl"></i>
                        </button>
                        <div className="w-8 h-px bg-white/10 mb-2"></div>
                        <div className="flex-1 overflow-y-auto w-full flex flex-col items-center gap-4 py-4 custom-scroll">
                            {questions.map((q, idx) => {
                                let statusClass = 'bg-slate-700/50 text-slate-500';
                                if (q.status === 'generating') statusClass = 'text-cyan-400 relative spin-border w-10 h-10';
                                else if (q.status === 'ready') statusClass = 'bg-slate-600 text-white hover:bg-slate-500';
                                else if (q.status === 'correct') statusClass = 'bg-emerald-600 text-white';
                                else if (q.status === 'wrong') statusClass = 'bg-red-600 text-white';
                                
                                return (
                                    <button key={idx} onClick={() => changeQuestion(idx)}
                                        className={`w-10 h-10 rounded-full flex flex-shrink-0 items-center justify-center text-xs font-bold transition-all ${statusClass} ${currentQIndex === idx ? 'scale-110 ring-2 ring-white' : ''}`}>
                                        {idx + 1}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* WORKSPACE */}
                    <div className="flex-1 flex flex-col relative">
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 z-20 flex flex-col items-center gap-2">
                            <div className="glass-panel rounded-full px-4 py-2 flex items-center gap-4">
                                <button onClick={() => setWbTool('pen')} className={`${wbTool==='pen'?'text-cyan-400':'text-slate-400'}`}><i className="fa-solid fa-pen"></i></button>
                                <button onClick={() => setWbTool('eraser')} className={`${wbTool==='eraser'?'text-pink-400':'text-slate-400'}`}><i className="fa-solid fa-eraser"></i></button>
                                <input type="color" value={wbColor} onChange={e => setWbColor(e.target.value)} className="w-6 h-6 rounded-full bg-transparent cursor-pointer" />
                                <button onClick={() => setClearBoardTrig(p=>p+1)} className="text-slate-400 hover:text-white"><i className="fa-solid fa-rotate-left"></i></button>
                            </div>
                        </div>

                        <div className="absolute top-4 right-4 glass-panel px-4 py-2 rounded-full text-sm font-mono flex items-center gap-2 z-20">
                            {isQLoading ? (
                                <>
                                    <div className="w-3 h-3 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
                                    <span className="text-cyan-400">Loading...</span>
                                </>
                            ) : (
                                <>
                                    <i className="fa-regular fa-clock text-slate-400"></i>
                                    <span className="text-white">{Math.floor(timer/60)}:{(timer%60).toString().padStart(2,'0')}</span>
                                </>
                            )}
                        </div>

                        <div className="flex-1 relative cursor-crosshair flex flex-col">
                            {!isQLoading && <Whiteboard tool={wbTool} color={wbColor} size={wbSize} triggerClear={clearBoardTrig} teacherMarks={teacherMarks} hasDrawnRef={hasDrawn} />}
                            
                            <div className="absolute top-20 left-10 right-10 pointer-events-none select-none flex flex-col gap-4">
                                {isQLoading ? (
                                    <div className="glass-panel p-6 rounded-2xl flex flex-col gap-2 max-w-lg">
                                        <div className="text-sm font-bold text-cyan-400 uppercase tracking-widest">Generating...</div>
                                        <div className="h-1 bg-slate-700 rounded-full w-full"><div className="h-full bg-cyan-400 animate-pulse w-2/3"></div></div>
                                    </div>
                                ) : (
                                    <div className="glass-panel p-6 rounded-2xl border-l-4 border-cyan-500 animate-fade-in max-w-2xl">
                                        <div className="text-[10px] text-cyan-400 font-bold uppercase tracking-widest mb-2">Q{currentQIndex+1} • {currentQ.topic}</div>
                                        <MathText text={currentQ.text} />
                                    </div>
                                )}
                            </div>

                            {/* Answer Input Area */}
                            {!isQLoading && (
                                <div className="absolute bottom-6 left-1/2 -translate-x-1/2 w-full max-w-xl glass-panel p-2 rounded-xl flex gap-2 z-20">
                                    <input 
                                        type="text" 
                                        value={userTypedAns} 
                                        onChange={(e) => setUserTypedAns(e.target.value)} 
                                        placeholder="Type final answer (e.g. x=5)..."
                                        className="flex-1 bg-black/20 text-white px-4 py-3 rounded-lg focus:outline-none"
                                        onKeyPress={(e) => e.key === 'Enter' && handleSubmitAnswer()}
                                    />
                                    {isGraded ? (
                                        <button onClick={() => currentQIndex < questions.length - 1 ? changeQuestion(currentQIndex + 1) : null}
                                            disabled={currentQIndex >= questions.length - 1}
                                            className="premium-btn bg-purple-500/20 text-purple-300 font-bold py-2 px-6 rounded-lg shadow-lg disabled:opacity-50">
                                            Next Q
                                        </button>
                                    ) : (
                                        <button onClick={handleSubmitAnswer} disabled={isProcessing}
                                            className="premium-btn bg-cyan-500/20 text-cyan-300 font-bold py-2 px-6 rounded-lg shadow-lg disabled:opacity-50">
                                            Submit
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* AI Sidebar */}
                    <div className="w-80 glass-panel border-l border-white/5 flex flex-col z-30">
                        <div className="p-4 border-b border-white/5 bg-white/5 font-bold text-white flex items-center gap-2">
                            <i className="fa-solid fa-robot text-cyan-400"></i> Tutor
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll">
                            {messages.map((m, i) => (
                                <div key={i} className={`p-3 rounded-lg text-sm border ${m.role==='user'?'ml-auto bg-cyan-900/30 border-cyan-500/30 text-cyan-100':'bg-white/5 border-white/10 text-slate-300'}`}>
                                    <MathText text={m.text} />
                                </div>
                            ))}
                        </div>
                        <div className="p-4 border-t border-white/5 bg-black/20">
                            {allDone ? (
                                <button onClick={() => setView('report')} className="w-full mb-3 bg-gradient-to-r from-yellow-600 to-orange-600 text-white font-bold py-3 rounded-lg shadow-lg">Finish Test</button>
                            ) : (
                                <div className="grid grid-cols-2 gap-2 mb-3">
                                    <button onClick={handleGiveUp} disabled={isQLoading || isGraded || isProcessing} className="premium-btn bg-slate-700/50 text-slate-300 py-2 rounded-lg text-sm hover:bg-slate-600 disabled:opacity-50">Give Up</button>
                                    <button onClick={handleEvaluate} disabled={isQLoading || isGraded || isProcessing} className="premium-btn bg-emerald-600/50 text-white py-2 rounded-lg text-sm hover:bg-emerald-500 disabled:opacity-50">Evaluate</button>
                                </div>
                            )}
                            <div className="flex gap-2">
                                <input type="text" value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSendMessage()} placeholder="Ask..." className="flex-1 glass-input rounded-lg px-3 py-2 text-sm" />
                                <button onClick={handleSendMessage} className="premium-btn px-3 rounded-lg text-cyan-400"><i className="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
```

### **2. Setup Instructions for GitHub (Database Feature)**

To enable the PDF reading capability, follow these steps exactly:

1.  **Repository Structure:**
    In your GitHub repository, create a folder named `data`. Inside it, create folders for each subject and year level exactly matching this structure:

    ```
    /data
      /Methods
        /Year 11
          1.pdf
          2.pdf
        /Year 12
          1.pdf
      /Spec
        /Year 11
        /Year 12
      /Physics
        ...
      /Chem
        ...
