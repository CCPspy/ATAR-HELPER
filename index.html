<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ATAR HELPER</title>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        glass: "rgba(15, 23, 42, 0.9)",
                        glassBorder: "rgba(255, 255, 255, 0.08)",
                        primary: "#3b82f6",
                        premiumBg: "#020617"
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-in-right': 'slideInRight 0.3s ease-out forwards',
                        'slide-up-reveal': 'slideUpReveal 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'spin-slow': 'spin 2s linear infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' }
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        slideUpReveal: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    
    <!-- PDF & Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow: hidden; }
        
        /* Premium Glassmorphism */
        .glass-panel { 
            background: rgba(15, 23, 42, 0.85); 
            backdrop-filter: blur(24px); 
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .glass-input { 
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid rgba(255,255,255,0.08); 
            color: white; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .glass-input:focus { 
            outline: none; 
            border-color: #3b82f6; 
            background: rgba(0, 0, 0, 0.7); 
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
        }

        /* Custom Select styling */
        .custom-select-wrapper { position: relative; }
        .custom-select-wrapper::after {
            content: "â–¼";
            font-size: 0.6rem;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
        }
        select { appearance: none; -webkit-appearance: none; }
        select option { background-color: #0f172a; color: white; padding: 12px; }
        
        /* Math Rendering */
        .katex-display { margin: 0.5em 0; overflow-x: auto; overflow-y: hidden; }
        
        canvas { touch-action: none; cursor: crosshair; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Spin Animation for Loading Questions */
        .spin-border {
            border: 2px solid transparent;
            border-top-color: #3b82f6;
            border-right-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { createRoot } = ReactDOM;
        
        // --- CONSTANTS ---
        const GEMINI_MODELS = [
            "gemini-2.5-flash", 
            "gemini-2.5-flash-lite", 
            "gemini-2.0-flash",
            "gemini-2.0-flash-lite"
        ]; 
        const SUBJECT_DATA = {
            "Methods": ["Calculus", "Functions & Graphs", "Probability", "Statistics", "Integrals", "Trigonometry"],
            "Specialist": ["Vectors", "Complex Numbers", "Matrices", "Dynamics", "Combinatorics", "Differential Equations"],
            "Physics": ["Linear Motion", "Forces & Dynamics", "Gravity", "Electromagnetism", "Quantum Theory", "Special Relativity"],
            "Chemistry": ["Atomic Structure", "Chemical Bonding", "Equilibrium", "Acids & Bases", "Redox Reactions", "Organic Chemistry"]
        };
        const LEVELS = ["Year 11", "Year 12"];

        // --- UTILS ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Helper: Robust API Key Decoder
        const decodeKey = (str) => {
            if (!str) return null;
            try {
                const trimmed = str.trim();
                if (trimmed.startsWith("AIza")) return trimmed;
                const decoded = atob(trimmed);
                if (decoded && decoded.includes("AIza")) return decoded.trim();
                return null;
            } catch { return null; }
        };

        // Helper: Call Gemini with Fallback
        const callGeminiAPI = async (payload, apiKey) => {
            if (!apiKey) throw new Error("Missing API Key");
            
            for (const model of GEMINI_MODELS) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.status === 429) throw new Error("Rate limit");
                    if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                    const data = await response.json();
                    return data;
                } catch (e) {
                    console.warn(`Model ${model} failed: ${e.message}. Trying next...`);
                    continue; 
                }
            }
            throw new Error("All Gemini models unavailable.");
        };

        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        const LatexRenderer = ({ text }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (!containerRef.current || !text) return;
                containerRef.current.innerHTML = '';
                const parts = text.split(/\$([^\$]+)\$/g);
                parts.forEach((part, index) => {
                    if (index % 2 === 1) { 
                        const span = document.createElement('span');
                        try {
                            katex.render(part, span, { throwOnError: false, displayMode: false });
                        } catch(e) { span.innerText = `$${part}$`; }
                        containerRef.current.appendChild(span);
                    } else {
                        if (part.length > 0) {
                            const span = document.createElement('span');
                            span.innerText = part;
                            containerRef.current.appendChild(span);
                        }
                    }
                });
            }, [text]);
            return <span ref={containerRef} className="latex-content" />;
        };

        const generateOfflineQuestion = (subject) => {
            const templates = [
                {
                    topic: "Calculus (Offline)",
                    gen: () => {
                        const a = Math.floor(Math.random() * 5) + 2;
                        const n = Math.floor(Math.random() * 3) + 2;
                        const marks = Math.floor(Math.random() * 3) + 2;
                        return { text: `Differentiate $f(x) = ${a}x^${n} - ${Math.floor(Math.random()*10)}x$`, answer: `$f'(x) = ${a*n}x^${n-1} - ...$`, marks: marks, hint: "Power Rule" };
                    }
                },
                {
                    topic: "Algebra (Offline)",
                    gen: () => {
                        const a = Math.floor(Math.random() * 5) + 2;
                        const c = Math.floor(Math.random() * 20) + 10;
                        const marks = Math.floor(Math.random() * 2) + 2;
                        return { text: `Solve for $x$: $${a}x + 5 = ${c}$`, answer: `$x = ${(c-5)/a}$`, marks: marks, hint: "Isolate x" }
                    }
                }
            ];
            const q = templates[Math.floor(Math.random() * templates.length)].gen();
            return { ...q, id: Date.now(), subject: subject || "General", isOffline: true };
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [view, setView] = useState("GATEWAY"); 
            const [user, setUser] = useState({ name: "", apiKey: "" });
            
            const [config, setConfig] = useState({ 
                subject: "Methods", 
                level: "Year 12", 
                studyMode: "full",
                selectedTopics: [],
                count: 5,
                extraPrompt: "",
                customMaterials: ""
            });
            
            const [contextData, setContextData] = useState("");
            const [contextStatus, setContextStatus] = useState("idle"); 
            const [loadingState, setLoadingState] = useState({ active: false, msg: "", time: 0 });
            
            const [questions, setQuestions] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [generating, setGenerating] = useState(false);
            const generationPaused = useRef(false);
            const [timer, setTimer] = useState(0); 
            const [initialMessages, setInitialMessages] = useState([]);

            useEffect(() => {
                const handleBeforeUnload = (e) => {
                    if (view === "ARENA") { e.preventDefault(); e.returnValue = ''; return ''; }
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [view]);

            useEffect(() => {
                let interval;
                if (view === "ARENA") {
                    interval = setInterval(() => { setTimer(prev => prev + 1); }, 1000);
                }
                return () => clearInterval(interval);
            }, [view]);

            useEffect(() => {
                fetch('GE.txt')
                    .then(r => r.ok ? r.text() : Promise.reject())
                    .then(txt => {
                        const lines = txt.split('\n');
                        for (const line of lines) {
                            const validKey = decodeKey(line);
                            if (validKey) { setUser(u => ({ ...u, apiKey: validKey })); break; }
                        }
                    })
                    .catch(() => console.log("No GE.txt"));
            }, []);

            const handleFileUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                setLoadingState({ active: true, msg: "Reading Materials...", time: 0.1 });
                let extractedText = "";
                for (const file of files) {
                    try {
                        const buffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(buffer).promise;
                        for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            extractedText += content.items.map(item => item.str).join(' ') + "\n";
                        }
                    } catch (err) { console.error("PDF Error", err); }
                }
                setConfig(prev => ({ ...prev, customMaterials: extractedText }));
                setLoadingState({ active: false, msg: "", time: 0 });
            };

            const loadSubjectContext = async () => {
                if (!user.apiKey) {
                    setContextStatus("offline");
                    startSession();
                    return;
                }

                setLoadingState({ active: true, msg: "SCANNING DATABASE...", time: 0.1 });
                let fullText = "";
                let pdfIndex = 1;
                let failCount = 0;
                let foundAny = false;

                try {
                    while (failCount < 2 && pdfIndex < 20) { 
                        const url = `data/${config.subject}/${config.level}/${pdfIndex}.pdf`;
                        try {
                            const head = await fetch(url, { method: 'HEAD' });
                            if (!head.ok) throw new Error("404");
                            const loadingTask = pdfjsLib.getDocument(url);
                            const pdf = await loadingTask.promise;
                            for (let i = 1; i <= Math.min(pdf.numPages, 4); i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                fullText += content.items.map(item => item.str).join(' ');
                            }
                            foundAny = true;
                            failCount = 0; pdfIndex++;
                        } catch (e) { failCount++; pdfIndex++; }
                    }
                } catch (e) { console.error("RAG Error", e); }

                setContextData(fullText.substring(0, 15000));
                setContextStatus(foundAny ? "ready" : "missing");
                setLoadingState({ active: false, msg: "", time: 0 });
                startSession();
            };

            const generateQuestion = async (indexOverride) => {
                if (generationPaused.current) return;
                setGenerating(true);

                // Helper to update specific index
                const updateQ = (idx, qData) => {
                    setQuestions(prev => {
                        const newQs = [...prev];
                        newQs[idx] = { ...qData, id: Date.now(), status: 'ready', userAnswer: '', grading: null };
                        return newQs;
                    });
                };

                // If initializing (first 2 questions)
                if (questions.length === 0) {
                    const placeholders = Array(config.count).fill({ status: 'generating', text: 'Generating...', topic: 'Loading' });
                    setQuestions(placeholders);
                    
                    const timer = setInterval(() => setLoadingState(p => ({...p, time: p.time + 0.1})), 100);
                    setLoadingState({ active: true, msg: "INITIALIZING SESSION...", time: 0 });

                    // Generate Q1
                    let q1;
                    if (!user.apiKey) q1 = generateOfflineQuestion(config.subject);
                    else {
                        try { q1 = await fetchQuestionAI(); } 
                        catch (e) { q1 = generateOfflineQuestion(config.subject); }
                    }
                    updateQ(0, q1);

                    // Generate Q2 immediately if count > 1
                    if (config.count > 1) {
                        let q2;
                        if (!user.apiKey) q2 = generateOfflineQuestion(config.subject);
                        else {
                            try { q2 = await fetchQuestionAI(); }
                            catch (e) { q2 = generateOfflineQuestion(config.subject); }
                        }
                        updateQ(1, q2);
                    }

                    // Prepare Greeting
                    let msgs = [{ role: 'ai', text: `Hello ${user.name}, good luck with your ${config.subject} session!` }];
                    if (config.extraPrompt) msgs.push({ role: 'ai', text: "I've noted your extra instructions." });
                    if (config.customMaterials) msgs.push({ role: 'ai', text: "I've analyzed your uploaded materials and will reference them." });
                    setInitialMessages(msgs);

                    clearInterval(timer);
                    setLoadingState({ active: false, msg: "", time: 0 });
                    setView("ARENA");
                    setGenerating(false);
                    return;
                }

                // Background Generation for Q3 onwards
                // Find next generating index
                const nextIdx = questions.findIndex(q => q.status === 'generating');
                if (nextIdx !== -1) {
                    if (!user.apiKey) {
                        updateQ(nextIdx, generateOfflineQuestion(config.subject));
                    } else {
                        try {
                            const q = await fetchQuestionAI();
                            updateQ(nextIdx, q);
                        } catch (e) {
                            updateQ(nextIdx, generateOfflineQuestion(config.subject));
                        }
                    }
                }
                setGenerating(false);
            };

            const fetchQuestionAI = async () => {
                if (!user.apiKey) throw new Error("No Key");
                const focus = config.studyMode === 'targeted' && config.selectedTopics.length > 0 
                    ? `FOCUS TOPICS: ${config.selectedTopics.join(", ")}` 
                    : `FOCUS: Comprehensive ${config.level} Curriculum`;
                
                let materialContext = "";
                if (config.customMaterials) materialContext = `USER MATERIALS: ${config.customMaterials.substring(0, 5000)}`;
                let extra = "";
                if (config.extraPrompt) extra = `USER EXTRA INSTRUCTIONS: ${config.extraPrompt}`;

                const systemPrompt = `You are a strict teacher for Australian ATAR ${config.subject}. 
                CONTEXT: ${contextData}
                ${materialContext}
                TASK: Generate 1 unique, challenging question. ${focus}. ${extra}
                RULES: Output strictly valid JSON. NO multiple choice. NO sub-questions. ALWAYS wrap math expressions in single $ signs (e.g. $x^2$). Allocate marks (between 2 and 6) based on difficulty. 
                FORMAT: { "text": "Question text with math in $...$", "topic": "string", "answer": "Answer with math in $...$", "hint": "Hint string", "marks": number }`;
                
                const payload = { contents: [{ parts: [{ text: systemPrompt }] }], generationConfig: { responseMimeType: "application/json" } };
                const data = await callGeminiAPI(payload, user.apiKey);
                return JSON.parse(data.candidates[0].content.parts[0].text);
            };

            // Loop to fill queue
            useEffect(() => {
                if (view === "ARENA" && !generating) {
                    const pending = questions.filter(q => q.status === 'generating').length;
                    if (pending > 0) {
                        generateQuestion();
                    }
                }
            }, [questions, view, generating]);

            const handleNameSubmit = () => {
                if(user.name.trim()) {
                    setUser(u => ({ ...u, name: u.name.trim().toUpperCase() }));
                    setView("CONFIG");
                }
            };

            const startSession = () => {
                setTimer(0);
                generateQuestion(); // Triggers the init sequence
            };

            return (
                <div className="w-full h-screen flex flex-col text-sm md:text-base relative selection:bg-blue-500 selection:text-white">
                    {loadingState.active && (
                        <div className="absolute inset-0 z-50 bg-[#020617] flex flex-col items-center justify-center p-8 backdrop-blur-xl">
                            <div className="w-20 h-20 relative">
                                <div className="absolute inset-0 border-4 border-slate-800 rounded-full"></div>
                                <div className="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                            </div>
                            <h2 className="text-xl font-bold tracking-[0.2em] text-blue-400 animate-pulse mt-8">{loadingState.msg}</h2>
                            <p className="mt-2 text-slate-500 font-mono text-xs">{loadingState.time.toFixed(1)}s</p>
                        </div>
                    )}

                    {view === "GATEWAY" && (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 relative overflow-hidden">
                            <div className="absolute top-[-20%] left-[-10%] w-[800px] h-[800px] bg-blue-600/10 rounded-full blur-[120px]"></div>
                            <div className="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-emerald-600/5 rounded-full blur-[100px]"></div>
                            
                            <div className="z-10 w-full max-w-md glass-panel p-12 rounded-3xl flex flex-col items-center animate-slide-up">
                                <h1 className="text-5xl font-black tracking-tighter mb-2 bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">ATAR HELPER</h1>
                                <div className="h-1 w-24 bg-blue-500 rounded-full mb-10 opacity-80"></div>
                                <div className="w-full relative group">
                                    <input type="text" placeholder="ENTER SURNAME" className="w-full glass-input p-5 rounded-xl text-center font-bold tracking-[0.2em] text-lg placeholder:text-slate-600 focus:placeholder:text-slate-700" value={user.name} onChange={(e) => setUser({...user, name: e.target.value.toUpperCase()})} onKeyDown={(e) => e.key === 'Enter' && handleNameSubmit()}/>
                                </div>
                                <button onClick={handleNameSubmit} className="w-full mt-6 bg-blue-600 hover:bg-blue-500 text-white font-bold py-5 rounded-xl shadow-lg shadow-blue-900/20 transition-all hover:translate-y-[-2px] active:scale-95 tracking-widest text-xs">INITIALIZE SYSTEM</button>
                            </div>
                        </div>
                    )}

                    {view === "CONFIG" && (
                        <div className="flex-1 flex flex-col items-center justify-center p-4 md:p-6 overflow-hidden">
                            <div className="w-full max-w-4xl glass-panel p-8 md:p-10 rounded-3xl animate-slide-up flex flex-col max-h-full">
                                <div className="flex justify-between items-center mb-8 border-b border-white/5 pb-6">
                                    <h2 className="text-sm font-bold text-white flex items-center tracking-[0.2em]"><div className="w-1.5 h-6 bg-emerald-500 mr-4 rounded-full"></div>SESSION CONFIGURATION</h2>
                                    <span className="text-slate-500 font-mono text-xs font-bold bg-white/5 px-3 py-1 rounded-full">{user.name}</span>
                                </div>
                                
                                {/* 3 Column Layout */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-4 overflow-y-auto custom-scrollbar pr-2">
                                    {/* Col 1: Basic */}
                                    <div className="space-y-6">
                                        <h3 className="text-[10px] text-blue-400 font-bold uppercase tracking-widest border-b border-white/10 pb-2">Core Settings</h3>
                                        <div className="custom-select-wrapper">
                                            <label className="text-[10px] text-slate-400 font-bold uppercase tracking-widest ml-1 mb-2 block">Subject</label>
                                            <select className="w-full glass-input p-3 rounded-lg font-medium cursor-pointer text-sm" value={config.subject} onChange={(e) => setConfig({...config, subject: e.target.value, selectedTopics: []})}>
                                                {Object.keys(SUBJECT_DATA).map(s => <option key={s} value={s}>{s.toUpperCase()}</option>)}
                                            </select>
                                        </div>
                                        <div className="custom-select-wrapper">
                                            <label className="text-[10px] text-slate-400 font-bold uppercase tracking-widest ml-1 mb-2 block">Level</label>
                                            <select className="w-full glass-input p-3 rounded-lg font-medium cursor-pointer text-sm" value={config.level} onChange={(e) => setConfig({...config, level: e.target.value})}>
                                                {LEVELS.map(l => <option key={l} value={l}>{l.toUpperCase()}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-[10px] text-slate-400 font-bold uppercase tracking-widest ml-1 mb-2 block">Questions: {config.count}</label>
                                            <input type="range" min="1" max="10" value={config.count} onChange={(e) => setConfig({...config, count: parseInt(e.target.value)})} className="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"/>
                                        </div>
                                    </div>

                                    {/* Col 2: Topics */}
                                    <div className="flex flex-col h-full">
                                        <h3 className="text-[10px] text-blue-400 font-bold uppercase tracking-widest border-b border-white/10 pb-2 mb-4">Focus</h3>
                                        <div className="bg-black/20 rounded-xl p-1 border border-white/5 flex mb-4">
                                            <button onClick={() => setConfig({...config, studyMode: 'full'})} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-wide rounded-lg transition-all ${config.studyMode === 'full' ? 'bg-slate-700 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>Comprehensive</button>
                                            <button onClick={() => setConfig({...config, studyMode: 'targeted'})} className={`flex-1 py-3 text-[10px] font-bold uppercase tracking-wide rounded-lg transition-all ${config.studyMode === 'targeted' ? 'bg-slate-700 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>Targeted</button>
                                        </div>
                                        {config.studyMode === 'targeted' ? (
                                            <div className="bg-black/20 rounded-xl p-4 border border-white/5 flex-1 overflow-y-auto custom-scrollbar min-h-[150px]">
                                                <div className="space-y-2">
                                                    {SUBJECT_DATA[config.subject].map(topic => (
                                                        <label key={topic} className="flex items-center space-x-3 cursor-pointer group hover:bg-white/5 p-2 rounded transition-colors">
                                                            <div className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${config.selectedTopics.includes(topic) ? 'bg-blue-500 border-blue-500' : 'border-slate-600 group-hover:border-slate-400'}`}>
                                                                {config.selectedTopics.includes(topic) && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7"/></svg>}
                                                            </div>
                                                            <input type="checkbox" className="hidden" checked={config.selectedTopics.includes(topic)} onChange={(e) => { const newTopics = e.target.checked ? [...config.selectedTopics, topic] : config.selectedTopics.filter(t => t !== topic); setConfig({...config, selectedTopics: newTopics}); }}/>
                                                            <span className={`text-xs font-medium ${config.selectedTopics.includes(topic) ? 'text-white' : 'text-slate-400'}`}>{topic}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex-1 flex flex-col items-center justify-center border border-dashed border-white/10 rounded-xl text-slate-500 p-4">
                                                <p className="text-xs text-center">Full curriculum will be covered.</p>
                                            </div>
                                        )}
                                    </div>

                                    {/* Col 3: Customization */}
                                    <div className="space-y-4">
                                        <h3 className="text-[10px] text-blue-400 font-bold uppercase tracking-widest border-b border-white/10 pb-2">Customization</h3>
                                        <div>
                                            <label className="text-[10px] text-slate-400 font-bold uppercase tracking-widest ml-1 mb-2 block">Extra Instructions</label>
                                            <textarea 
                                                value={config.extraPrompt}
                                                onChange={(e) => setConfig({...config, extraPrompt: e.target.value})}
                                                placeholder="E.g., 'Be extra strict', 'Focus on tricky algebra'..."
                                                className="w-full glass-input rounded-xl p-3 text-xs h-24 resize-none focus:outline-none"
                                            ></textarea>
                                        </div>
                                        <div>
                                            <label className="text-[10px] text-slate-400 font-bold uppercase tracking-widest ml-1 mb-2 block">Upload Materials (PDF)</label>
                                            <div className="relative w-full h-24 border border-dashed border-white/20 rounded-xl flex flex-col items-center justify-center hover:bg-white/5 transition-colors group">
                                                <input type="file" accept=".pdf" multiple onChange={handleFileUpload} className="absolute inset-0 opacity-0 cursor-pointer"/>
                                                <span className="text-2xl mb-1 group-hover:scale-110 transition-transform">ðŸ“„</span>
                                                <span className="text-[10px] text-slate-500">Drop PDFs here</span>
                                            </div>
                                            {config.customMaterials && <p className="text-[10px] text-emerald-400 mt-1">âœ“ Materials Loaded</p>}
                                        </div>
                                        <div className="pt-2">
                                            <label className="text-[10px] text-slate-500 font-bold uppercase tracking-widest ml-1 mb-2 block">API Override</label>
                                            <input type="password" value={user.apiKey} onChange={(e) => setUser({...user, apiKey: e.target.value})} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" className="w-full bg-transparent border-b border-slate-700 py-2 text-xs font-mono text-slate-300 focus:border-blue-500 focus:outline-none transition-colors"/>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={loadSubjectContext} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-[0.98] flex items-center justify-center space-x-2 tracking-[0.1em] text-sm mt-2"><span>START SESSION</span></button>
                            </div>
                        </div>
                    )}

                    {view === "ARENA" && questions.length > 0 && (
                        <Arena 
                            question={questions[currentQIndex]}
                            questions={questions} 
                            qIndex={currentQIndex}
                            total={questions.length}
                            onNext={() => setCurrentQIndex(prev => Math.min(prev + 1, questions.length - 1))}
                            onUpdateQuestion={(updatedQ) => {
                                const newQs = [...questions];
                                newQs[currentQIndex] = updatedQ;
                                setQuestions(newQs);
                            }}
                            onFinish={() => setView("DEBRIEF")}
                            allComplete={questions.every(q => q.status === 'graded')}
                            apiKey={user.apiKey}
                            subject={config.subject}
                            pauseGen={generationPaused}
                            contextStatus={contextStatus}
                            timer={timer}
                            initialMessages={initialMessages}
                        />
                    )}

                    {view === "DEBRIEF" && (
                        <Debrief 
                            questions={questions} 
                            user={user} 
                            config={config} 
                            timer={timer}
                            onRestart={() => window.location.reload()} 
                        />
                    )}

                    <div className="absolute bottom-3 left-0 w-full text-center pointer-events-none opacity-30 z-0">
                        <p className="text-[10px] font-mono text-slate-500 tracking-[0.2em] uppercase">ERIC / CCPSPY | WILLETTON SHS | 2026</p>
                    </div>
                </div>
            );
        };

        const Arena = ({ questions, question, qIndex, total, onNext, onUpdateQuestion, onFinish, allComplete, apiKey, subject, pauseGen, contextStatus, timer, initialMessages }) => {
            const [input, setInput] = useState("");
            const [penColor, setPenColor] = useState("#ffffff");
            const [isEraser, setIsEraser] = useState(false);
            const [messages, setMessages] = useState(initialMessages || []);
            const [chatInput, setChatInput] = useState("");
            const [grading, setGrading] = useState(false);
            const [evaluating, setEvaluating] = useState(false);
            const [isMinimized, setIsMinimized] = useState(false);
            const [showClearConfirm, setShowClearConfirm] = useState(false);
            const [showGiveUpConfirm, setShowGiveUpConfirm] = useState(false);
            const [showKeyboard, setShowKeyboard] = useState(false);
            const [sidebarTab, setSidebarTab] = useState('tutor'); 
            
            const canvasRef = useRef(null);
            const ctxRef = useRef(null);
            const isDrawing = useRef(false);
            const inputRef = useRef(null);

            useEffect(() => {
                const initCanvas = () => {
                    const canvas = canvasRef.current;
                    if(!canvas) return;
                    const parent = canvas.parentElement;
                    const dpr = window.devicePixelRatio || 1;
                    const width = parent.clientWidth;
                    const height = parent.clientHeight;
                    canvas.width = width * dpr;
                    canvas.height = height * dpr;
                    canvas.style.width = `${width}px`;
                    canvas.style.height = `${height}px`;
                    const ctx = canvas.getContext("2d");
                    ctx.scale(dpr, dpr);
                    ctx.lineCap = "round";
                    ctx.lineJoin = "round";
                    ctx.strokeStyle = penColor;
                    ctx.lineWidth = isEraser ? 30 : 3;
                    ctxRef.current = ctx;
                };
                initCanvas();
                window.addEventListener('resize', initCanvas);
                return () => window.removeEventListener('resize', initCanvas);
            }, [qIndex]); 

            useEffect(() => {
                if(ctxRef.current) {
                    ctxRef.current.globalCompositeOperation = isEraser ? "destination-out" : "source-over";
                    ctxRef.current.lineWidth = isEraser ? 30 : 3;
                    if(!isEraser) ctxRef.current.strokeStyle = penColor;
                }
            }, [penColor, isEraser]);

            const getCoords = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const startDraw = (e) => {
                const {x, y} = getCoords(e);
                ctxRef.current.beginPath();
                ctxRef.current.moveTo(x, y);
                isDrawing.current = true;
            };
            const draw = (e) => {
                if (!isDrawing.current) return;
                const {x, y} = getCoords(e);
                ctxRef.current.lineTo(x, y);
                ctxRef.current.stroke();
            };
            const stopDraw = () => {
                ctxRef.current.closePath();
                isDrawing.current = false;
            };

            const submitAnswer = async () => {
                if (!input && !canvasRef.current) return;
                pauseGen.current = true;
                setGrading(true);
                let feedbackData = null;
                if (apiKey) {
                    const canvasImage = canvasRef.current.toDataURL("image/png").split(',')[1];
                    const prompt = `Grade this student. Subject: ${subject}. Question: ${question.text}. Student Answer: ${input}. Student Working: [See Image]. Actual Answer: ${question.answer}. Marks Available: ${question.marks}. 
                    TASK: Return strictly valid JSON. 
                    GRADING CRITERIA: 
                    1. STRICT but FAIR. 
                    2. Analyze the image of the working out deeply. Assess if the amount of working shown is sufficient for the marks.
                    3. Award FOLLOW-THROUGH marks.
                    RULES: Wrap all math in $ delimiters. 
                    FORMAT: { "mark": number, "correct": boolean, "feedback": { "positives": "string", "negatives": "string" } }`;
                    try {
                        const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: canvasImage } }] }], generationConfig: { responseMimeType: "application/json" } };
                        const data = await callGeminiAPI(payload, apiKey);
                        feedbackData = JSON.parse(data.candidates[0].content.parts[0].text);
                    } catch (e) {
                        feedbackData = { mark: 0, correct: false, feedback: { positives: "N/A (Offline)", negatives: "Manual Check Required" } };
                    }
                } else {
                    feedbackData = { mark: 0, correct: false, feedback: { positives: "Working Captured", negatives: "No AI Grading (Limited Mode)" } };
                }
                onUpdateQuestion({ ...question, status: 'graded', userAnswer: input, grading: feedbackData });
                setGrading(false);
                setSidebarTab('results'); 
                document.getElementById('tutor-drawer').classList.remove('translate-x-full'); 
                pauseGen.current = false;
            };

            const handleSurrender = async () => {
                setShowGiveUpConfirm(false);
                pauseGen.current = true;
                setGrading(true);
                let feedbackData = null;
                
                if (apiKey) {
                    const prompt = `User surrendered. Question: ${question.text}. Provide the full correct solution steps as feedback. 
                    TASK: Return strictly valid JSON. 
                    FORMAT: { "mark": 0, "correct": false, "feedback": { "positives": "Use this as a learning opportunity.", "negatives": "Here is the solution: [Insert step-by-step solution here with math wrapped in $]" } }`;
                    
                    try {
                        const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                        const data = await callGeminiAPI(payload, apiKey);
                        feedbackData = JSON.parse(data.candidates[0].content.parts[0].text);
                    } catch (e) {
                        feedbackData = { mark: 0, correct: false, feedback: { positives: "N/A", negatives: "Surrendered (Offline)" } };
                    }
                } else {
                    feedbackData = { mark: 0, correct: false, feedback: { positives: "N/A", negatives: "Surrendered (Limited Mode)" } };
                }
                
                onUpdateQuestion({ ...question, status: 'graded', userAnswer: "Surrendered", grading: feedbackData });
                setGrading(false);
                setSidebarTab('results');
                document.getElementById('tutor-drawer').classList.remove('translate-x-full');
                pauseGen.current = false;
            };

            const askTutor = async () => {
                if(!chatInput) return;
                const userMsg = chatInput;
                setMessages(prev => [...prev, {role: 'user', text: userMsg}]);
                setChatInput("");
                pauseGen.current = true;
                
                if (!apiKey) {
                    setMessages(prev => [...prev, {role: 'ai', text: "Chat unavailable in Limited Mode."}]);
                    pauseGen.current = false;
                    return;
                }

                try {
                    const prompt = `Student asks: "${userMsg}". Question: "${question.text}". Give a helpful hint using LaTeX formatting for math (enclosed in $ single dollars). DO NOT reveal answer. Brief.`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const data = await callGeminiAPI(payload, apiKey);
                    setMessages(prev => [...prev, {role: 'ai', text: data.candidates[0].content.parts[0].text}]);
                } catch(e) {
                    setMessages(prev => [...prev, {role: 'ai', text: `Error: ${e.message}`}]);
                }
                pauseGen.current = false;
            };

            const insertMath = (symbol) => {
                const start = inputRef.current.selectionStart;
                const end = inputRef.current.selectionEnd;
                const newVal = input.substring(0, start) + symbol + input.substring(end);
                setInput(newVal);
                setTimeout(() => {
                    inputRef.current.selectionStart = inputRef.current.selectionEnd = start + symbol.length;
                    inputRef.current.focus();
                }, 0);
            };

            const mathSymbols = [
                { display: "x^2", code: "x^{2}" },
                { display: "\\sqrt{x}", code: "\\sqrt{x}" },
                { display: "\\frac{a}{b}", code: "\\frac{a}{b}" },
                { display: "\\pi", code: "\\pi" },
                { display: "\\theta", code: "\\theta" },
                { display: "\\int", code: "\\int" },
                { display: "\\le", code: "\\le" },
                { display: "\\ge", code: "\\ge" },
                { display: "\\approx", code: "\\approx" },
                { display: "\\pm", code: "\\pm" },
                { display: "\\infty", code: "\\infty" }
            ];

            return (
                <div className="flex-1 flex overflow-hidden relative">
                    <div className="w-16 md:w-20 bg-slate-900 border-r border-white/10 flex flex-col items-center py-6 space-y-4 z-20 shadow-xl">
                        <div 
                            className={`w-3 h-3 rounded-full transition-all shadow-[0_0_15px] 
                                ${contextStatus === 'ready' ? 'bg-emerald-500 shadow-emerald-500' : 
                                  contextStatus === 'offline' ? 'bg-amber-500 shadow-amber-500' : 
                                  'bg-slate-600 shadow-slate-600'}`}
                        ></div>
                        <span className={`text-[9px] font-bold text-center leading-tight mb-2 tracking-wide 
                            ${contextStatus === 'ready' ? 'text-emerald-500' : 
                              contextStatus === 'offline' ? 'text-amber-500' : 'text-slate-500'}`}>
                            {contextStatus === 'ready' ? "CLOUD\nACTIVE" : contextStatus === 'offline' ? "LIMITED\nMODE" : "SCANNING"}
                        </span>

                        {questions.map((q, i) => (
                            <button 
                                key={i}
                                disabled={q.status === 'generating'} 
                                onClick={() => {
                                    if(q.status !== 'generating') onNext && i < total ? onUpdateQuestion(questions[i]) : null; // Logic handled in App mainly
                                    // Just visual here, click handler logic relies on App state
                                }}
                                className={`w-10 h-10 rounded-xl flex items-center justify-center font-bold text-xs transition-all
                                    ${i === qIndex ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/40 scale-110' : 'bg-slate-800 text-slate-500 hover:bg-slate-700'}
                                    ${q.status === 'generating' ? 'border-2 border-blue-500/30' : ''}
                                    ${q.status === 'graded' ? (q.grading?.correct ? 'border-2 border-emerald-500' : 'border-2 border-red-500') : ''}
                                `}
                            >
                                {q.status === 'generating' ? (
                                    <div className="w-4 h-4 spin-border"></div>
                                ) : (
                                    i + 1
                                )}
                            </button>
                        ))}
                    </div>

                    <div className="flex-1 relative bg-[#0f172a] overflow-hidden cursor-crosshair">
                        <canvas ref={canvasRef} className="absolute inset-0 z-0" onMouseDown={startDraw} onMouseMove={draw} onMouseUp={stopDraw} onMouseLeave={stopDraw} onTouchStart={startDraw} onTouchMove={draw} onTouchEnd={stopDraw}/>

                        {/* Top Center Toolbar with Timer */}
                        <div className="absolute top-6 left-1/2 transform -translate-x-1/2 glass-panel px-6 py-3 rounded-full flex space-x-6 z-10 shadow-2xl items-center">
                            <button onClick={() => { setPenColor("#ffffff"); setIsEraser(false); }} className={`w-6 h-6 rounded-full bg-white border-2 transition-transform hover:scale-110 ${!isEraser && penColor === '#ffffff' ? 'ring-2 ring-blue-500' : 'border-transparent'}`} />
                            <button onClick={() => { setPenColor("#3b82f6"); setIsEraser(false); }} className={`w-6 h-6 rounded-full bg-blue-500 border-2 transition-transform hover:scale-110 ${!isEraser && penColor === '#3b82f6' ? 'ring-2 ring-white' : 'border-transparent'}`} />
                            <button onClick={() => setIsEraser(true)} className={`text-slate-400 hover:text-white transition-colors hover:scale-110 ${isEraser ? 'text-blue-400' : ''}`}><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                            <div className="w-px h-6 bg-white/20"></div>
                            <button onClick={() => setShowClearConfirm(true)} className="text-red-400 hover:text-red-300 text-[10px] font-bold uppercase tracking-wider hover:scale-105 transition-transform">CLEAR</button>
                            <div className="w-px h-6 bg-white/20"></div>
                            <span className="text-white font-mono text-sm">â± {formatTime(timer)}</span>
                        </div>

                        {/* Question Box */}
                        <div className={`absolute top-6 left-6 max-w-sm w-full md:w-auto glass-panel p-4 rounded-2xl text-white shadow-xl z-10 backdrop-blur-md border-l-4 border-blue-500 transition-all duration-300 ${isMinimized ? 'h-14 overflow-hidden' : ''}`}>
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-[10px] font-bold uppercase tracking-widest text-blue-400">{question.topic}</span>
                                <div className="flex items-center space-x-2">
                                    <span className="text-[10px] bg-white/10 px-2 py-1 rounded text-slate-300">{question.marks} Marks</span>
                                    <button onClick={() => setIsMinimized(!isMinimized)} className="w-6 h-6 flex items-center justify-center bg-white/5 rounded-full hover:bg-white/10 text-white font-bold transition-colors">{isMinimized ? '+' : 'âˆ’'}</button>
                                </div>
                            </div>
                            <div className={`text-lg leading-relaxed font-medium transition-opacity duration-300 ${isMinimized ? 'opacity-0' : 'opacity-100'}`}>
                                <LatexRenderer text={question.text} />
                            </div>
                        </div>

                        {/* Interaction Area */}
                        <div className="absolute bottom-0 left-0 w-full z-20 pointer-events-none bg-gradient-to-t from-[#020617] via-[#020617]/90 to-transparent pb-8 pt-20 px-4 md:px-20">
                            <div className="pointer-events-auto max-w-4xl mx-auto">
                                {question.status === 'graded' ? (
                                    <div className="glass-panel p-6 rounded-2xl border-l-4 border-slate-700 flex flex-col animate-slide-up">
                                        <div className="flex justify-between items-center mb-4">
                                             <h3 className={`font-bold text-xl ${question.grading.correct ? "text-emerald-400" : "text-red-400"}`}>{question.grading.correct ? "CORRECT" : "INCORRECT"}</h3>
                                             <span className="text-sm text-slate-400">See Sidebar for Feedback â†’</span>
                                        </div>
                                        <div className="flex gap-3">
                                            {qIndex < total - 1 ? (
                                                <button 
                                                    onClick={onNext} 
                                                    disabled={questions[qIndex+1]?.status === 'generating'}
                                                    className={`flex-1 py-3 rounded-lg font-bold shadow-lg text-white transition-transform active:scale-95 ${questions[qIndex+1]?.status === 'generating' ? 'bg-slate-600 cursor-not-allowed opacity-50' : 'bg-blue-600 hover:bg-blue-500 shadow-blue-900/50'}`}
                                                >
                                                    {questions[qIndex+1]?.status === 'generating' ? 'GENERATING NEXT...' : 'NEXT QUESTION'}
                                                </button>
                                            ) : (
                                                allComplete && <button onClick={onFinish} className="flex-1 bg-emerald-600 py-3 rounded-lg font-bold hover:bg-emerald-500 shadow-lg text-white transition-transform active:scale-95">FINISH TEST</button>
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col gap-2 relative">
                                        {/* Math Keyboard */}
                                        <div className={`absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-full max-w-xl glass-panel p-2 rounded-xl flex flex-wrap gap-2 justify-center transition-all duration-300 origin-bottom ${showKeyboard ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-4 scale-95 pointer-events-none'}`}>
                                            <div className="w-full flex justify-end mb-1">
                                                <button onClick={() => setShowKeyboard(false)} className="text-[10px] text-slate-400 hover:text-white uppercase font-bold tracking-wide flex items-center gap-1 bg-white/5 px-2 py-1 rounded">â–¼ Collapse</button>
                                            </div>
                                            {mathSymbols.map((item) => (
                                                <button key={item.code} onClick={() => insertMath(item.code)} className="px-3 py-2 bg-white/5 hover:bg-white/10 rounded text-xs font-mono text-blue-300 min-w-[2.5rem] transition-colors shadow-sm border border-white/5"><LatexRenderer text={`$${item.display}$`} /></button>
                                            ))}
                                        </div>

                                        <div className="flex gap-3 items-stretch">
                                            <div className="flex gap-2">
                                                <button onClick={() => setShowGiveUpConfirm(true)} className="w-24 bg-red-900/40 text-red-300 hover:bg-red-900/60 font-bold rounded-xl text-[10px] uppercase tracking-wider transition-colors border border-red-500/20">GIVE UP</button>
                                                <button onClick={submitAnswer} disabled={grading} className="w-24 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/40 disabled:opacity-50 transition-all active:scale-95 uppercase tracking-wider text-[10px] border border-white/10">{grading ? "..." : "SUBMIT"}</button>
                                            </div>
                                            <div className="flex-1 relative group">
                                                <input ref={inputRef} type="text" value={input} onChange={(e) => setInput(e.target.value)} onFocus={() => setShowKeyboard(true)} placeholder="Enter final answer..." className="w-full h-full glass-input rounded-xl pl-4 pr-10 py-4 font-mono text-lg shadow-xl" onKeyDown={(e) => e.key === 'Enter' && submitAnswer()}/>
                                                <button onClick={() => setShowKeyboard(!showKeyboard)} className={`absolute right-3 top-1/2 transform -translate-y-1/2 p-2 rounded-lg transition-colors ${showKeyboard ? 'text-blue-400 bg-white/10' : 'text-slate-400 hover:text-white'}`}>âŒ¨ï¸</button>
                                            </div>
                                            <button onClick={() => { setSidebarTab('tutor'); document.getElementById('tutor-drawer').classList.toggle('translate-x-full'); }} className="bg-slate-700 hover:bg-slate-600 text-white w-14 rounded-xl shadow-lg transition-all md:hidden">?</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {showClearConfirm && (
                            <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in">
                                <div className="glass-panel p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl transform scale-100 transition-all">
                                    <h3 className="text-xl font-bold text-white mb-2">Clear Workspace?</h3>
                                    <div className="flex gap-3 mt-6">
                                        <button onClick={() => setShowClearConfirm(false)} className="flex-1 py-3 rounded-xl bg-slate-700 text-white font-bold hover:bg-slate-600 transition-colors">CANCEL</button>
                                        <button onClick={() => { const ctx = ctxRef.current; ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height); setShowClearConfirm(false); }} className="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-500 transition-colors shadow-lg shadow-red-900/30">CLEAR ALL</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showGiveUpConfirm && (
                            <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in">
                                <div className="glass-panel p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl transform scale-100 transition-all">
                                    <h3 className="text-xl font-bold text-white mb-2">Surrender Question?</h3>
                                    <div className="flex gap-3 mt-6">
                                        <button onClick={() => setShowGiveUpConfirm(false)} className="flex-1 py-3 rounded-xl bg-slate-700 text-white font-bold hover:bg-slate-600 transition-colors">CANCEL</button>
                                        <button onClick={handleSurrender} className="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-500 transition-colors shadow-lg shadow-red-900/30">SURRENDER</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div id="tutor-drawer" className="fixed inset-y-0 right-0 w-80 md:w-96 glass-panel border-l border-white/10 transform translate-x-full md:translate-x-0 transition-transform duration-300 z-30 flex flex-col backdrop-blur-2xl shadow-2xl">
                        <div className="flex border-b border-white/10">
                            <button onClick={() => setSidebarTab('tutor')} className={`flex-1 py-4 text-xs font-bold tracking-widest uppercase transition-colors ${sidebarTab === 'tutor' ? 'bg-blue-600/20 text-blue-400 border-b-2 border-blue-400' : 'text-slate-500 hover:text-slate-300'}`}>AI Tutor</button>
                            <button onClick={() => setSidebarTab('results')} className={`flex-1 py-4 text-xs font-bold tracking-widest uppercase transition-colors ${sidebarTab === 'results' ? 'bg-emerald-600/20 text-emerald-400 border-b-2 border-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}>Results</button>
                        </div>
                        
                        {sidebarTab === 'tutor' && (
                            <div className="flex-1 flex flex-col animate-fade-in">
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                                    {messages.map((m, i) => (
                                        <div key={i} className={`p-3 rounded-xl text-sm ${m.role === 'user' ? 'bg-blue-600/20 text-blue-100 ml-4 border border-blue-500/20' : 'bg-slate-800 text-slate-300 mr-4 border border-white/5'}`}>
                                            <LatexRenderer text={m.text} />
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 border-t border-white/10 space-y-3 bg-slate-900/40">
                                    <button onClick={async () => { if (!apiKey || evaluating) return; setEvaluating(true); pauseGen.current = true; try { const canvasImage = canvasRef.current.toDataURL("image/png").split(',')[1]; const prompt = `Review working for: "${question.text}". Briefly identify errors.`; const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: canvasImage } }] }] }; const data = await callGeminiAPI(payload, apiKey); setMessages(prev => [...prev, {role: 'ai', text: `ðŸ‘€ Analysis: ${data.candidates[0].content.parts[0].text}`}]); } catch(e) { setMessages(prev => [...prev, {role: 'ai', text: "Error: " + e.message}]); } setEvaluating(false); pauseGen.current = false; }} disabled={evaluating} className="w-full py-3 border border-white/10 rounded-lg text-xs font-bold text-slate-300 hover:bg-white/5 flex items-center justify-center gap-2 transition-colors">{evaluating ? "ANALYZING..." : "ðŸ‘ CHECK WORKING"}</button>
                                    <div className="flex gap-2">
                                        <input value={chatInput} onChange={e => setChatInput(e.target.value)} placeholder="Ask for a hint..." className="flex-1 glass-input p-2 rounded-lg text-xs" onKeyDown={e => e.key === 'Enter' && askTutor()}/>
                                        <button onClick={askTutor} className="bg-blue-600 p-2 rounded-lg text-white hover:bg-blue-500"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg></button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {sidebarTab === 'results' && (
                            <div className="flex-1 overflow-y-auto p-6 custom-scrollbar animate-slide-in-right">
                                {question.status === 'graded' ? (
                                    <div className="space-y-6">
                                        <div className="text-center">
                                            <div className={`text-5xl font-black mb-2 ${question.grading.correct ? 'text-emerald-400' : 'text-red-400'}`}>{question.grading.mark}/{question.marks}</div>
                                            <div className="text-xs uppercase tracking-widest text-slate-500">Marks Awarded</div>
                                        </div>
                                        <div className="bg-white/5 rounded-xl p-4 border border-white/5">
                                            <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Correct Answer</h4>
                                            <div className="text-sm font-mono text-white"><LatexRenderer text={question.answer} /></div>
                                        </div>
                                        <div className="space-y-3">
                                            <div className="bg-emerald-900/10 p-4 rounded-xl border-l-2 border-emerald-500">
                                                <h4 className="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-1">Positives</h4>
                                                <p className="text-sm text-emerald-100/80 leading-relaxed"><LatexRenderer text={question.grading.feedback?.positives} /></p>
                                            </div>
                                            <div className="bg-red-900/10 p-4 rounded-xl border-l-2 border-red-500">
                                                <h4 className="text-xs font-bold text-red-400 uppercase tracking-wider mb-1">Improvements / Solution</h4>
                                                <p className="text-sm text-red-100/80 leading-relaxed"><LatexRenderer text={question.grading.feedback?.negatives} /></p>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-full text-slate-500 text-xs text-center">
                                        <div className="text-3xl mb-2 opacity-30">ðŸ“Š</div>
                                        Submit an answer to see<br/>detailed feedback here.
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    <button onClick={() => document.getElementById('tutor-drawer').classList.toggle('translate-x-full')} className="fixed top-1/2 right-0 transform -translate-y-1/2 bg-blue-600 text-white p-2 rounded-l-xl shadow-lg z-40 md:hidden hover:pr-4 transition-all">
                        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                </div>
            );
        };

        const Debrief = ({ questions, user, config, onRestart, timer }) => {
            const score = questions.reduce((acc, q) => acc + (q.grading?.mark || 0), 0);
            const total = questions.reduce((acc, q) => acc + q.marks, 0);
            const percentage = Math.round((score / total) * 100);

            const downloadPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFillColor(15, 23, 42); 
                doc.rect(0, 0, 210, 45, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.text("ATAR HELPER REPORT", 20, 25);
                doc.setFontSize(10);
                doc.setTextColor(148, 163, 184); 
                doc.text("Comprehensive Performance Analysis", 20, 32);
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                
                doc.text(`Student: ${user.name}`, 20, 60);
                doc.text(`Subject: ${config.subject} (${config.level})`, 20, 66);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 72);
                doc.text(`Time Taken: ${formatTime(timer)}`, 20, 78);
                
                doc.setFillColor(241, 245, 249); 
                doc.roundedRect(140, 55, 50, 25, 3, 3, 'F');
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text(`${percentage}%`, 165, 68, null, null, "center");
                doc.setFontSize(8);
                doc.setFont("helvetica", "normal");
                doc.text(`${score}/${total} Marks`, 165, 74, null, null, "center");
                
                let y = 90;
                
                questions.forEach((q, i) => {
                    if(y > 250) { doc.addPage(); y = 20; }
                    
                    doc.setFillColor(248, 250, 252);
                    doc.rect(20, y-5, 170, 8, 'F');
                    doc.setFontSize(10); 
                    doc.setFont("helvetica", "bold"); 
                    doc.setTextColor(59, 130, 246);
                    doc.text(`Q${i+1}: ${q.topic}`, 22, y);
                    
                    if (q.grading?.correct) {
                        doc.setTextColor(16, 185, 129);
                    } else {
                        doc.setTextColor(239, 68, 68);
                    }
                    doc.text(`${q.grading?.mark}/${q.marks}`, 180, y, null, null, "right");
                    y += 8;
                    
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(0);
                    const cleanQ = q.text.replace(/\$/g, '').replace(/\\/g, '');
                    const splitQ = doc.splitTextToSize(cleanQ, 165);
                    doc.text(splitQ, 22, y);
                    y += (splitQ.length * 5) + 4;
                    
                    doc.setFontSize(9);
                    doc.setTextColor(100);
                    const feedback = `Feedback: ${q.grading?.feedback?.positives || '-'} | Improve: ${q.grading?.feedback?.negatives || '-'}`;
                    const splitFeed = doc.splitTextToSize(feedback, 165);
                    doc.text(splitFeed, 22, y);
                    y += (splitFeed.length * 5) + 10;
                });
                
                doc.save(`ATAR_Report_${user.name}.pdf`);
            };

            return (
                <div className="flex-1 flex flex-col items-center justify-center p-6 bg-[#020617] relative overflow-hidden">
                    <div className="absolute inset-0 bg-blue-900/10 blur-[100px] pointer-events-none"></div>
                    <div className="w-full max-w-2xl glass-panel p-10 rounded-3xl text-center shadow-2xl relative z-10 animate-slide-up">
                        <h2 className="text-xs font-bold tracking-[0.3em] text-slate-400 mb-6 uppercase">Session Concluded</h2>
                        <div className="text-8xl font-black text-white tracking-tighter mb-2">{percentage}%</div>
                        <div className="text-slate-400 text-sm font-bold mb-10">{score} / {total} POINTS</div>
                        <div className="text-slate-500 font-mono text-xs mb-8">â± Time: {formatTime(timer)}</div>
                        <div className="flex gap-4 justify-center">
                            <button onClick={downloadPDF} className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 rounded-xl transition-all hover:scale-105 shadow-xl shadow-blue-900/30 active:scale-95">DOWNLOAD PDF</button>
                            <button onClick={onRestart} className="bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 px-10 rounded-xl transition-all active:scale-95">NEW TEST</button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
