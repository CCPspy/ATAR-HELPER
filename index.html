<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ATAR HELPER</title>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        glass: "rgba(15, 23, 42, 0.9)",
                        glassBorder: "rgba(255, 255, 255, 0.08)",
                        primary: "#3b82f6",
                        premiumBg: "#020617"
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-in-right': 'slideInRight 0.3s ease-out forwards',
                        'slide-up-reveal': 'slideUpReveal 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        slideInRight: { '0%': { transform: 'translateX(20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        slideUpReveal: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    
    <!-- PDF & Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow: hidden; }
        
        .glass-panel { 
            background: rgba(15, 23, 42, 0.85); 
            backdrop-filter: blur(24px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .glass-input { 
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid rgba(255,255,255,0.08); 
            color: white; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .glass-input:focus { outline: none; border-color: #3b82f6; background: rgba(0, 0, 0, 0.7); box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3); }

        .custom-select-wrapper { position: relative; }
        .custom-select-wrapper::after { content: "‚ñº"; font-size: 0.6rem; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; }
        select { appearance: none; -webkit-appearance: none; }
        select option { background-color: #0f172a; color: white; padding: 12px; }
        
        .katex-display { margin: 0.5em 0; overflow-x: auto; overflow-y: hidden; }
        canvas { touch-action: none; cursor: crosshair; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        
        .spin-border {
            border: 2px solid transparent;
            border-top-color: #3b82f6;
            border-right-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { createRoot } = ReactDOM;
        
        // --- CONSTANTS ---
        const GEMINI_MODELS = [
            "gemini-2.5-flash", 
            "gemini-2.5-flash-lite", 
            "gemini-2.0-flash",
            "gemini-2.0-flash-lite"
        ];
        
        const SUBJECT_DATA = {
            "Methods": ["Calculus", "Functions & Graphs", "Probability", "Statistics", "Integrals", "Trigonometry"],
            "Specialist": ["Vectors", "Complex Numbers", "Matrices", "Dynamics", "Combinatorics", "Differential Equations"],
            "Physics": ["Linear Motion", "Forces & Dynamics", "Gravity", "Electromagnetism", "Quantum Theory", "Special Relativity"],
            "Chemistry": ["Atomic Structure", "Chemical Bonding", "Equilibrium", "Acids & Bases", "Redox Reactions", "Organic Chemistry"]
        };
        const LEVELS = ["Year 11", "Year 12"];

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- UTILS ---
        const decodeKey = (str) => {
            if (!str) return null;
            try {
                const trimmed = str.trim();
                if (trimmed.startsWith("AIza")) return trimmed;
                const decoded = atob(trimmed);
                if (decoded && decoded.includes("AIza")) return decoded.trim();
                return null;
            } catch { return null; }
        };

        const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;

        const LatexRenderer = ({ text }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (!containerRef.current || !text) return;
                containerRef.current.innerHTML = '';
                const parts = text.split(/(\$[^$]+\$)/g);
                parts.forEach(part => {
                    if (part.startsWith('$') && part.endsWith('$')) { 
                        const span = document.createElement('span');
                        try { katex.render(part.slice(1, -1), span, { throwOnError: false, displayMode: false }); } catch { span.innerText = part; }
                        containerRef.current.appendChild(span);
                    } else if (part.length > 0) {
                        const span = document.createElement('span');
                        span.innerText = part;
                        containerRef.current.appendChild(span);
                    }
                });
            }, [text]);
            return <span ref={containerRef} className="latex-content" />;
        };

        const generateOfflineQuestion = (subject) => {
            const marks = Math.floor(Math.random() * 3) + 2;
            return { 
                text: `(Offline) Differentiate $f(x) = 5x^3 - 2x$.`, 
                answer: `$f'(x) = 15x^2 - 2$`, 
                marks: marks, 
                topic: "Calculus", 
                hint: "Power Rule" 
            };
        };

        // --- AI ENGINE CORE ---
        const AI_ENGINE = {
            callGemini: async (payload, apiKey) => {
                for (const model of GEMINI_MODELS) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.status === 429) continue; 
                        if (!response.ok) throw new Error(response.statusText);
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    } catch (e) { console.warn(`Model ${model} failed`, e); continue; }
                }
                throw new Error("All Gemini models unavailable.");
            }
        };

        // --- APP COMPONENT ---
        const App = () => {
            const [view, setView] = useState("GATEWAY"); 
            const [user, setUser] = useState({ name: "", apiKey: "" });
            const [config, setConfig] = useState({ 
                subject: "Methods", level: "Year 12", studyMode: "full", 
                selectedTopics: [], count: 5, extraPrompt: "", customMaterials: "" 
            });
            const [contextData, setContextData] = useState("");
            const [contextStatus, setContextStatus] = useState("idle"); 
            const [loadingState, setLoadingState] = useState({ active: false, msg: "", time: 0 });
            const [questions, setQuestions] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [generating, setGenerating] = useState(false);
            const generationPaused = useRef(false);
            const [timer, setTimer] = useState(0); 
            const [initialMessages, setInitialMessages] = useState([]);

            useEffect(() => {
                const handleBeforeUnload = (e) => { if (view === "ARENA") { e.preventDefault(); e.returnValue = ''; return ''; } };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [view]);

            useEffect(() => {
                let interval;
                if (view === "ARENA") interval = setInterval(() => setTimer(t => t + 1), 1000);
                return () => clearInterval(interval);
            }, [view]);

            // Load Keys
            useEffect(() => {
                fetch('GE.txt').then(r => r.ok ? r.text() : Promise.reject()).then(txt => {
                    const lines = txt.split(/[\r\n]+/);
                    for (const line of lines) {
                        const k = decodeKey(line);
                        if (k) { setUser(u => ({ ...u, apiKey: k })); break; }
                    }
                }).catch(() => console.log("No GE.txt"));
            }, []);

            // PDF Upload
            const handleFileUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                setLoadingState({ active: true, msg: "Reading Materials...", time: 0 });
                let extractedText = "";
                for (const file of files) {
                    try {
                        const buffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(buffer).promise;
                        for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) {
                            const page = await pdf.getPage(i);
                            extractedText += (await page.getTextContent()).items.map(s => s.str).join(' ') + "\n";
                        }
                    } catch (err) { console.error(err); }
                }
                setConfig(p => ({ ...p, customMaterials: extractedText }));
                setLoadingState({ active: false, msg: "", time: 0 });
            };

            // RAG Load
            const loadSubjectContext = async () => {
                if (!user.apiKey) { setContextStatus("offline"); startSession(); return; }
                setLoadingState({ active: true, msg: "SCANNING DATABASE..." });
                let fullText = "";
                let i = 1, fails = 0;
                while (fails < 2 && i < 20) {
                    try {
                        const url = `data/${config.subject}/${config.level}/${i}.pdf`;
                        const head = await fetch(url, { method: 'HEAD' });
                        if (!head.ok) throw new Error();
                        const pdf = await pdfjsLib.getDocument(url).promise;
                        for (let p = 1; p <= Math.min(pdf.numPages, 4); p++) {
                            fullText += (await pdf.getPage(p).then(page => page.getTextContent())).items.map(s => s.str).join(' ');
                        }
                        i++;
                    } catch { fails++; i++; }
                }
                setContextData(fullText.substring(0, 15000));
                setContextStatus("ready");
                setLoadingState({ active: false, msg: "" });
                startSession();
            };

            // Generation Engine
            const generateQuestion = async () => {
                if (generationPaused.current) return;
                setGenerating(true);

                const updateQ = (idx, q) => setQuestions(p => { const n=[...p]; n[idx]={...q, id:Date.now(), status:'ready', userAnswer:'', grading:null}; return n; });

                // Init Sequence
                if (questions.length === 0) {
                    setQuestions(Array(config.count).fill({ status: 'generating', text: 'Generating...', topic: 'Loading' }));
                    setLoadingState({ active: true, msg: "INITIALIZING SESSION..." });
                    
                    const makeQ = async () => {
                        if (!user.apiKey) return generateOfflineQuestion(config.subject);
                        try { return await fetchQuestionAI(); } catch { return generateOfflineQuestion(config.subject); }
                    };

                    // Generate Buffer (Q1 + Q2)
                    const q1 = await makeQ();
                    updateQ(0, q1);
                    
                    if (config.count > 1) {
                        const q2 = await makeQ();
                        updateQ(1, q2);
                    }

                    // Greeting
                    let msg = `Hello ${user.name}, good luck with ${config.subject}!`;
                    if (config.extraPrompt) msg += " I've noted your extra instructions.";
                    if (config.customMaterials) msg += " Materials loaded.";
                    setInitialMessages([{ role: 'ai', text: msg }]);

                    setLoadingState({ active: false, msg: "" });
                    setView("ARENA");
                    setGenerating(false);
                    return;
                }

                // Background Loop
                const nextIdx = questions.findIndex(q => q.status === 'generating');
                if (nextIdx !== -1) {
                    // Check Pause
                    while (generationPaused.current) await new Promise(r => setTimeout(r, 1000));
                    
                    let q;
                    if (!user.apiKey) q = generateOfflineQuestion(config.subject);
                    else {
                        try { q = await fetchQuestionAI(); } catch { q = generateOfflineQuestion(config.subject); }
                    }
                    updateQ(nextIdx, q);
                }
                setGenerating(false);
            };

            const fetchQuestionAI = async () => {
                const materials = config.customMaterials ? `USER MATERIALS: ${config.customMaterials.substring(0,5000)}` : "";
                const extra = config.extraPrompt ? `INSTRUCTIONS: ${config.extraPrompt}` : "";
                const prompt = `Role: ATAR Exam Writer. Subject: ${config.subject}. Context: ${contextData}. ${materials} ${extra}. Task: Generate 1 unique, complex, multi-step challenging question. Output JSON: { "text": "LaTeX $...$", "topic": "str", "answer": "LaTeX $...$", "hint": "str", "marks": int (4-7) }`;
                const json = await AI_ENGINE.callGemini({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }, user.apiKey);
                return JSON.parse(json);
            };

            useEffect(() => {
                if (view === "ARENA" && !generating) {
                    const pending = questions.filter(q => q.status === 'generating').length;
                    if (pending > 0) generateQuestion();
                }
            }, [questions, view, generating]);

            const startSession = () => { setTimer(0); generateQuestion(); };

            // Views
            if (view === "GATEWAY") return (
                <div className="h-screen w-full flex items-center justify-center p-6 bg-[#020617] relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-full h-full bg-[radial-gradient(circle_at_50%_50%,rgba(59,130,246,0.1),transparent_70%)]"></div>
                    <div className="glass-panel p-12 rounded-3xl w-full max-w-md flex flex-col items-center animate-slide-up z-10">
                        <h1 className="text-5xl font-black bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent mb-8">ATAR HELPER</h1>
                        <input className="glass-input w-full p-4 rounded-xl text-center font-bold text-lg mb-4" placeholder="ENTER SURNAME" value={user.name} onChange={e=>setUser({...user, name: e.target.value.toUpperCase()})} onKeyDown={e=>e.key==='Enter' && user.name && setView("CONFIG")} />
                        <button onClick={()=>user.name && setView("CONFIG")} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transition-transform hover:-translate-y-1">INITIALIZE</button>
                    </div>
                </div>
            );

            if (view === "CONFIG") return (
                <div className="h-screen w-full flex items-center justify-center p-6 bg-[#020617]">
                    <div className="glass-panel p-8 rounded-3xl w-full max-w-5xl h-[85vh] flex flex-col animate-slide-up">
                        <div className="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                            <h2 className="text-xl font-bold tracking-widest text-white">CONFIGURATION</h2>
                            <span className="bg-white/10 px-3 py-1 rounded-full text-xs text-slate-300">{user.name}</span>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 flex-1 overflow-y-auto pr-2 custom-scrollbar">
                            <div className="space-y-6">
                                <h3 className="text-xs font-bold text-blue-400 uppercase">Core</h3>
                                <div className="custom-select-wrapper">
                                    <label className="text-[10px] uppercase font-bold text-slate-500">Subject</label>
                                    <select className="w-full glass-input p-3 rounded-lg mt-1" value={config.subject} onChange={e=>setConfig({...config, subject:e.target.value})}>{Object.keys(SUBJECT_DATA).map(s=><option key={s} value={s}>{s}</option>)}</select>
                                </div>
                                <div className="custom-select-wrapper">
                                    <label className="text-[10px] uppercase font-bold text-slate-500">Level</label>
                                    <select className="w-full glass-input p-3 rounded-lg mt-1" value={config.level} onChange={e=>setConfig({...config, level:e.target.value})}>{LEVELS.map(l=><option key={l} value={l}>{l}</option>)}</select>
                                </div>
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500">Count: {config.count}</label>
                                    <input type="range" min="1" max="10" className="w-full mt-2" value={config.count} onChange={e=>setConfig({...config, count: parseInt(e.target.value)})}/>
                                </div>
                            </div>
                            <div className="space-y-6">
                                <h3 className="text-xs font-bold text-blue-400 uppercase">Focus</h3>
                                <div className="flex bg-black/20 rounded-lg p-1">
                                    <button onClick={()=>setConfig({...config, studyMode:'full'})} className={`flex-1 py-2 rounded text-xs font-bold ${config.studyMode==='full'?'bg-blue-600 text-white':'text-slate-500'}`}>Comprehensive</button>
                                    <button onClick={()=>setConfig({...config, studyMode:'targeted'})} className={`flex-1 py-2 rounded text-xs font-bold ${config.studyMode==='targeted'?'bg-blue-600 text-white':'text-slate-500'}`}>Targeted</button>
                                </div>
                                {config.studyMode === 'targeted' && <div className="text-xs text-center p-4 border border-dashed border-white/10 rounded-lg text-slate-500">Topic selection enabled.</div>}
                            </div>
                            <div className="space-y-6">
                                <h3 className="text-xs font-bold text-blue-400 uppercase">Customization</h3>
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500">Extra Prompts</label>
                                    <textarea className="w-full glass-input p-3 rounded-lg text-xs h-24 resize-none mt-1 focus:outline-none" placeholder="E.g. 'Be strict', 'Focus on algebraic proofs'..." value={config.extraPrompt} onChange={e=>setConfig({...config, extraPrompt: e.target.value})}></textarea>
                                </div>
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-500">Materials</label>
                                    <div className="relative border border-dashed border-white/20 rounded-lg h-24 flex flex-col items-center justify-center hover:bg-white/5 transition-colors mt-1 group">
                                        <input type="file" accept=".pdf" multiple className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFileUpload} />
                                        <span className="text-2xl mb-1 group-hover:scale-110 transition-transform">üìÑ</span>
                                        <span className="text-[10px] text-slate-500">{config.customMaterials ? "Materials Loaded" : "Upload PDFs"}</span>
                                    </div>
                                </div>
                                {!user.apiKey && (
                                    <div>
                                        <label className="text-[10px] uppercase font-bold text-slate-500">API Override</label>
                                        <input type="password" value={user.apiKey} onChange={e=>setUser({...user, apiKey: e.target.value})} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="w-full glass-input p-2 rounded text-xs mt-1" />
                                    </div>
                                )}
                            </div>
                        </div>
                        <button onClick={loadSubjectContext} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg mt-6 active:scale-[0.98] transition-transform">START SESSION</button>
                    </div>
                    {loadingState.active && (
                        <div className="absolute inset-0 z-50 bg-[#020617] flex flex-col items-center justify-center p-8 backdrop-blur-xl">
                            <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <div className="text-xl font-bold tracking-widest text-blue-400 animate-pulse">{loadingState.msg}</div>
                        </div>
                    )}
                </div>
            );

            if (view === "ARENA") return <Arena 
                key={currentQIndex} // Force reset components on Q change
                question={questions[currentQIndex]} 
                questions={questions} 
                index={currentQIndex} 
                total={config.count} 
                onNext={() => setCurrentQIndex(i => Math.min(i+1, config.count-1))}
                onFinish={() => setView("DEBRIEF")}
                onUpdateQuestion={(q) => {
                    const n = [...questions]; n[currentQIndex] = q; setQuestions(n);
                }}
                user={user} subject={config.subject} pauseGen={generationPaused} contextStatus={contextStatus} timer={timer} initialMessages={initialMessages}
            />;

            if (view === "DEBRIEF") return <Debrief questions={questions} user={user} config={config} timer={timer} onRestart={()=>window.location.reload()} />;
        };

        const Arena = ({ question, questions, index, total, onNext, onFinish, onUpdateQuestion, user, subject, pauseGen, contextStatus, timer, initialMessages }) => {
            const canvasRef = useRef(null);
            const ctxRef = useRef(null);
            const [input, setInput] = useState("");
            const [messages, setMessages] = useState(initialMessages);
            const [chatInput, setChatInput] = useState("");
            const [penColor, setPenColor] = useState("#ffffff");
            const [isEraser, setIsEraser] = useState(false);
            const [showTools, setShowTools] = useState(false);
            const [showGiveUp, setShowGiveUp] = useState(false);
            const [showClear, setShowClear] = useState(false);
            const [sidebarTab, setSidebarTab] = useState("tutor");
            const [isProcessing, setIsProcessing] = useState(false);
            const inputRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                const parent = canvas.parentElement;
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;
                const ctx = canvas.getContext('2d');
                ctx.lineCap = "round"; ctx.lineJoin = "round";
                ctx.strokeStyle = "#ffffff"; ctx.lineWidth = 3;
                ctxRef.current = ctx;
            }, []); // Run once on mount (key forces remount)

            useEffect(() => {
                if (ctxRef.current) {
                    ctxRef.current.strokeStyle = isEraser ? "#020617" : penColor;
                    ctxRef.current.lineWidth = isEraser ? 30 : 3;
                }
            }, [penColor, isEraser]);

            const draw = (e) => {
                if (e.buttons !== 1) return;
                const r = canvasRef.current.getBoundingClientRect();
                ctxRef.current.lineTo(e.clientX - r.left, e.clientY - r.top);
                ctxRef.current.stroke();
                ctxRef.current.beginPath();
                ctxRef.current.moveTo(e.clientX - r.left, e.clientY - r.top);
            };
            const startDraw = (e) => {
                const r = canvasRef.current.getBoundingClientRect();
                ctxRef.current.beginPath();
                ctxRef.current.moveTo(e.clientX - r.left, e.clientY - r.top);
            };

            const interact = async (action) => {
                pauseGen.current = true;
                setIsProcessing(true);
                await action();
                setIsProcessing(false);
                pauseGen.current = false;
            };

            const submit = () => interact(async () => {
                const img = canvasRef.current.toDataURL("image/png").split(',')[1];
                const prompt = `Role: Examiner. Q: ${question.text}. Ans: ${question.answer}. Student: ${input}. Marks: ${question.marks}. Task: Grade. Check working in image. Award partial marks for method. Strict. JSON ONLY: {"mark":int, "correct":bool, "feedback":{"positives":"str","negatives":"str","improvements":"str"}}`;
                let res;
                if (!user.apiKey) res = { mark: 0, correct: false, feedback: { positives: "Offline", negatives: "No API Key", improvements: "N/A" } };
                else {
                    try {
                        const txt = await AI_ENGINE.callGemini({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: img } }] }], generationConfig: { responseMimeType: "application/json" } }, user.apiKey);
                        res = JSON.parse(txt);
                    } catch { res = { mark: 0, feedback: { positives: "Error", negatives: "AI Failed", improvements: "Try again" } }; }
                }
                onUpdateQuestion({ ...question, status: 'graded', userAnswer: input, mark: res.mark, feedback: res.feedback });
                setSidebarTab("results");
                document.getElementById('sidebar').classList.remove('translate-x-full');
            });

            const ask = () => interact(async () => {
                if (!chatInput) return;
                const msg = chatInput;
                setMessages(p => [...p, { role: 'user', text: msg }]);
                setChatInput("");
                let reply;
                if (!user.apiKey) reply = "Offline mode.";
                else {
                    try {
                        const prompt = `System: Tutor. Q: ${question.text}. Ans: ${question.answer}. User: ${msg}. Reply concisely using LaTeX $...$.`;
                        const txt = await AI_ENGINE.callGemini({ contents: [{ parts: [{ text: prompt }] }] }, user.apiKey);
                        reply = txt;
                    } catch { reply = "Error connecting."; }
                }
                setMessages(p => [...p, { role: 'ai', text: reply }]);
            });

            const evaluate = () => interact(async () => {
                const img = canvasRef.current.toDataURL("image/png").split(',')[1];
                setMessages(p => [...p, { role: 'ai', text: "Checking working..." }]);
                let reply;
                if (!user.apiKey) reply = "Offline mode.";
                else {
                    try {
                        const prompt = `Teacher Task: Check student working image. Q: ${question.text}. Ans: ${question.answer}. Give 1 sentence hint.`;
                        const txt = await AI_ENGINE.callGemini({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: img } }] }] }, user.apiKey);
                        reply = txt;
                    } catch { reply = "Error analyzing."; }
                }
                setMessages(p => [...p, { role: 'ai', text: reply }]);
            });

            const surrender = () => interact(async () => {
                setShowGiveUp(false);
                let reply;
                if (!user.apiKey) reply = `Answer: ${question.answer}`;
                else {
                    try {
                        const prompt = `User surrendered. Q: ${question.text}. Ans: ${question.answer}. Provide full solution steps.`;
                        const txt = await AI_ENGINE.callGemini({ contents: [{ parts: [{ text: prompt }] }] }, user.apiKey);
                        reply = txt;
                    } catch { reply = `Answer: ${question.answer}`; }
                }
                onUpdateQuestion({ ...question, status: 'graded', userAnswer: "Surrendered", mark: 0, feedback: { positives: "N/A", negatives: "Surrendered", improvements: reply } });
                setSidebarTab("results");
                document.getElementById('sidebar').classList.remove('translate-x-full');
            });

            const insertMath = (s) => {
                const i = inputRef.current;
                const v = input;
                const p = i.selectionStart;
                setInput(v.slice(0, p) + s + v.slice(p));
                setTimeout(() => i.focus(), 0);
            };

            return (
                <div className="h-screen w-full flex bg-[#020617] overflow-hidden relative">
                    {/* Sidebar Nav */}
                    <div className="w-20 glass-panel border-r border-white/5 flex flex-col items-center py-6 gap-4 z-20 shadow-xl">
                        <div className={`w-3 h-3 rounded-full shadow-[0_0_10px] ${user.apiKey ? 'bg-emerald-500 shadow-emerald-500' : 'bg-amber-500 shadow-amber-500'}`}></div>
                        <span className={`text-[9px] font-bold text-center tracking-wide ${user.apiKey ? 'text-emerald-500' : 'text-amber-500'}`}>{user.apiKey ? "ONLINE" : "LIMITED"}</span>
                        <div className="flex-1 overflow-y-auto w-full flex flex-col items-center gap-3 custom-scrollbar py-2">
                            {questions.map((q, i) => (
                                <button key={i} disabled={q.status==='generating'} onClick={()=>{if(q.status!=='generating' && i < index+2) onUpdateQuestion(questions[i]);}} 
                                    className={`w-10 h-10 rounded-xl flex items-center justify-center font-bold text-xs transition-all ${i===index ? 'bg-blue-600 text-white scale-110 shadow-lg' : 'bg-slate-800 text-slate-500'} ${q.status==='generating'?'spin-border text-transparent':''} ${q.status==='graded'?(q.mark>0?'border-2 border-emerald-500':'border-2 border-red-500'):''}`}>
                                    {i+1}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Canvas Area */}
                    <div className="flex-1 relative cursor-crosshair">
                        <canvas ref={canvasRef} onMouseDown={startDraw} onMouseMove={draw} className="absolute inset-0 z-0" />
                        
                        {/* Toolbar */}
                        <div className="absolute top-6 left-1/2 -translate-x-1/2 glass-panel px-6 py-3 rounded-full flex items-center gap-6 z-10 shadow-2xl">
                            <button onClick={()=>setIsEraser(false)} className={`transition ${!isEraser?'text-blue-400':'text-slate-400'}`}>‚úé</button>
                            <button onClick={()=>setIsEraser(true)} className={`transition ${isEraser?'text-blue-400':'text-slate-400'}`}>‚å´</button>
                            <input type="color" value={penColor} onChange={e=>setPenColor(e.target.value)} className="w-5 h-5 bg-transparent border-none rounded-full cursor-pointer" />
                            <div className="w-px h-4 bg-white/20"></div>
                            <button onClick={()=>setShowClear(true)} className="text-red-400 text-xs font-bold hover:text-red-300">CLEAR</button>
                            <div className="w-px h-4 bg-white/20"></div>
                            <span className="text-white font-mono text-xs">‚è± {formatTime(timer)}</span>
                        </div>

                        {/* Question */}
                        <div className="absolute top-6 left-6 max-w-sm glass-panel p-6 rounded-2xl border-l-4 border-blue-500 text-white z-10 select-none pointer-events-none">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-[10px] font-bold text-blue-400 uppercase tracking-widest">{question.topic}</span>
                                <span className="bg-white/10 px-2 py-1 rounded text-[10px] text-slate-300">{question.marks} Marks</span>
                            </div>
                            <div className="text-lg font-medium leading-relaxed pointer-events-auto"><LatexRenderer text={question.text} /></div>
                        </div>

                        {/* Input */}
                        {question.status !== 'graded' ? (
                            <div className="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-black via-black/80 to-transparent z-20 flex gap-4 justify-center items-end">
                                <div className="flex-1 max-w-xl relative group">
                                    <div className={`absolute bottom-full mb-2 glass-panel p-2 rounded-xl flex flex-wrap gap-1 w-full justify-center transition-all origin-bottom duration-300 ${showTools ? 'opacity-100 scale-100' : 'opacity-0 scale-95 pointer-events-none'}`}>
                                        <div className="w-full flex justify-end"><button onClick={()=>setShowTools(false)} className="text-[10px] text-slate-400 hover:text-white px-2">‚ñº</button></div>
                                        {['x^2','\\sqrt{x}','\\frac{a}{b}','\\pi','\\theta','\\int','\\le','\\ge','\\approx'].map(s=><button key={s} onClick={()=>insertMath(s)} className="px-3 py-2 bg-white/5 hover:bg-white/10 rounded text-xs font-mono text-blue-300 min-w-[2.5rem]"><LatexRenderer text={`$${s}$`}/></button>)}
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="flex gap-2">
                                            <button onClick={()=>setShowGiveUp(true)} className="w-24 bg-red-900/40 border border-red-500/20 text-red-300 hover:bg-red-900/60 font-bold rounded-xl text-[10px] uppercase tracking-wider transition-colors">GIVE UP</button>
                                            <button onClick={submit} disabled={isProcessing} className="w-24 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/40 disabled:opacity-50 text-[10px] uppercase tracking-wider">{isProcessing?"...":"SUBMIT"}</button>
                                        </div>
                                        <div className="relative flex-1">
                                            <input ref={inputRef} value={input} onChange={e=>setInput(e.target.value)} onFocus={()=>setShowTools(true)} placeholder="Type Answer..." className="w-full h-full glass-input pl-4 pr-10 rounded-xl font-mono text-lg shadow-xl" onKeyDown={e=>e.key==='Enter'&&submit()} />
                                            <button onClick={()=>setShowTools(!showTools)} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white">‚å®Ô∏è</button>
                                        </div>
                                        <button onClick={()=>document.getElementById('sidebar').classList.toggle('translate-x-full')} className="bg-slate-700 p-4 rounded-xl text-white shadow-lg md:hidden">?</button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="absolute bottom-10 left-1/2 -translate-x-1/2 glass-panel p-6 rounded-2xl flex gap-6 animate-slide-up z-20 items-center">
                                <div className="text-center border-r border-white/10 pr-6">
                                    <div className={`text-4xl font-black ${question.mark>0?'text-emerald-400':'text-red-400'}`}>{question.mark}/{question.marks}</div>
                                    <div className="text-[10px] text-slate-500 uppercase tracking-widest">Score</div>
                                </div>
                                {index < total - 1 ? (
                                    <button onClick={onNext} disabled={questions[index+1]?.status==='generating'} className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                                        {questions[index+1]?.status==='generating' ? 'GENERATING...' : 'NEXT QUESTION'}
                                    </button>
                                ) : (
                                    <button onClick={onFinish} className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition-transform active:scale-95">FINISH TEST</button>
                                )}
                            </div>
                        )}

                        {/* Modals */}
                        {(showClear || showGiveUp) && (
                            <div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in">
                                <div className="glass-panel p-8 rounded-2xl text-center max-w-sm w-full shadow-2xl">
                                    <h3 className="text-xl font-bold text-white mb-2">{showClear ? "Clear Board?" : "Surrender?"}</h3>
                                    <p className="text-slate-400 text-sm mb-6">{showClear ? "Cannot be undone." : "0 Marks. AI reveals solution."}</p>
                                    <div className="flex gap-4">
                                        <button onClick={()=>{setShowClear(false); setShowGiveUp(false)}} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold">Cancel</button>
                                        <button onClick={()=>{ if(showClear){ ctxRef.current.clearRect(0,0,canvasRef.current.width,canvasRef.current.height); setShowClear(false); } else surrender(); }} className="flex-1 bg-red-600 hover:bg-red-500 text-white py-3 rounded-xl font-bold">Confirm</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* AI Sidebar */}
                    <div id="sidebar" className="w-96 glass-panel border-l border-white/5 transform translate-x-full md:translate-x-0 transition-transform duration-300 z-30 flex flex-col absolute right-0 top-0 bottom-0 md:static backdrop-blur-2xl shadow-2xl">
                        <div className="flex border-b border-white/10">
                            <button onClick={()=>setSidebarTab('tutor')} className={`flex-1 py-4 text-xs font-bold tracking-widest uppercase transition-colors ${sidebarTab==='tutor'?'text-blue-400 border-b-2 border-blue-400 bg-blue-500/10':'text-slate-500 hover:text-slate-300'}`}>Tutor</button>
                            <button onClick={()=>setSidebarTab('results')} className={`flex-1 py-4 text-xs font-bold tracking-widest uppercase transition-colors ${sidebarTab==='results'?'text-emerald-400 border-b-2 border-emerald-400 bg-emerald-500/10':'text-slate-500 hover:text-slate-300'}`}>Results</button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                            {sidebarTab === 'tutor' ? (
                                <>
                                    {messages.map((m,i)=>(<div key={i} className={`p-3 rounded-xl text-sm border ${m.role==='user'?'bg-blue-600/20 ml-4 border-blue-500/20 text-blue-100':'bg-white/5 mr-4 border-white/10 text-slate-300'}`}><LatexRenderer text={m.text}/></div>))}
                                </>
                            ) : (
                                question.status === 'graded' ? (
                                    <div className="space-y-4 animate-slide-in-right">
                                        <div className="bg-emerald-900/10 border-l-2 border-emerald-500 p-4 rounded-r-xl"><div className="text-xs font-bold text-emerald-400 uppercase mb-1">Positives</div><p className="text-sm text-emerald-100/70 leading-relaxed"><LatexRenderer text={question.feedback?.positives}/></p></div>
                                        <div className="bg-red-900/10 border-l-2 border-red-500 p-4 rounded-r-xl"><div className="text-xs font-bold text-red-400 uppercase mb-1">Improvements / Solution</div><p className="text-sm text-red-100/70 leading-relaxed"><LatexRenderer text={question.feedback?.negatives || question.feedback?.improvements}/></p></div>
                                    </div>
                                ) : <div className="text-center text-slate-600 mt-20 text-xs flex flex-col items-center"><span className="text-3xl mb-2 opacity-30">üìä</span>Submit to see results.</div>
                            )}
                        </div>

                        {sidebarTab === 'tutor' && (
                            <div className="p-4 border-t border-white/10 bg-black/20 space-y-3">
                                <button onClick={evaluate} disabled={isProcessing} className="w-full py-3 border border-white/10 rounded-xl text-xs font-bold text-slate-300 hover:bg-white/5 transition-colors disabled:opacity-50">üëÅ CHECK WORKING</button>
                                <div className="flex gap-2">
                                    <input value={chatInput} onChange={e=>setChatInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&ask()} placeholder="Ask for a hint..." className="flex-1 glass-input rounded-xl px-4 py-3 text-xs" />
                                    <button onClick={ask} className="bg-blue-600 p-3 rounded-xl text-white hover:bg-blue-500 transition-colors">‚û§</button>
                                </div>
                            </div>
                        )}
                    </div>
                    <button onClick={()=>document.getElementById('sidebar').classList.toggle('translate-x-full')} className="fixed top-1/2 right-0 transform -translate-y-1/2 bg-blue-600 text-white p-2 rounded-l-xl shadow-lg z-40 md:hidden">‚óÄ</button>
                </div>
            );
        };

        const Debrief = ({ questions, user, config, timer, onRestart }) => {
            const total = questions.reduce((a,q)=>a+(q.marks||0),0);
            const score = questions.reduce((a,q)=>a+(q.mark||0),0);
            const pct = Math.round((score/total)*100) || 0;

            const downloadPDF = () => {
                const doc = new jsPDF();
                doc.setFillColor(15, 23, 42); doc.rect(0,0,210,40,'F');
                doc.setTextColor(255); doc.setFontSize(22); doc.setFont("helvetica","bold"); doc.text("ATAR HELPER REPORT",20,25);
                doc.setTextColor(0); doc.setFontSize(11); doc.setFont("helvetica","normal");
                doc.text(`Student: ${user.name}`,20,55); doc.text(`Subject: ${config.subject}`,20,62); doc.text(`Time: ${formatTime(timer)}`,20,69);
                doc.setFillColor(240); doc.rect(150,50,40,25,'F'); doc.setFontSize(16); doc.setFont("helvetica","bold"); doc.text(`${pct}%`,170,62,null,null,"center"); doc.setFontSize(9); doc.text(`${score}/${total}`,170,70,null,null,"center");
                
                let y=90;
                questions.forEach((q,i)=>{
                    if(y>250){doc.addPage();y=20;}
                    doc.setFillColor(245); doc.rect(20,y-6,170,10,'F');
                    doc.setFontSize(10); doc.setFont("helvetica","bold"); doc.setTextColor(59,130,246); doc.text(`Q${i+1} (${q.mark}/${q.marks})`,22,y);
                    y+=10;
                    doc.setFont("helvetica","normal"); doc.setTextColor(50);
                    const txt = doc.splitTextToSize(q.text.replace(/\$|\\/g,''),165); doc.text(txt,22,y); y+=txt.length*5+5;
                    doc.setFontSize(9); doc.setTextColor(100);
                    const fb = `Feedback: ${q.feedback?.positives || '-'} | Improve: ${q.feedback?.negatives || '-'}`;
                    const fbt = doc.splitTextToSize(fb,165); doc.text(fbt,22,y); y+=fbt.length*5+10;
                });
                doc.save(`Report_${user.name}.pdf`);
            };

            return (
                <div className="h-screen w-full flex items-center justify-center p-6 bg-[#020617] relative overflow-hidden">
                    <div className="absolute inset-0 bg-blue-900/10 blur-[100px]"></div>
                    <div className="glass-panel p-12 rounded-3xl text-center shadow-2xl relative z-10 animate-slide-up max-w-2xl w-full">
                        <h2 className="text-sm font-bold tracking-[0.3em] text-slate-400 mb-8 uppercase">SESSION COMPLETE</h2>
                        <div className="text-8xl font-black text-white tracking-tighter mb-4">{pct}%</div>
                        <div className="text-slate-400 text-lg font-bold mb-2">{score} / {total} POINTS</div>
                        <div className="text-slate-500 font-mono text-sm mb-12">‚è± Time Taken: {formatTime(timer)}</div>
                        <div className="flex gap-4 justify-center">
                            <button onClick={downloadPDF} className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 rounded-xl transition-all hover:scale-105 shadow-xl shadow-blue-900/30 active:scale-95">DOWNLOAD PDF</button>
                            <button onClick={onRestart} className="bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 px-10 rounded-xl transition-all active:scale-95">NEW TEST</button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
