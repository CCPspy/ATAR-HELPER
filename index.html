<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ATAR HELPER</title>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        glass: "rgba(15, 23, 42, 0.9)",
                        glassBorder: "rgba(255, 255, 255, 0.08)",
                        primary: "#3b82f6",
                        premiumBg: "#020617"
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'spin-slow': 'spin 2s linear infinite',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    
    <!-- PDF & Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow: hidden; }
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5); }
        .glass-input { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255,255,255,0.08); color: white; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-input:focus { outline: none; border-color: #3b82f6; background: rgba(0, 0, 0, 0.7); box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        canvas { touch-action: none; cursor: crosshair; }
        .spin-border { border: 2px solid transparent; border-top-color: #3b82f6; border-right-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Custom Select */
        select { appearance: none; -webkit-appearance: none; background-color: #0f172a; color: white; padding: 12px; }
        .custom-select-wrapper::after { content: "‚ñº"; font-size: 0.6rem; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; }
        .latex-content .katex { font-size: 1.1em; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { createRoot } = ReactDOM;
        
        // --- DATA CONSTANTS ---
        const SUBJECT_DATA = {
            "Methods": ["Calculus", "Functions & Graphs", "Probability", "Statistics", "Integrals", "Trigonometry"],
            "Specialist": ["Vectors", "Complex Numbers", "Matrices", "Dynamics", "Combinatorics", "Differential Equations"],
            "Physics": ["Linear Motion", "Forces & Dynamics", "Gravity", "Electromagnetism", "Quantum Theory", "Special Relativity"],
            "Chemistry": ["Atomic Structure", "Chemical Bonding", "Equilibrium", "Acids & Bases", "Redox Reactions", "Organic Chemistry"]
        };
        const LEVELS = ["Year 11", "Year 12"];

        // --- GLOBAL STATE ---
        let GEMINI_KEYS = [];
        let SUBJECT_CONTEXT = "";
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- AI ENGINE LOGIC ---
        const AI_ENGINE = {
            initKeys: async () => {
                try {
                    const res = await fetch('GE.txt');
                    if (!res.ok) return false;
                    const txt = await res.text();
                    const lines = txt.split(/[\r\n]+/);
                    GEMINI_KEYS = [];
                    lines.forEach(line => {
                        const trimmed = line.trim();
                        if (trimmed.startsWith("AIza")) GEMINI_KEYS.push(trimmed);
                        else {
                            try {
                                const decoded = atob(trimmed);
                                if (decoded.includes("AIza")) GEMINI_KEYS.push(decoded);
                            } catch(e) {}
                        }
                    });
                    console.log(`Loaded ${GEMINI_KEYS.length} keys.`);
                    return GEMINI_KEYS.length > 0;
                } catch (e) { return false; }
            },

            loadContext: async (subject, level) => {
                SUBJECT_CONTEXT = "";
                let fullText = "";
                let i = 1;
                let fails = 0;
                while (fails < 2 && i < 20) {
                    try {
                        const url = `data/${subject}/${level}/${i}.pdf`;
                        const head = await fetch(url, { method: 'HEAD' });
                        if (!head.ok) throw new Error("404");
                        
                        const loadingTask = pdfjsLib.getDocument(url);
                        const pdf = await loadingTask.promise;
                        for (let p = 1; p <= Math.min(pdf.numPages, 4); p++) {
                            const page = await pdf.getPage(p);
                            const content = await page.getTextContent();
                            fullText += content.items.map(item => item.str).join(' ');
                        }
                        i++; fails = 0;
                    } catch (e) { fails++; i++; }
                }
                SUBJECT_CONTEXT = fullText.substring(0, 15000);
                return fullText.length > 0;
            },

            callGemini: async (payload) => {
                if (GEMINI_KEYS.length === 0) throw new Error("No API Keys");
                
                const models = ["gemini-2.5-flash", "gemini-2.5-flash-lite", "gemini-2.0-flash", "gemini-2.0-flash-lite"];
                
                // Pick random key to distribute load
                const key = GEMINI_KEYS[Math.floor(Math.random() * GEMINI_KEYS.length)];

                for (const model of models) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status === 429) continue; // Rate limit -> try next model
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    } catch (e) {
                        console.warn(`Model ${model} failed, switching...`);
                        continue;
                    }
                }
                throw new Error("All models unavailable");
            },

            generateQuestion: async (subject, level, config) => {
                const focus = config.studyMode === 'targeted' ? `Focus topics: ${config.selectedTopics.join(", ")}` : "Comprehensive curriculum";
                const extra = config.extraPrompt ? `USER INSTRUCTIONS: ${config.extraPrompt}` : "";
                const materials = config.customMaterials ? `USER MATERIALS: ${config.customMaterials.substring(0, 5000)}` : "";
                
                const prompt = `Role: Senior Exam Writer. Subject: ${subject} ${level}. 
                CONTEXT: ${SUBJECT_CONTEXT} ${materials}
                TASK: Create a complex, multi-step synthesis question. ${focus}. ${extra}
                RULES: JSON only. No sub-questions (a,b,c). Math in $. Marks 4-7.
                FORMAT: {"text":"LaTeX String", "topic":"string", "answer":"LaTeX String", "hint":"string", "marks":number}`;

                try {
                    const jsonStr = await AI_ENGINE.callGemini({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    });
                    return JSON.parse(jsonStr);
                } catch (e) {
                    return generateOfflineQuestion(subject); // Fallback
                }
            },

            gradeSubmission: async (question, input, canvasImg) => {
                const prompt = `Role: Senior Teacher. Grade this student.
                Question: ${question.text}
                Answer Key: ${question.answer}
                Student Text: ${input}
                Student Working: [See Image]
                Max Marks: ${question.marks}
                
                CRITERIA:
                1. Prioritize WORKING OUT (in image) over final answer.
                2. Award follow-through marks for correct method even if calculation error.
                3. Be strict on notation.
                
                FORMAT: JSON { "mark": number, "correct": boolean, "feedback": { "positives": "string", "negatives": "string" } }`;

                try {
                    const parts = [{ text: prompt }];
                    if (canvasImg) parts.push({ inlineData: { mimeType: "image/png", data: canvasImg.split(',')[1] } });
                    
                    const jsonStr = await AI_ENGINE.callGemini({
                        contents: [{ parts: parts }],
                        generationConfig: { responseMimeType: "application/json" }
                    });
                    return JSON.parse(jsonStr);
                } catch (e) {
                    return { mark: 0, correct: false, feedback: { positives: "N/A", negatives: "Grading Offline" } };
                }
            },

            tutor: async (query, qContext) => {
                try {
                    return await AI_ENGINE.callGemini({
                        contents: [{ parts: [{ text: `Student asks: "${query}". Context: "${qContext}". Give a helpful hint. Use LaTeX $. Do NOT give answer.` }] }]
                    });
                } catch (e) { return "I'm offline right now."; }
            }
        };

        // --- UTILS ---
        const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        
        const LatexRenderer = ({ text }) => {
            const ref = useRef(null);
            useEffect(() => {
                if(!ref.current || !text) return;
                ref.current.innerHTML = '';
                text.split(/(\$[^$]+\$)/g).forEach(part => {
                    if(part.startsWith('$') && part.endsWith('$')) {
                        const span = document.createElement('span');
                        try { katex.render(part.slice(1,-1), span, {throwOnError:false}); } catch(e) { span.innerText = part; }
                        ref.current.appendChild(span);
                    } else if (part.length > 0) {
                        const span = document.createElement('span');
                        span.innerText = part;
                        ref.current.appendChild(span);
                    }
                });
            }, [text]);
            return <span ref={ref} className="latex-content" />;
        };

        const generateOfflineQuestion = (sub) => {
            const a = Math.floor(Math.random()*5)+2, b = Math.floor(Math.random()*10);
            return {
                text: `Differentiate $f(x) = ${a}x^3 - ${b}x$ using first principles.`,
                answer: `$f'(x) = ${3*a}x^2 - ${b}$`,
                topic: "Calculus",
                marks: 4,
                hint: "Use limit definition."
            };
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState("GATEWAY");
            const [user, setUser] = useState({ name: "", hasKeys: false });
            const [config, setConfig] = useState({ subject: "Methods", level: "Year 12", count: 5, studyMode: "full", selectedTopics: [], extraPrompt: "", customMaterials: "" });
            const [questions, setQuestions] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [status, setStatus] = useState("idle"); // idle, scanning, ready, offline
            const [loading, setLoading] = useState({ active: false, msg: "" });
            const [timer, setTimer] = useState(0);
            
            // Background Logic
            const genPaused = useRef(false);
            const generating = useRef(false);

            useEffect(() => {
                AI_ENGINE.initKeys().then(hasKeys => {
                    setUser(u => ({ ...u, hasKeys }));
                    if(!hasKeys) setStatus("offline");
                });
            }, []);

            // Initial Context Load
            const startScan = async () => {
                if (!user.hasKeys) {
                    startTest(); // Go to offline test
                    return;
                }
                setLoading({ active: true, msg: "SCANNING DATABASE..." });
                setStatus("scanning");
                const foundDB = await AI_ENGINE.loadContext(config.subject, config.level);
                setStatus(foundDB ? "ready" : "ready"); // Ready (Cloud Active) even if no PDF found, as API is working
                setLoading({ active: false, msg: "" });
                startTest();
            };

            const startTest = async () => {
                // Initialize placeholders
                const placeholders = Array(config.count).fill({ status: 'generating', text: 'Initializing...', topic: 'Loading' });
                setQuestions(placeholders);
                setView("ARENA");
                setTimer(0);
                
                // Generate Q1 & Q2 Immediately
                setLoading({ active: true, msg: "GENERATING Q1 & Q2..." });
                
                const q1 = user.hasKeys ? await AI_ENGINE.generateQuestion(config.subject, config.level, config) : generateOfflineQuestion(config.subject);
                updateQuestion(0, q1);
                
                if (config.count > 1) {
                    const q2 = user.hasKeys ? await AI_ENGINE.generateQuestion(config.subject, config.level, config) : generateOfflineQuestion(config.subject);
                    updateQuestion(1, q2);
                }
                
                setLoading({ active: false, msg: "" });
                // Start background loop
                generateBackground();
            };

            const generateBackground = async () => {
                if (generating.current) return;
                generating.current = true;
                
                for (let i = 2; i < config.count; i++) {
                    // Pause check
                    while (genPaused.current) await new Promise(r => setTimeout(r, 1000));
                    
                    // Artificial delay for rate limits
                    await new Promise(r => setTimeout(r, 2000));
                    
                    const q = user.hasKeys ? await AI_ENGINE.generateQuestion(config.subject, config.level, config) : generateOfflineQuestion(config.subject);
                    updateQuestion(i, q);
                }
                generating.current = false;
            };

            const updateQuestion = (idx, data) => {
                setQuestions(prev => {
                    const n = [...prev];
                    n[idx] = { ...data, status: 'ready', id: Date.now(), userAnswer: '' };
                    return n;
                });
            };

            // Timer
            useEffect(() => {
                let interval;
                if (view === "ARENA") interval = setInterval(() => setTimer(t => t + 1), 1000);
                return () => clearInterval(interval);
            }, [view]);

            // File Upload
            const handleFiles = async (e) => {
                setLoading({active:true, msg:"Reading PDFs..."});
                let txt = "";
                for (const file of e.target.files) {
                    try {
                        const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                        for(let i=1; i<=Math.min(pdf.numPages, 5); i++) {
                            const p = await pdf.getPage(i);
                            const c = await p.getTextContent();
                            txt += c.items.map(s=>s.str).join(' ');
                        }
                    } catch(e){}
                }
                setConfig({...config, customMaterials: txt});
                setLoading({active:false, msg:""});
            };

            return (
                <div className="w-full h-screen text-slate-200 selection:bg-blue-500 selection:text-white overflow-hidden font-sans">
                    {loading.active && (
                        <div className="absolute inset-0 z-50 bg-[#020617]/90 flex flex-col items-center justify-center backdrop-blur-xl">
                            <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                            <h2 className="mt-4 font-bold text-blue-400 tracking-widest">{loading.msg}</h2>
                        </div>
                    )}

                    {view === "GATEWAY" && (
                        <div className="h-full flex flex-col items-center justify-center p-6 relative">
                            <div className="absolute w-[600px] h-[600px] bg-blue-600/10 rounded-full blur-[100px] -top-20 -left-20"></div>
                            <div className="glass-panel p-12 rounded-3xl w-full max-w-md flex flex-col items-center z-10 animate-slide-up">
                                <h1 className="text-5xl font-black bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent mb-2">ATAR HELPER</h1>
                                <div className="h-1 w-24 bg-blue-500 rounded-full mb-10 opacity-80"></div>
                                <input className="glass-input w-full p-4 rounded-xl text-center font-bold tracking-widest mb-6 focus:scale-105" placeholder="ENTER SURNAME" onChange={e => setUser({...user, name: e.target.value.toUpperCase()})} />
                                <button onClick={() => user.name && setView("CONFIG")} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95">INITIALIZE</button>
                            </div>
                        </div>
                    )}

                    {view === "CONFIG" && (
                        <div className="h-full flex items-center justify-center p-4">
                            <div className="glass-panel p-8 rounded-3xl w-full max-w-5xl h-[80vh] flex flex-col animate-slide-up">
                                <div className="flex justify-between border-b border-white/10 pb-4 mb-4">
                                    <h2 className="font-bold tracking-widest text-white">CONFIGURATION</h2>
                                    <span className="bg-white/10 px-3 py-1 rounded-full text-xs font-mono">{user.name}</span>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 flex-1 overflow-y-auto custom-scrollbar pr-2">
                                    <div className="space-y-4">
                                        <h3 className="text-xs font-bold text-blue-400 uppercase">1. Core</h3>
                                        <div className="custom-select-wrapper relative">
                                            <select className="glass-input w-full rounded-lg" value={config.subject} onChange={e => setConfig({...config, subject: e.target.value})}>
                                                {Object.keys(SUBJECT_DATA).map(s => <option key={s} value={s}>{s}</option>)}
                                            </select>
                                        </div>
                                        <div className="custom-select-wrapper relative">
                                            <select className="glass-input w-full rounded-lg" value={config.level} onChange={e => setConfig({...config, level: e.target.value})}>
                                                {LEVELS.map(l => <option key={l} value={l}>{l}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs text-slate-400">Questions: {config.count}</label>
                                            <input type="range" min="1" max="10" value={config.count} onChange={e => setConfig({...config, count: parseInt(e.target.value)})} className="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                                        </div>
                                    </div>
                                    <div className="space-y-4">
                                        <h3 className="text-xs font-bold text-blue-400 uppercase">2. Focus</h3>
                                        <div className="flex gap-2">
                                            <button onClick={() => setConfig({...config, studyMode: 'full'})} className={`flex-1 py-2 rounded text-xs font-bold ${config.studyMode==='full'?'bg-blue-600':'bg-white/5'}`}>FULL YEAR</button>
                                            <button onClick={() => setConfig({...config, studyMode: 'targeted'})} className={`flex-1 py-2 rounded text-xs font-bold ${config.studyMode==='targeted'?'bg-blue-600':'bg-white/5'}`}>TARGETED</button>
                                        </div>
                                        {config.studyMode === 'targeted' ? (
                                            <div className="h-40 overflow-y-auto custom-scrollbar bg-black/20 p-2 rounded">
                                                {SUBJECT_DATA[config.subject].map(t => (
                                                    <label key={t} className="flex items-center gap-2 p-2 hover:bg-white/5 rounded cursor-pointer">
                                                        <input type="checkbox" onChange={e => {
                                                            const newT = e.target.checked ? [...config.selectedTopics, t] : config.selectedTopics.filter(x => x !== t);
                                                            setConfig({...config, selectedTopics: newT});
                                                        }} className="accent-blue-500"/>
                                                        <span className="text-xs">{t}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        ) : <div className="h-40 flex items-center justify-center text-xs text-slate-500 border border-dashed border-white/10 rounded">Full Curriculum Selected</div>}
                                    </div>
                                    <div className="space-y-4">
                                        <h3 className="text-xs font-bold text-blue-400 uppercase">3. Customization</h3>
                                        <textarea placeholder="Extra Instructions (e.g. 'Be strict', 'Focus on tricky algebra')" className="glass-input w-full h-24 rounded-lg p-3 text-xs resize-none" onChange={e => setConfig({...config, extraPrompt: e.target.value})}></textarea>
                                        <div className="relative border border-dashed border-white/20 rounded-lg h-20 flex flex-col items-center justify-center hover:bg-white/5 transition-colors">
                                            <input type="file" multiple accept=".pdf" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFiles} />
                                            <span className="text-2xl">üìÑ</span>
                                            <span className="text-[10px] text-slate-500">Upload PDF Materials</span>
                                        </div>
                                        {config.customMaterials && <span className="text-[10px] text-emerald-400">‚úì Materials Attached</span>}
                                    </div>
                                </div>
                                <button onClick={startScan} className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg mt-4 transition-transform active:scale-95">START SESSION</button>
                            </div>
                        </div>
                    )}

                    {view === "ARENA" && (
                        <Arena 
                            questions={questions} 
                            qIndex={qIndex} 
                            setQIndex={setQIndex} 
                            timer={timer} 
                            user={user} 
                            status={status}
                            genPaused={genPaused}
                            onFinish={() => setView("DEBRIEF")}
                            updateQ={updateQuestion}
                        />
                    )}

                    {view === "DEBRIEF" && (
                        <Debrief questions={questions} user={user} config={config} timer={timer} onRestart={() => window.location.reload()} />
                    )}
                </div>
            );
        };

        // --- ARENA COMPONENT ---
        const Arena = ({ questions, qIndex, setQIndex, timer, user, status, genPaused, onFinish, updateQ }) => {
            const q = questions[qIndex];
            const [input, setInput] = useState("");
            const [canvas, setCanvas] = useState(null);
            const [msgs, setMsgs] = useState([{role:'ai', text:`Hello ${user.name}, good luck!`}]);
            const [chatIn, setChatIn] = useState("");
            const [sidebar, setSidebar] = useState("tutor"); // tutor | results
            const [processing, setProcessing] = useState(false);
            const [showKeys, setShowKeys] = useState(false);
            const [showGiveUp, setShowGiveUp] = useState(false);
            
            // Canvas State
            const canvasRef = useRef(null);
            const ctxRef = useRef(null);
            const isDrawing = useRef(false);
            const [tool, setTool] = useState({ type: 'pen', color: '#ffffff' });

            // Setup Canvas on Question Change
            useEffect(() => {
                const cvs = canvasRef.current;
                if (cvs) {
                    const rect = cvs.parentElement.getBoundingClientRect();
                    cvs.width = rect.width;
                    cvs.height = rect.height;
                    const ctx = cvs.getContext('2d');
                    ctx.lineCap = "round";
                    ctx.lineJoin = "round";
                    ctx.strokeStyle = tool.color;
                    ctx.lineWidth = 3;
                    ctxRef.current = ctx;
                    // Auto-clear board on new question
                    ctx.clearRect(0,0, cvs.width, cvs.height);
                }
                setInput(q?.userAnswer || "");
            }, [qIndex]); // Re-run when qIndex changes to reset/clear

            // Drawing Handlers
            const startDraw = (e) => {
                const { offsetX, offsetY } = getOffset(e);
                ctxRef.current.beginPath();
                ctxRef.current.moveTo(offsetX, offsetY);
                isDrawing.current = true;
            };
            const draw = (e) => {
                if (!isDrawing.current) return;
                const { offsetX, offsetY } = getOffset(e);
                ctxRef.current.lineTo(offsetX, offsetY);
                ctxRef.current.stroke();
            };
            const endDraw = () => {
                ctxRef.current.closePath();
                isDrawing.current = false;
            };
            const getOffset = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { offsetX: x, offsetY: y };
            };

            const submit = async () => {
                if (!input && !user.hasKeys) return;
                setProcessing(true);
                genPaused.current = true; // Pause background gen
                
                const img = canvasRef.current.toDataURL("image/png");
                const res = await AI_ENGINE.gradeSubmission(q, input, img);
                
                updateQ(qIndex, { ...q, status: 'graded', grading: res, userAnswer: input });
                setSidebar("results");
                document.getElementById('drawer').classList.remove('translate-x-full');
                
                setProcessing(false);
                genPaused.current = false;
            };

            const surrender = async () => {
                setShowGiveUp(false);
                setProcessing(true);
                genPaused.current = true;
                
                // Prompt for solution
                const prompt = `User gave up on: ${q.text}. Provide full worked solution steps. JSON: {"mark":0, "correct":false, "feedback": {"positives":"N/A", "negatives":"Surrendered", "improvements":"SOLUTION: [Steps in LaTeX $]"}}`;
                let res;
                try {
                    const raw = await AI_ENGINE.callGemini({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } });
                    res = JSON.parse(raw);
                } catch(e) {
                    res = { mark: 0, correct: false, feedback: { positives: "N/A", negatives: "Surrendered", improvements: "Check notes." } };
                }

                updateQ(qIndex, { ...q, status: 'graded', grading: res, userAnswer: "Surrendered" });
                setSidebar("results");
                document.getElementById('drawer').classList.remove('translate-x-full');
                setProcessing(false);
                genPaused.current = false;
            };

            const chat = async () => {
                if (!chatIn) return;
                const txt = chatIn; setChatIn("");
                setMsgs(p => [...p, {role:'user', text:txt}]);
                genPaused.current = true;
                
                const reply = await AI_ENGINE.tutor(txt, q.text);
                setMsgs(p => [...p, {role:'ai', text:reply}]);
                
                genPaused.current = false;
            };

            const mathKeys = ["x^2", "\\sqrt{x}", "\\frac{a}{b}", "\\pi", "\\theta", "\\int", "\\le", "\\ge", "\\approx", "\\pm", "\\infty"];

            return (
                <div className="flex h-full relative">
                    {/* Sidebar */}
                    <div className="w-20 glass-panel border-r border-white/10 flex flex-col items-center py-6 gap-4 z-20">
                        <div className={`w-3 h-3 rounded-full shadow-[0_0_15px] transition-all ${status==='ready'?'bg-emerald-500 shadow-emerald-500':status==='offline'?'bg-amber-500 shadow-amber-500':'bg-slate-500'}`}></div>
                        <span className={`text-[8px] font-bold text-center leading-tight mb-2 ${status==='ready'?'text-emerald-500':status==='offline'?'text-amber-500':'text-slate-500'}`}>
                            {status==='ready' ? "CLOUD\nACTIVE" : status==='offline' ? "LIMITED\nMODE" : "SCANNING"}
                        </span>
                        {questions.map((qn, i) => (
                            <button key={i} disabled={qn.status==='generating'} onClick={()=>{ if(qn.status!=='generating') setQIndex(i) }}
                                className={`w-10 h-10 rounded-xl flex items-center justify-center text-xs font-bold transition-all ${i===qIndex?'scale-110 ring-2 ring-white bg-blue-600':qn.status==='generating'?'border border-blue-500/30 text-transparent':'bg-slate-800 text-slate-500 hover:bg-slate-700'} ${qn.status==='graded'?(qn.grading.correct?'border-emerald-500 border-2':'border-red-500 border-2'):''}`}>
                                {qn.status==='generating' ? <div className="spin-border w-4 h-4"></div> : i+1}
                            </button>
                        ))}
                    </div>

                    {/* Workspace */}
                    <div className="flex-1 relative bg-[#0f172a] overflow-hidden">
                        <canvas ref={canvasRef} className="absolute inset-0 z-0" 
                            onMouseDown={startDraw} onMouseMove={draw} onMouseUp={endDraw} onMouseLeave={endDraw}
                            onTouchStart={startDraw} onTouchMove={draw} onTouchEnd={endDraw}
                        />
                        
                        {/* Toolbar */}
                        <div className="absolute top-6 left-1/2 -translate-x-1/2 glass-panel px-6 py-2 rounded-full flex items-center gap-6 z-10 shadow-2xl">
                            <button onClick={()=>{setTool({type:'pen', color:'#ffffff'}); ctxRef.current.globalCompositeOperation="source-over"; ctxRef.current.strokeStyle="#ffffff"; ctxRef.current.lineWidth=3;}} className={`w-6 h-6 rounded-full bg-white border-2 ${tool.color==='#ffffff'?'ring-2 ring-blue-500':''}`}></button>
                            <button onClick={()=>{setTool({type:'pen', color:'#3b82f6'}); ctxRef.current.globalCompositeOperation="source-over"; ctxRef.current.strokeStyle="#3b82f6"; ctxRef.current.lineWidth=3;}} className={`w-6 h-6 rounded-full bg-blue-500 border-2 ${tool.color==='#3b82f6'?'ring-2 ring-white':''}`}></button>
                            <button onClick={()=>{setTool({type:'eraser', color:''}); ctxRef.current.globalCompositeOperation="destination-out"; ctxRef.current.lineWidth=30;}} className="text-slate-400 hover:text-white"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                            <div className="w-px h-6 bg-white/20"></div>
                            <button onClick={()=>{ const cvs = canvasRef.current; ctxRef.current.clearRect(0,0,cvs.width,cvs.height); }} className="text-red-400 text-[10px] font-bold uppercase hover:text-red-200">Clear</button>
                            <div className="w-px h-6 bg-white/20"></div>
                            <span className="text-white font-mono text-sm">‚è± {formatTime(timer)}</span>
                        </div>

                        {/* Question */}
                        <div className="absolute top-6 left-6 max-w-md glass-panel p-6 rounded-2xl border-l-4 border-blue-500 z-10 text-white">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-[10px] font-bold uppercase text-blue-400 tracking-widest">{q.topic}</span>
                                <span className="text-[10px] bg-white/10 px-2 py-1 rounded">{q.marks} Marks</span>
                            </div>
                            <div className="text-lg"><LatexRenderer text={q.text}/></div>
                        </div>

                        {/* Input Area */}
                        <div className="absolute bottom-0 w-full p-6 bg-gradient-to-t from-[#020617] to-transparent z-20 pointer-events-none">
                            <div className="max-w-4xl mx-auto pointer-events-auto">
                                {q.status === 'graded' ? (
                                    <div className="glass-panel p-6 rounded-2xl border-l-4 border-slate-600">
                                        <div className="flex justify-between mb-4">
                                            <h3 className={`font-bold text-xl ${q.grading.correct?'text-emerald-400':'text-red-400'}`}>{q.grading.correct?'CORRECT':'INCORRECT'}</h3>
                                            <button onClick={()=> qIndex < questions.length-1 ? setQIndex(qIndex+1) : onFinish()} className="bg-blue-600 px-6 py-2 rounded-lg font-bold text-white shadow-lg">{qIndex < questions.length-1 ? 'Next Question' : 'Finish Test'}</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col gap-2 relative">
                                        <div className={`absolute bottom-full left-1/2 -translate-x-1/2 mb-4 glass-panel p-2 rounded-xl flex flex-wrap gap-2 justify-center transition-all ${showKeys ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                                            <div className="w-full flex justify-end"><button onClick={()=>setShowKeys(false)} className="text-[10px] uppercase text-slate-400 hover:text-white">‚ñº Collapse</button></div>
                                            {mathKeys.map(k => <button key={k} onClick={()=>{setInput(p=>p+k)}} className="px-3 py-2 bg-white/5 hover:bg-white/10 rounded text-xs font-mono text-blue-300 min-w-[30px]"><LatexRenderer text={`$${k}$`}/></button>)}
                                        </div>
                                        <div className="flex gap-4">
                                            <div className="flex gap-2">
                                                <button onClick={()=>setShowGiveUp(true)} className="w-24 bg-red-900/40 text-red-300 font-bold rounded-xl text-[10px] uppercase border border-red-500/20 hover:bg-red-900/60">Give Up</button>
                                                <button onClick={submit} disabled={processing} className="w-24 bg-blue-600 text-white font-bold rounded-xl shadow-lg disabled:opacity-50 text-[10px] uppercase">Submit</button>
                                            </div>
                                            <div className="flex-1 relative">
                                                <input value={input} onChange={e=>setInput(e.target.value)} onFocus={()=>setShowKeys(true)} className="w-full h-full glass-input rounded-xl px-4 font-mono text-lg shadow-xl" placeholder="Final answer..." />
                                                <button onClick={()=>setShowKeys(!showKeys)} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white">‚å®Ô∏è</button>
                                            </div>
                                            <button onClick={()=>{setSidebar('tutor'); document.getElementById('drawer').classList.toggle('translate-x-full')}} className="bg-slate-700 text-white w-14 rounded-xl shadow-lg md:hidden">?</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {showGiveUp && (
                            <div className="absolute inset-0 bg-black/80 flex items-center justify-center z-50">
                                <div className="glass-panel p-8 rounded-2xl max-w-sm w-full text-center">
                                    <h3 className="text-xl font-bold mb-2 text-white">Surrender?</h3>
                                    <p className="text-slate-400 text-sm mb-6">AI will reveal the full solution.</p>
                                    <div className="flex gap-4">
                                        <button onClick={()=>setShowGiveUp(false)} className="flex-1 py-3 rounded-xl bg-slate-700 text-white font-bold">Cancel</button>
                                        <button onClick={surrender} className="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold">Surrender</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Drawer */}
                    <div id="drawer" className="fixed inset-y-0 right-0 w-96 glass-panel border-l border-white/10 transform translate-x-full md:translate-x-0 transition-transform duration-300 z-30 flex flex-col shadow-2xl">
                        <div className="flex border-b border-white/10">
                            <button onClick={()=>setSidebar('tutor')} className={`flex-1 py-4 text-xs font-bold uppercase ${sidebar==='tutor'?'text-blue-400 border-b-2 border-blue-400':'text-slate-500'}`}>Tutor</button>
                            <button onClick={()=>setSidebar('results')} className={`flex-1 py-4 text-xs font-bold uppercase ${sidebar==='results'?'text-emerald-400 border-b-2 border-emerald-400':'text-slate-500'}`}>Results</button>
                        </div>
                        {sidebar === 'tutor' ? (
                            <div className="flex-1 flex flex-col">
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                                    {msgs.map((m,i)=>(<div key={i} className={`p-3 rounded-xl text-sm ${m.role==='user'?'bg-blue-600/20 ml-4 border border-blue-500/20':'bg-slate-800 mr-4 border border-white/5'}`}><LatexRenderer text={m.text}/></div>))}
                                </div>
                                <div className="p-4 border-t border-white/10 flex gap-2">
                                    <input value={chatIn} onChange={e=>setChatIn(e.target.value)} onKeyDown={e=>e.key==='Enter'&&chat()} className="flex-1 glass-input rounded-lg p-2 text-xs" placeholder="Ask for hint..." />
                                    <button onClick={chat} className="bg-blue-600 px-3 rounded-lg text-white">‚û§</button>
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-6">
                                {q.status==='graded' ? (
                                    <>
                                        <div className="text-center">
                                            <div className={`text-5xl font-black ${q.grading.correct?'text-emerald-400':'text-red-400'}`}>{q.grading.mark}/{q.marks}</div>
                                            <div className="text-xs uppercase tracking-widest text-slate-500">Marks Awarded</div>
                                        </div>
                                        <div className="bg-white/5 p-4 rounded-xl border border-white/5">
                                            <div className="text-xs font-bold text-slate-400 uppercase mb-2">Correct Answer</div>
                                            <div className="text-sm font-mono"><LatexRenderer text={q.answer}/></div>
                                        </div>
                                        <div className="bg-emerald-900/10 p-4 rounded-xl border-l-2 border-emerald-500">
                                            <div className="text-xs font-bold text-emerald-400 uppercase mb-1">Positives</div>
                                            <p className="text-sm text-emerald-100/80"><LatexRenderer text={q.grading.feedback.positives}/></p>
                                        </div>
                                        <div className="bg-red-900/10 p-4 rounded-xl border-l-2 border-red-500">
                                            <div className="text-xs font-bold text-red-400 uppercase mb-1">Improvements / Solution</div>
                                            <p className="text-sm text-red-100/80"><LatexRenderer text={q.grading.feedback.negatives}/></p>
                                        </div>
                                    </>
                                ) : <div className="text-center text-slate-500 text-xs mt-10">Submit answer to see grading.</div>}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Debrief = ({ questions, user, config, timer, onRestart }) => {
            const score = questions.reduce((a,q)=>a+(q.grading?.mark||0),0);
            const total = questions.reduce((a,q)=>a+q.marks,0);
            const pct = Math.round((score/total)*100);
            
            const dl = () => {
                const doc = new window.jspdf.jsPDF();
                doc.setFontSize(22); doc.text("ATAR HELPER REPORT", 20, 20);
                doc.setFontSize(12); doc.text(`Student: ${user.name} | Score: ${score}/${total} (${pct}%) | Time: ${formatTime(timer)}`, 20, 30);
                let y = 40;
                questions.forEach((q,i) => {
                    if(y>250) { doc.addPage(); y=20; }
                    doc.setFontSize(14); doc.setTextColor(0,0,255); doc.text(`Q${i+1}: ${q.topic}`, 20, y);
                    doc.setFontSize(10); doc.setTextColor(0); y+=6;
                    const txt = doc.splitTextToSize(q.text.replace(/\$/g,''), 170);
                    doc.text(txt, 20, y); y += txt.length*5+5;
                    doc.setTextColor(100);
                    const fb = doc.splitTextToSize(`Feedback: ${q.grading?.feedback?.improvements || 'N/A'}`, 170);
                    doc.text(fb, 20, y); y += fb.length*5+10;
                });
                doc.save(`Report_${user.name}.pdf`);
            };

            return (
                <div className="h-full flex flex-col items-center justify-center">
                    <div className="glass-panel p-10 rounded-3xl text-center max-w-lg w-full animate-slide-up">
                        <div className="text-xs font-bold tracking-[0.3em] text-slate-400 mb-6">SESSION COMPLETE</div>
                        <div className="text-8xl font-black text-white mb-2">{pct}%</div>
                        <div className="text-slate-400 text-sm font-bold mb-10">{score} / {total} POINTS</div>
                        <div className="text-slate-500 font-mono text-xs mb-8">‚è± Time: {formatTime(timer)}</div>
                        <div className="flex gap-4">
                            <button onClick={dl} className="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl">DOWNLOAD PDF</button>
                            <button onClick={onRestart} className="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-xl">NEW TEST</button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
