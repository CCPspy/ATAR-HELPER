<!-- 
    ATAR HELPER v2.0 | AI TUTOR & EXAM SIMULATOR
    PROPERTY OF ERIC / CCPSPY | WILLETTON SHS | 2026
    ALL RIGHTS RESERVED
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ATAR Helper v2.0</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --bg-deep: #020617;
            --accent-blue: #3b82f6;
            --accent-emerald: #10b981;
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: #f8fafc;
            overflow: hidden;
            margin: 0;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus { border-color: var(--accent-blue); outline: none; box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }

        .premium-btn {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #1d4ed8 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
        }
        .premium-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.5); filter: brightness(1.1); }
        .premium-btn:active { transform: translateY(0); }

        /* Loader Animation */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinner {
            width: 60px; height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .slide-in-right { animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

        /* Math Keyboard Styling */
        .math-key {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 6px;
            font-family: 'Space Grotesk', serif;
            transition: all 0.2s;
        }
        .math-key:hover { background: rgba(59, 130, 246, 0.2); border-color: var(--accent-blue); }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-online { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .dot-amber { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        .dot-grey { background: #64748b; }

        canvas { touch-action: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, memo } = React;

        // --- GLOBAL UTILITIES ---
        let GEMINI_KEYS = [];
        let SYSTEM_CONTEXT = "";
        let UPLOADED_DOC_TEXT = "";

        const decodeBase64 = (str) => { try { let d=atob(str); return d.includes("AIza") ? d : null; } catch(e){return null;} }

        async function initKeys() {
            try {
                const res = await fetch(`GE.txt?v=${Date.now()}`);
                if (!res.ok) return false;
                const txt = await res.text();
                GEMINI_KEYS = txt.split('\n').map(k=>k.trim()).filter(k=>k).map(k => k.startsWith("AIza") ? k : decodeBase64(k)).filter(k=>k);
                return GEMINI_KEYS.length > 0;
            } catch(e) { return false; }
        }

        const SUBJECTS = ["Methods", "Specialist", "Physics", "Chemistry"];
        const LEVELS = ["Year 11", "Year 12"];
        const TOPICS_DB = {
            "Methods": ["Calculus", "Probability", "Trigonometry", "Logarithms", "Sequences"],
            "Specialist": ["Complex Numbers", "Vectors", "Matrices", "Mechanics", "Differential Equations"],
            "Physics": ["Gravity", "Electromagnetism", "Quantum", "Motion", "Nuclear"],
            "Chemistry": ["Equilibrium", "Acids & Bases", "Redox", "Organic", "Atomic Structure"]
        };

        const AI_ENGINE = {
            call: async (prompt, image = null, json = false) => {
                const key = GEMINI_KEYS[Math.floor(Math.random() * GEMINI_KEYS.length)];
                if (!key) throw new Error("Missing API Key");
                
                const parts = [{ text: prompt }];
                if (image) parts.push({ inline_data: { mime_type: "image/png", data: image.split(',')[1] } });

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts }],
                        generationConfig: { responseMimeType: json ? "application/json" : "text/plain", temperature: 0.7 }
                    })
                });
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            },

            generateQuestion: async (subject, level, topics, extras) => {
                const prompt = `Role: ATAR Exam Writer. Subject: ${subject} ${level}. Topics: ${topics.join(', ')}.
                ${UPLOADED_DOC_TEXT ? `Reference this material: ${UPLOADED_DOC_TEXT.substring(0, 5000)}` : ''}
                User Instructions: ${extras || 'None'}.
                Output JSON ONLY: {"text": "LaTeX question", "topic": "Name", "marks": number, "answer": "final string", "hint": "short hint"}`;
                const text = await AI_ENGINE.call(prompt, null, true);
                return JSON.parse(text);
            }
        };

        // --- COMPONENTS ---

        const MathRenderer = ({ text }) => {
            if (!text) return null;
            const parts = text.split(/(\$.*?\$)/g);
            return (
                <div className="leading-relaxed">
                    {parts.map((p, i) => {
                        if (p.startsWith('$') && p.endsWith('$')) {
                            try {
                                return <span key={i} dangerouslySetInnerHTML={{ __html: katex.renderToString(p.slice(1, -1), { throwOnError: false }) }} />;
                            } catch (e) { return p; }
                        }
                        return <span key={i}>{p}</span>;
                    })}
                </div>
            );
        };

        const Whiteboard = memo(({ tool, color, size, clearTrigger, onDraw, canvasRef }) => {
            const innerRef = useRef(null);
            const ctxRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                const canvas = innerRef.current;
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                const ctx = canvas.getContext('2d');
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctxRef.current = ctx;
                if (canvasRef) canvasRef.current = canvas;
            }, []);

            useEffect(() => {
                if (clearTrigger > 0) ctxRef.current.clearRect(0, 0, innerRef.current.width, innerRef.current.height);
            }, [clearTrigger]);

            const start = (e) => {
                const rect = innerRef.current.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctxRef.current.beginPath();
                ctxRef.current.moveTo(x, y);
                setIsDrawing(true);
            };

            const move = (e) => {
                if (!isDrawing) return;
                const rect = innerRef.current.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                const ctx = ctxRef.current;
                ctx.globalCompositeOperation = tool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.strokeStyle = color;
                ctx.lineWidth = tool === 'eraser' ? 30 : size;
                ctx.lineTo(x, y);
                ctx.stroke();
                onDraw && onDraw();
            };

            return <canvas ref={innerRef} onMouseDown={start} onTouchStart={start} onMouseMove={move} onTouchMove={move} onMouseUp={() => setIsDrawing(false)} onTouchEnd={() => setIsDrawing(false)} className="w-full h-full" />;
        });

        const App = () => {
            const [view, setView] = useState('GATEWAY');
            const [surname, setSurname] = useState('');
            const [config, setConfig] = useState({ subject: 'Methods', level: 'Year 12', count: 5, mode: 'Comprehensive', topics: [], extras: '', apiKey: '' });
            const [dbStatus, setDbStatus] = useState('checking');
            const [loading, setLoading] = useState(false);
            const [loadProgress, setLoadProgress] = useState({ time: 0, text: '', est: 0 });
            
            const [questions, setQuestions] = useState([]);
            const [currIdx, setCurrIdx] = useState(0);
            const [timer, setTimer] = useState(0);
            const [arenaState, setArenaState] = useState({ tool: 'pen', color: '#3b82f6', size: 3, input: '', sidebarOpen: true, drawerTab: 'TUTOR', results: null, qCollapsed: false });
            const [messages, setMessages] = useState([]);
            const [clearTrig, setClearTrig] = useState(0);
            const canvasRef = useRef(null);

            useEffect(() => {
                initKeys().then(success => setDbStatus(success ? 'online' : 'limited'));
            }, []);

            useEffect(() => {
                let it;
                if (view === 'ARENA') it = setInterval(() => setTimer(t => t + 1), 1000);
                return () => clearInterval(it);
            }, [view]);

            // Handlers
            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const pdf = await pdfjsLib.getDocument(ev.target.result).promise;
                        let fullText = "";
                        for(let i=1; i<=Math.min(pdf.numPages, 10); i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            fullText += content.items.map(it => it.str).join(" ");
                        }
                        UPLOADED_DOC_TEXT = fullText;
                        document.getElementById('file-label').innerText = "Materials Loaded (Green)";
                        document.getElementById('file-label').style.color = "#10b981";
                    };
                    reader.readAsArrayBuffer(file);
                } catch(e) { console.error("Upload failed"); }
            };

            const startSession = async () => {
                if (config.apiKey) GEMINI_KEYS.unshift(config.apiKey);
                setLoading(true);
                setLoadProgress({ time: 0, text: 'Initializing AI Models...', est: config.count * 3 });
                
                const loadTimer = setInterval(() => setLoadProgress(prev => ({ ...prev, time: prev.time + 0.1 })), 100);

                try {
                    // Pre-generate 2 questions as per request
                    const q1 = await AI_ENGINE.generateQuestion(config.subject, config.level, config.topics, config.extras);
                    setLoadProgress(p => ({ ...p, text: 'First Question Ready...' }));
                    const q2 = await AI_ENGINE.generateQuestion(config.subject, config.level, config.topics, config.extras);
                    setLoadProgress(p => ({ ...p, text: 'Second Question Ready. Launching Arena...' }));
                    
                    const placeholders = Array(config.count).fill(null).map((_, i) => (i < 2 ? (i === 0 ? q1 : q2) : { status: 'pending' }));
                    setQuestions(placeholders.map(q => q.status === 'pending' ? q : { ...q, status: 'ready' }));
                    
                    clearInterval(loadTimer);
                    setLoading(false);
                    setView('ARENA');

                    // Generate rest in background
                    for (let i = 2; i < config.count; i++) {
                        const q = await AI_ENGINE.generateQuestion(config.subject, config.level, config.topics, config.extras);
                        setQuestions(prev => {
                            const n = [...prev];
                            n[i] = { ...q, status: 'ready' };
                            return n;
                        });
                    }
                } catch (e) { 
                    setLoading(false); 
                    clearInterval(loadTimer);
                    alert("System Error: Check API Key or Internet."); 
                }
            };

            const submitAnswer = async () => {
                const q = questions[currIdx];
                const img = canvasRef.current.toDataURL();
                setMessages(prev => [...prev, { role: 'user', text: `Submitted: ${arenaState.input}` }]);
                
                const prompt = `Grade this: Q: ${q.text}. Expected: ${q.answer}. Student: ${arenaState.input}. Marks: ${q.marks}. Analyze working from image provided. 
                Output JSON ONLY: {"mark": number, "correct": boolean, "feedback": {"positives": "", "improvements": ""}}`;
                
                const resText = await AI_ENGINE.call(prompt, img, true);
                const res = JSON.parse(resText);
                
                const newQs = [...questions];
                newQs[currIdx] = { ...newQs[currIdx], status: res.correct ? 'correct' : 'wrong', markAwarded: res.mark, gradeData: res };
                setQuestions(newQs);
                setArenaState(p => ({ ...p, drawerTab: 'RESULTS', results: res }));
            };

            // --- LAYERS ---

            if (view === 'GATEWAY') return (
                <div className="h-screen w-full flex items-center justify-center relative bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-blue-900/20 via-slate-950 to-slate-950">
                    <div className="glass-panel p-8 rounded-2xl w-full max-w-md fade-in">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold tracking-tighter bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">ATAR HELPER</h1>
                            <div className="h-1 w-20 bg-blue-500 mx-auto mt-2 rounded-full"></div>
                        </div>
                        <div className="space-y-4">
                            <label className="text-xs uppercase tracking-[0.2em] text-slate-400">Enter Surname</label>
                            <input value={surname} onChange={e => setSurname(e.target.value.toUpperCase())} className="w-full glass-input p-4 rounded-xl text-center text-xl font-bold" placeholder="..." />
                            <button onClick={() => surname && setView('CONFIG')} className="w-full premium-btn py-4 rounded-xl text-white shadow-xl">INITIALIZE SYSTEM</button>
                        </div>
                    </div>
                    <footer className="absolute bottom-10 w-full text-center pointer-events-none opacity-30 select-none">
                        <p className="font-mono text-[10px] tracking-[0.4em]">ERIC / CCPSPY | WILLETTON SHS | 2026</p>
                    </footer>
                </div>
            );

            if (view === 'CONFIG') return (
                <div className="h-screen w-full flex flex-col items-center justify-center p-6 bg-slate-950">
                    {loading && (
                        <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-md flex flex-col items-center justify-center">
                            <div className="spinner mb-6"></div>
                            <h2 className="text-2xl font-bold mb-2">INITIALIZING SESSION...</h2>
                            <p className="text-blue-400 font-mono text-sm mb-4">{loadProgress.text}</p>
                            <div className="w-64 h-1 bg-white/10 rounded-full overflow-hidden">
                                <div className="h-full bg-blue-500 transition-all" style={{ width: `${(loadProgress.time / loadProgress.est) * 100}%` }}></div>
                            </div>
                            <p className="mt-4 text-[10px] uppercase text-slate-500">Elapsed: {loadProgress.time.toFixed(1)}s | Est: {loadProgress.est}s</p>
                        </div>
                    )}
                    <div className="glass-panel w-full max-w-5xl rounded-3xl overflow-hidden flex flex-col fade-in">
                        <header className="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
                            <h2 className="text-lg font-bold tracking-widest text-slate-400">SESSION CONFIGURATION</h2>
                            <div className="flex items-center gap-3">
                                <span className="text-xs font-bold px-3 py-1 bg-blue-500/20 text-blue-400 rounded-full border border-blue-500/30">{surname}</span>
                            </div>
                        </header>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 divide-x divide-white/5">
                            {/* Col 1 */}
                            <div className="p-8 space-y-6">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase">Subject</label>
                                    <select value={config.subject} onChange={e => setConfig({...config, subject: e.target.value})} className="w-full glass-input p-3 rounded-lg">
                                        {SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase">Level</label>
                                    <select value={config.level} onChange={e => setConfig({...config, level: e.target.value})} className="w-full glass-input p-3 rounded-lg">
                                        {LEVELS.map(l => <option key={l} value={l}>{l}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase flex justify-between">Questions <span>{config.count}</span></label>
                                    <input type="range" min="1" max="20" value={config.count} onChange={e => setConfig({...config, count: parseInt(e.target.value)})} className="w-full accent-blue-500" />
                                </div>
                            </div>

                            {/* Col 2 */}
                            <div className="p-8 space-y-6">
                                <div className="flex bg-black/40 p-1 rounded-xl">
                                    <button onClick={() => setConfig({...config, mode:'Comprehensive'})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition ${config.mode==='Comprehensive' ? 'bg-white/10 text-white' : 'text-slate-500'}`}>COMPREHENSIVE</button>
                                    <button onClick={() => setConfig({...config, mode:'Targeted'})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition ${config.mode==='Targeted' ? 'bg-white/10 text-white' : 'text-slate-500'}`}>TARGETED</button>
                                </div>
                                <div className="h-48 overflow-y-auto custom-scroll pr-2 space-y-2">
                                    {config.mode === 'Comprehensive' ? (
                                        <div className="h-full flex items-center justify-center text-slate-600 text-[10px] italic">Full curriculum covered.</div>
                                    ) : (
                                        TOP_DB[config.subject]?.map(t => (
                                            <div key={t} onClick={() => setConfig(prev => ({...prev, topics: prev.topics.includes(t) ? prev.topics.filter(x=>x!==t) : [...prev.topics, t]}))} className={`p-3 rounded-lg border text-xs cursor-pointer transition ${config.topics.includes(t) ? 'border-blue-500 bg-blue-500/10 text-blue-400' : 'border-white/5 bg-white/5 text-slate-400'}`}>{t}</div>
                                        ))
                                    )}
                                </div>
                            </div>

                            {/* Col 3 */}
                            <div className="p-8 space-y-6">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase">Extra Instructions</label>
                                    <textarea value={config.extras} onChange={e => setConfig({...config, extras: e.target.value})} className="w-full h-24 glass-input p-3 rounded-lg text-sm resize-none" placeholder="e.g. Focus on word problems..."></textarea>
                                </div>
                                <div className="space-y-2">
                                    <label id="file-label" className="text-[10px] font-bold text-slate-500 uppercase">Materials Upload</label>
                                    <label className="flex flex-col items-center justify-center w-full h-16 border-2 border-dashed border-white/10 rounded-xl cursor-pointer hover:bg-white/5 transition">
                                        <span className="text-[10px] text-slate-500"><i className="fa-solid fa-upload mr-2"></i>DROP PDF HERE</span>
                                        <input type="file" className="hidden" accept=".pdf" onChange={handleFileUpload} />
                                    </label>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase">API Key Overide</label>
                                    <input type="password" value={config.apiKey} onChange={e => setConfig({...config, apiKey: e.target.value})} className="w-full glass-input p-2 rounded-lg text-xs" placeholder="Gemini Key..." />
                                </div>
                            </div>
                        </div>

                        <button onClick={startSession} className="w-full py-6 bg-gradient-to-r from-emerald-600 to-emerald-800 text-white font-bold text-lg hover:filter hover:brightness-110 transition">START SESSION</button>
                    </div>
                    {dbStatus === 'limited' && <div className="mt-4 text-amber-500 text-[10px] font-bold"><i className="fa-solid fa-triangle-exclamation mr-2"></i>DATABASE NOT FOUND: USING CLOUD-ONLY MODE</div>}
                </div>
            );

            if (view === 'ARENA') {
                const currentQ = questions[currIdx];
                return (
                    <div className="h-screen w-full flex bg-[#020617] overflow-hidden">
                        {/* Sidebar */}
                        <aside className="w-20 glass-panel border-r border-white/5 flex flex-col items-center py-6 gap-6 z-40">
                            <div className="flex flex-col items-center gap-1">
                                <div className={`status-dot ${dbStatus==='online'?'dot-online':'dot-amber'}`}></div>
                                <span className="text-[8px] font-bold text-slate-500 uppercase">{dbStatus==='online'?'CLOUD ACTIVE':'LIMITED'}</span>
                            </div>
                            
                            <div className="flex-1 flex flex-col gap-4 overflow-y-auto custom-scroll w-full items-center">
                                {questions.map((q, i) => (
                                    <button key={i} onClick={() => setCurrIdx(i)} className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm transition-all
                                        ${currIdx === i ? 'ring-2 ring-blue-500 bg-blue-500 text-white' : 'bg-white/5 text-slate-500 hover:bg-white/10'}
                                        ${q.status === 'pending' ? 'animate-pulse opacity-50' : ''}
                                        ${q.status === 'correct' ? 'border-2 border-emerald-500' : ''}
                                        ${q.status === 'wrong' ? 'border-2 border-red-500' : ''}
                                    `}>{i + 1}</button>
                                ))}
                            </div>
                        </aside>

                        {/* Canvas Area */}
                        <main className="flex-1 relative bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
                            {/* Toolbar */}
                            <div className="absolute top-6 left-1/2 -translate-x-1/2 glass-panel px-6 py-2 rounded-full flex items-center gap-6 z-30 shadow-2xl">
                                <button onClick={() => setArenaState(p=>({...p, tool:'pen'}))} className={`text-xl ${arenaState.tool==='pen'?'text-blue-500':'text-slate-500'}`}><i className="fa-solid fa-pen"></i></button>
                                <button onClick={() => setArenaState(p=>({...p, tool:'eraser'}))} className={`text-xl ${arenaState.tool==='eraser'?'text-pink-500':'text-slate-500'}`}><i className="fa-solid fa-eraser"></i></button>
                                <input type="color" value={arenaState.color} onChange={e => setArenaState(p=>({...p, color: e.target.value}))} className="w-6 h-6 rounded-full overflow-hidden bg-transparent border-none cursor-pointer" />
                                <div className="w-px h-6 bg-white/10"></div>
                                <button onClick={() => setClearTrig(t => t + 1)} className="text-xs font-bold text-red-500 hover:text-red-400">CLEAR</button>
                                <div className="w-px h-6 bg-white/10"></div>
                                <span className="font-mono text-sm">{Math.floor(timer/60).toString().padStart(2,'0')}:{(timer%60).toString().padStart(2,'0')}</span>
                            </div>

                            {/* Question Card */}
                            <div className="absolute top-24 left-10 z-20 w-full max-w-md">
                                <div className="glass-panel border-l-4 border-blue-500 p-6 rounded-2xl shadow-2xl relative">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex gap-2 items-center">
                                            <span className="text-[10px] font-bold tracking-[0.2em] text-blue-400">{currentQ?.topic?.toUpperCase()}</span>
                                            <span className="text-[10px] font-bold px-2 py-0.5 bg-white/5 rounded text-slate-400">{currentQ?.marks} MARKS</span>
                                        </div>
                                        <button onClick={() => setArenaState(p=>({...p, qCollapsed: !p.qCollapsed}))} className="text-slate-500 hover:text-white">
                                            <i className={`fa-solid ${arenaState.qCollapsed ? 'fa-plus' : 'fa-minus'}`}></i>
                                        </button>
                                    </div>
                                    {!arenaState.qCollapsed && (
                                        <div className="text-slate-200 text-lg">
                                            {currentQ?.status === 'ready' ? <MathRenderer text={currentQ.text} /> : <div className="animate-pulse text-slate-500">Generating next question...</div>}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <Whiteboard canvasRef={canvasRef} tool={arenaState.tool} color={arenaState.color} size={arenaState.size} clearTrigger={clearTrig} />

                            {/* Bottom Input Area */}
                            <div className="absolute bottom-10 left-1/2 -translate-x-1/2 w-full max-w-2xl flex flex-col items-center gap-4 px-6 z-30">
                                {/* Math Keyboard */}
                                <div className="w-full glass-panel p-2 rounded-xl grid grid-cols-8 gap-1 shadow-2xl">
                                    {['\\pi', 'x^2', '\\sqrt{}', '\\int', '\\frac{}{}', '\\sin', '\\cos', '\\tan'].map(sym => (
                                        <button key={sym} onClick={() => setArenaState(p => ({...p, input: p.input + `$${sym}$`}))} className="math-key text-xs" dangerouslySetInnerHTML={{__html: katex.renderToString(sym, {throwOnError:false})}}></button>
                                    ))}
                                </div>
                                <div className="w-full flex gap-3">
                                    <button onClick={() => setView('DEBRIEF')} className="px-6 py-4 bg-red-500/10 border border-red-500/20 text-red-500 rounded-xl font-bold text-xs uppercase hover:bg-red-500 hover:text-white transition">Give Up</button>
                                    <input value={arenaState.input} onChange={e => setArenaState(p => ({...p, input: e.target.value}))} placeholder="Enter final answer here..." className="flex-1 glass-input p-4 rounded-xl text-lg" />
                                    <button onClick={submitAnswer} className="px-10 py-4 premium-btn text-white rounded-xl shadow-2xl">SUBMIT</button>
                                </div>
                            </div>
                        </main>

                        {/* Tutor Drawer */}
                        <div className="w-[380px] glass-panel border-l border-white/5 flex flex-col z-40 slide-in-right">
                            <div className="flex border-b border-white/5 bg-white/5">
                                <button onClick={() => setArenaState(p=>({...p, drawerTab:'TUTOR'}))} className={`flex-1 py-4 text-xs font-bold tracking-widest ${arenaState.drawerTab==='TUTOR'?'text-blue-400 border-b-2 border-blue-400':'text-slate-500'}`}>AI TUTOR</button>
                                <button onClick={() => setArenaState(p=>({...p, drawerTab:'RESULTS'}))} className={`flex-1 py-4 text-xs font-bold tracking-widest ${arenaState.drawerTab==='RESULTS'?'text-blue-400 border-b-2 border-blue-400':'text-slate-500'}`}>RESULTS</button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto custom-scroll p-6 space-y-4">
                                {arenaState.drawerTab === 'TUTOR' ? (
                                    <>
                                        {messages.length === 0 && (
                                            <div className="h-full flex flex-col items-center justify-center text-center opacity-20 pointer-events-none">
                                                <i className="fa-solid fa-robot text-6xl mb-4"></i>
                                                <p className="text-sm">Ask a question or<br/>submit to see feedback</p>
                                            </div>
                                        )}
                                        {messages.map((m, i) => (
                                            <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                                                <div className={`max-w-[85%] p-4 rounded-2xl text-sm ${m.role==='user'?'bg-blue-600 text-white rounded-tr-none':'glass-card text-slate-300 rounded-tl-none'}`}>
                                                    <MathRenderer text={m.text} />
                                                </div>
                                            </div>
                                        ))}
                                    </>
                                ) : (
                                    <div className="space-y-6 animate-fade-in">
                                        {!arenaState.results ? (
                                            <div className="text-center py-20 text-slate-600 italic">No question submitted yet.</div>
                                        ) : (
                                            <>
                                                <div className="text-center">
                                                    <div className="text-5xl font-bold text-white mb-2">{arenaState.results.mark}/{currentQ.marks}</div>
                                                    <div className="text-[10px] font-bold uppercase text-slate-500">Marks Awarded</div>
                                                </div>
                                                <div className="p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-xl">
                                                    <div className="text-[10px] font-bold text-emerald-400 uppercase mb-2">Correct Answer</div>
                                                    <div className="text-white text-sm"><MathRenderer text={`$${currentQ.answer}$`} /></div>
                                                </div>
                                                <div className="p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl">
                                                    <div className="text-[10px] font-bold text-blue-400 uppercase mb-2">Teacher Feedback</div>
                                                    <div className="text-slate-300 text-xs leading-relaxed">{arenaState.results.feedback.positives}</div>
                                                </div>
                                                <div className="p-4 bg-red-500/10 border border-red-500/20 rounded-xl">
                                                    <div className="text-[10px] font-bold text-red-400 uppercase mb-2">Room for Improvement</div>
                                                    <div className="text-slate-300 text-xs leading-relaxed">{arenaState.results.feedback.improvements}</div>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                )}
                            </div>

                            <div className="p-4 bg-white/5 border-t border-white/5 flex gap-2">
                                <input id="chat-in" onKeyPress={e => {
                                    if(e.key==='Enter') {
                                        const txt = e.target.value;
                                        setMessages(p => [...p, {role:'user', text:txt}]);
                                        AI_ENGINE.call(`User asks: ${txt}. Context Q: ${currentQ.text}. Answer: ${currentQ.answer}`, null, false)
                                          .then(res => setMessages(p => [...p, {role:'ai', text:res}]));
                                        e.target.value = '';
                                    }
                                }} placeholder="Ask Tutor..." className="flex-1 glass-input rounded-xl px-4 py-2 text-sm" />
                                <button onClick={async () => {
                                    const img = canvasRef.current.toDataURL();
                                    setMessages(p => [...p, {role:'ai', text: "Analyzing your whiteboard..."}]);
                                    const res = await AI_ENGINE.call(`Check this working out. Q: ${currentQ.text}.`, img);
                                    setMessages(p => [...p, {role:'ai', text: res}]);
                                }} className="premium-btn px-4 rounded-xl"><i className="fa-solid fa-wand-magic-sparkles"></i></button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'DEBRIEF') {
                const score = questions.reduce((acc, q) => acc + (q.markAwarded || 0), 0);
                const max = questions.reduce((acc, q) => acc + (q.marks || 0), 0);
                const pct = Math.round((score/max)*100);

                return (
                    <div className="h-screen w-full flex items-center justify-center bg-slate-950 p-6">
                        <div className="glass-panel w-full max-w-lg p-10 rounded-3xl text-center fade-in">
                            <h2 className="text-xs font-bold tracking-[0.4em] text-blue-400 mb-8">SESSION CONCLUDED</h2>
                            <div className="text-8xl font-black text-white mb-2">{pct}%</div>
                            <div className="text-slate-500 font-bold mb-8 uppercase tracking-widest">{score}/{max} POINTS TOTAL</div>
                            
                            <div className="bg-white/5 p-4 rounded-2xl mb-8 flex justify-between items-center">
                                <span className="text-slate-400 text-sm">Time Taken</span>
                                <span className="text-white font-mono">{Math.floor(timer/60)}m {timer%60}s</span>
                            </div>

                            <div className="flex gap-4">
                                <button onClick={() => window.location.reload()} className="flex-1 py-4 border border-white/10 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition">NEW TEST</button>
                                <button onClick={() => {
                                    const doc = new jspdf.jsPDF();
                                    doc.text(`ATAR HELPER REPORT - ${surname}`, 10, 10);
                                    doc.text(`Score: ${score}/${max} (${pct}%)`, 10, 20);
                                    doc.save(`ATAR_Report_${surname}.pdf`);
                                }} className="flex-1 py-4 premium-btn text-white rounded-xl shadow-lg">DOWNLOAD PDF</button>
                            </div>
                        </div>
                    </div>
                );
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
