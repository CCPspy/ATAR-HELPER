<!-- 
    ATAR HELPER v2.0 | INTERFACE LAYER & LOGIC UPDATE
    PROPERTY OF ERIC / CCPSPY
    WILLETTON SENIOR HIGH SCHOOL
    COPYRIGHT 2026 - ALL RIGHTS RESERVED
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ATAR Helper v2.0</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <!-- PDF.js (Reading) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <!-- jsPDF (Writing Reports) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* Dark Premium Background */
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: #e2e8f0;
            overflow: hidden;
            touch-action: none;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .glass-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus { outline: none; border-color: #22d3ee; box-shadow: 0 0 15px rgba(34, 211, 238, 0.1); }

        .premium-btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .premium-btn:hover:not(:disabled) {
            background: rgba(34, 211, 238, 0.1);
            border-color: rgba(34, 211, 238, 0.5);
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.2);
        }
        .premium-btn:active { transform: scale(0.98); }
        .premium-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        
        /* Loaders */
        .loader-ring div {
            box-sizing: border-box; display: block; position: absolute; width: 64px; height: 64px; margin: 8px;
            border: 4px solid #22d3ee; border-radius: 50%; animation: loader-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: #22d3ee transparent transparent transparent;
        }
        .loader-ring div:nth-child(1) { animation-delay: -0.45s; }
        .loader-ring div:nth-child(2) { animation-delay: -0.3s; }
        .loader-ring div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes loader-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animations */
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .slide-in-right { animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        .spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, memo, useCallback } = React;

        // --- GLOBAL KEY STORE & CONTEXT ---
        let GEMINI_KEYS = []; 
        let SUBJECT_CONTEXT = ""; 
        let USER_PROVIDED_KEY = null;

        // --- UTILS ---
        const decodeBase64 = (str) => { try { let d=atob(str); if(d.includes("AIza"))return d; return null; } catch(e){return null;} }

        // --- AI ENGINE (UPDATED) ---
        const AI_ENGINE = {
            initKeys: async () => {
                try {
                    const ts = new Date().getTime();
                    const res = await fetch(`GE.txt?v=${ts}`); 
                    if (!res.ok) throw new Error("GE.txt missing");
                    const txt = await res.text();
                    GEMINI_KEYS = txt.split('\n').map(k=>k.trim()).filter(k=>k.length>5).map(k => { 
                        if(k.startsWith("AIza")) return k; 
                        return decodeBase64(k); 
                    }).filter(k=>k);
                    console.log(`[System] ${GEMINI_KEYS.length} API Keys Loaded.`);
                    return true;
                } catch(e) { 
                    console.warn("[System] API Key File Missing. Waiting for user override.");
                    return false;
                }
            },

            checkDatabase: async (subject, level) => {
                const safeLevel = level.replace(/ /g, '%20');
                try {
                    // Quick check if file 1 exists
                    const res = await fetch(`data/${subject}/${safeLevel}/1.pdf`, { method: 'HEAD' });
                    return res.ok;
                } catch { return false; }
            },

            // Updated to allow manual context injection
            loadContext: async (subject, level, customFiles = []) => {
                SUBJECT_CONTEXT = "";
                let context = "";

                // 1. Load Custom Files First (Priority)
                if (customFiles.length > 0) {
                    for (const file of customFiles) {
                         // Simple text extraction for now (assuming text files or processed content)
                         // For actual PDF objects in memory we use PDF.js
                         if (file.type === 'application/pdf') {
                             try {
                                const arrayBuffer = await file.arrayBuffer();
                                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                                for(let p=1; p<=Math.min(pdf.numPages, 5); p++) {
                                    const page = await pdf.getPage(p);
                                    const content = await page.getTextContent();
                                    context += content.items.map(item => item.str).join(" ") + " ";
                                }
                             } catch(e) { console.error("PDF Parse Error", e); }
                         } else {
                             // Assume text/plain
                             const text = await file.text();
                             context += text + " ";
                         }
                    }
                    console.log("[System] Custom Context Loaded.");
                }

                // 2. Load Database Files (if available)
                const safeLevel = level.replace(/ /g, '%20');
                let i = 1;
                let dbHit = false;
                while(context.length < 15000) { // Limit context size
                    try {
                        const url = `data/${subject}/${safeLevel}/${i}.pdf`;
                        const res = await fetch(url);
                        if (!res.ok) break;
                        dbHit = true;
                        const blob = await res.blob();
                        const pdf = await pdfjsLib.getDocument(await blob.arrayBuffer()).promise;
                        for(let p=1; p<=Math.min(pdf.numPages, 3); p++) {
                            const page = await pdf.getPage(p);
                            const content = await page.getTextContent();
                            context += content.items.map(item => item.str).join(" ") + " ";
                        }
                        i++;
                        if(i > 10) break; 
                    } catch (e) { break; }
                }
                
                SUBJECT_CONTEXT = context.substring(0, 20000); 
                return { hasContext: SUBJECT_CONTEXT.length > 0, fromDb: dbHit };
            },

            callGemini: async (prompt, imageData = null, jsonMode = false) => {
                const keysToUse = USER_PROVIDED_KEY ? [USER_PROVIDED_KEY] : GEMINI_KEYS;
                
                // CRITICAL: Stop here if no keys to prevent console spam
                if (keysToUse.length === 0) throw new Error("NO_API_KEY");

                // Updated Model List to match Official Documentation
                const models = [
                    "gemini-2.5-flash", 
                    "gemini-2.5-flash-lite", 
                    "gemini-2.0-flash",
                    "gemini-2.0-flash-lite"
                ];
                
                const parts = [{ text: prompt }];
                if (imageData) parts.push({ inline_data: { mime_type: "image/png", data: imageData } });

                let lastError = null;
                for (const model of models) {
                    // Simple Round Robin for system keys, single use for user key
                    const key = USER_PROVIDED_KEY || keysToUse[Math.floor(Math.random() * keysToUse.length)];
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: parts }],
                                generationConfig: { responseMimeType: jsonMode ? "application/json" : "text/plain", temperature: 0.7 }
                            })
                        });
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    } catch (e) { lastError = e; if(USER_PROVIDED_KEY) break; continue; }
                }
                throw lastError || new Error("All Gemini models failed");
            },

            generateQuestion: async (subject, level, topics, difficulty = "Standard") => {
                const topic = topics.length > 0 ? topics[Math.floor(Math.random() * topics.length)] : "General";
                
                // OFFLINE CHECK: If no keys, return offline mode immediately to prevent console error
                if (GEMINI_KEYS.length === 0 && !USER_PROVIDED_KEY) {
                    return {
                        text: `(Offline Mode) Solve $x$ if $2x + 5 = 15$. (API Key Required for AI)`, 
                        topic: "Algebra", 
                        answer: "$x=5$", 
                        hint: "Isolate x", 
                        marks: 2, 
                        isOffline: true
                    };
                }

                const ctx = SUBJECT_CONTEXT ? `Reference Material: ${SUBJECT_CONTEXT.substring(0, 4000)}` : "No specific textbook provided, use general curriculum knowledge.";
                
                try {
                    const prompt = `Role: WACE ATAR Exam Writer. Subject: ${subject} ${level}. Topic: ${topic}. Difficulty: ${difficulty}.
                    ${ctx}
                    Task: Create a single exam question.
                    Output: JSON ONLY.
                    {
                        "text": "The Question in LaTeX $...$",
                        "topic": "${topic}",
                        "answer": "The Final Answer",
                        "hint": "A short hint",
                        "marks": 3
                    }`;
                    
                    const text = await AI_ENGINE.callGemini(prompt, null, true);
                    return JSON.parse(text);
                } catch (e) {
                    // Silent Fallback
                    return {
                        text: `(Offline/Error) Solve $x$ if $2x + 5 = 15$.`, topic: "Algebra", answer: "$x=5$", hint: "Isolate x", marks: 2, isOffline: true
                    };
                }
            }
        };

        // --- MATH RENDERER ---
        const MathText = memo(({ text }) => {
            if (!text) return null;
            const clean = text.replace(/\\/g, '\\'); 
            const parts = clean.split(/(\$[^$]+\$)/g);
            return (
                <div className="font-inter leading-relaxed text-slate-200">
                    {parts.map((part, i) => {
                        if (part.startsWith('$') && part.endsWith('$')) {
                            return <span key={i} className="text-cyan-300 font-serif mx-0.5" dangerouslySetInnerHTML={{__html: katex.renderToString(part.slice(1,-1), {throwOnError:false})}} />;
                        }
                        return <span key={i}>{part}</span>;
                    })}
                </div>
            );
        });

        // --- COMPONENTS ---
        
        // 1. Footer
        const GlobalFooter = () => (
            <div className="fixed bottom-4 left-0 w-full text-center pointer-events-none z-0 opacity-30">
                <p className="text-[10px] font-mono tracking-[0.2em] text-slate-500">ERIC / CCPSPY | WILLETTON SHS | 2026</p>
            </div>
        );

        // 2. Whiteboard
        const Whiteboard = memo(({ tool, color, size, triggerClear, teacherMarks, getCanvasRef }) => {
            const canvasRef = useRef(null);
            const ctxRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                if(getCanvasRef) getCanvasRef(canvasRef);
                const canvas = canvasRef.current;
                const resize = () => {
                    const rect = canvas.getBoundingClientRect();
                    canvas.width = rect.width; canvas.height = rect.height;
                    const ctx = canvas.getContext('2d');
                    ctx.lineCap = "round"; ctx.lineJoin = "round";
                    ctxRef.current = ctx;
                };
                resize();
                window.addEventListener('resize', resize);
                return () => window.removeEventListener('resize', resize);
            }, []);

            useEffect(() => {
                if (triggerClear > 0 && ctxRef.current) {
                    ctxRef.current.clearRect(0,0,canvasRef.current.width, canvasRef.current.height);
                }
            }, [triggerClear]);

            useEffect(() => {
                if (teacherMarks?.length && ctxRef.current) {
                    const ctx = ctxRef.current;
                    ctx.save(); 
                    teacherMarks.forEach((m) => {
                        ctx.strokeStyle = m.type === 'tick' ? '#10b981' : '#ef4444';
                        ctx.lineWidth = 4; ctx.beginPath();
                        const cx = canvasRef.current.width / 2;
                        const cy = canvasRef.current.height / 2;
                        if(m.type === 'tick') { ctx.moveTo(cx-20, cy); ctx.lineTo(cx-5, cy+20); ctx.lineTo(cx+30, cy-30); }
                        else { ctx.moveTo(cx-20, cy-20); ctx.lineTo(cx+20, cy+20); ctx.moveTo(cx+20, cy-20); ctx.lineTo(cx-20, cy+20); }
                        ctx.stroke();
                    });
                    ctx.restore();
                }
            }, [teacherMarks]);

            const start = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                ctxRef.current.beginPath(); ctxRef.current.moveTo(x,y);
                setIsDrawing(true);
            };

            const move = (e) => {
                if(!isDrawing) return;
                const rect = canvasRef.current.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                const ctx = ctxRef.current;
                if(tool==='eraser') { ctx.globalCompositeOperation = 'destination-out'; ctx.lineWidth = size*10; }
                else { ctx.globalCompositeOperation = 'source-over'; ctx.lineWidth = size; ctx.strokeStyle = color; }
                ctx.lineTo(x,y); ctx.stroke();
            };

            return <canvas ref={canvasRef} onMouseDown={start} onMouseMove={move} onMouseUp={()=>setIsDrawing(false)} onMouseLeave={()=>setIsDrawing(false)} onTouchStart={start} onTouchMove={move} onTouchEnd={()=>setIsDrawing(false)} className="w-full h-full cursor-crosshair touch-none" />;
        });

        // 3. Math Keyboard
        const MathKeyboard = ({ onInsert, isOpen, setIsOpen }) => {
            const symbols = [
                "\\pi", "\\theta", "x^2", "\\sqrt{x}", 
                "\\frac{a}{b}", "\\int", "\\sum", "\\infty",
                "\\sin", "\\cos", "\\tan", "\\approx"
            ];
            
            if(!isOpen) return (
                <button onClick={()=>setIsOpen(true)} className="absolute bottom-2 right-2 text-slate-500 hover:text-cyan-400 text-xs">
                    <i className="fa-solid fa-calculator"></i>
                </button>
            );

            return (
                <div className="w-full bg-slate-900/90 border-t border-white/10 p-2 animate-fade-in">
                    <div className="flex justify-between items-center mb-2 px-2">
                        <span className="text-[10px] text-slate-400 font-mono uppercase">Math Input</span>
                        <button onClick={()=>setIsOpen(false)} className="text-[10px] text-red-400 hover:text-white">▼ Collapse</button>
                    </div>
                    <div className="grid grid-cols-6 gap-2">
                        {symbols.map(s => (
                            <button key={s} onClick={() => onInsert(s)} className="p-2 bg-white/5 hover:bg-white/10 rounded text-slate-200 text-sm font-serif">
                                <MathText text={`$${s}$`} />
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // 4. Generic Modal
        const Modal = ({ isOpen, title, message, onConfirm, onCancel, confirmText="Confirm", isDanger=false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4 fade-in">
                    <div className="glass-panel p-6 rounded-2xl max-w-sm w-full border border-white/10 text-center">
                        <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                        <p className="text-slate-400 mb-6 text-sm">{message}</p>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-2 rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700 font-bold text-xs border border-white/10">CANCEL</button>
                            <button onClick={onConfirm} className={`flex-1 py-2 rounded-lg text-white font-bold text-xs shadow-lg ${isDanger ? 'bg-red-600 hover:bg-red-500' : 'bg-cyan-600 hover:bg-cyan-500'}`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            )
        }

        // --- VIEWS ---

        // Layer 1: Gateway
        const Gateway = ({ onNext, setUser }) => {
            const [input, setInput] = useState("");
            return (
                <div className="flex items-center justify-center h-screen w-full relative z-10">
                    <div className="glass-panel p-1 w-full max-w-md rounded-2xl fade-in">
                        <div className="bg-slate-950/50 p-8 rounded-xl flex flex-col items-center border border-white/5">
                            <h1 className="text-3xl font-bold bg-gradient-to-r from-cyan-400 to-emerald-400 bg-clip-text text-transparent mb-6 tracking-tight">ATAR HELPER</h1>
                            <div className="h-1 w-16 bg-blue-500 rounded-full mb-8"></div>
                            
                            <div className="w-full relative mb-8">
                                <label className="absolute -top-3 left-4 bg-slate-900 px-2 text-[10px] text-cyan-500 font-bold tracking-widest">IDENTITY</label>
                                <input 
                                    className="w-full bg-transparent border border-slate-700 rounded-lg py-4 px-4 text-center text-white focus:border-cyan-500 focus:outline-none transition-colors uppercase tracking-widest"
                                    placeholder="ENTER SURNAME"
                                    value={input}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter' && input) onNext();
                                    }}
                                    onChange={(e) => { setInput(e.target.value.toUpperCase()); setUser(e.target.value.toUpperCase()); }}
                                />
                            </div>

                            <button 
                                onClick={onNext} 
                                disabled={!input}
                                className="premium-btn w-full py-4 rounded-lg font-bold text-cyan-50 tracking-widest text-sm hover:text-white disabled:opacity-30 disabled:cursor-not-allowed"
                            >
                                INITIALIZE SYSTEM
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Layer 2: Configuration
        const Configuration = ({ user, config, setConfig, onStart, apiStatus, onBack }) => {
            const [customFiles, setCustomFiles] = useState([]);
            const [apiKeyInput, setApiKeyInput] = useState("");
            const [topics, setTopics] = useState([]);

            const curriculum = {
                "Methods": ["Functions", "Calculus", "Random Variables", "Logarithms", "Integrals"],
                "Specialist": ["Combinatorics", "Vectors", "Complex Numbers", "Matrices", "Diff Eq"],
                "Physics": ["Motion", "Waves", "Gravity", "Electromagnetism", "Quantum"],
                "Chemistry": ["Atomic Structure", "Equilibrium", "Acids & Bases", "Organic", "Redox"]
            };

            useEffect(() => {
                setTopics(curriculum[config.subject] || []);
                setConfig(p => ({...p, selectedTopics: []})); // Reset topics on subject change
            }, [config.subject]);

            const handleFileDrop = (e) => {
                e.preventDefault();
                if (e.dataTransfer.files) {
                    setCustomFiles(Array.from(e.dataTransfer.files));
                    setConfig(p => ({...p, customFiles: Array.from(e.dataTransfer.files)}));
                }
            };

            const toggleTopic = (t) => {
                setConfig(p => {
                    const current = p.selectedTopics;
                    if(current.includes(t)) return {...p, selectedTopics: current.filter(x=>x!==t)};
                    return {...p, selectedTopics: [...current, t]};
                });
            };

            return (
                <div className="flex items-center justify-center h-screen w-full relative z-10 p-4">
                    <div className="glass-panel w-full max-w-6xl h-[85vh] rounded-3xl flex flex-col fade-in overflow-hidden">
                        {/* Header */}
                        <div className="h-16 border-b border-white/10 flex justify-between items-center px-8 bg-slate-900/50">
                            <div className="flex items-center gap-4">
                                <button onClick={onBack} className="text-slate-400 hover:text-white transition-colors">
                                    <i className="fa-solid fa-arrow-left"></i>
                                </button>
                                <span className="font-mono text-cyan-400 tracking-widest text-xs">SESSION CONFIGURATION</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                <span className="font-bold text-slate-300 text-sm">{user}</span>
                            </div>
                        </div>

                        {/* Grid */}
                        <div className="flex-1 grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-white/10 overflow-hidden">
                            
                            {/* Col 1: Core Settings */}
                            <div className="p-8 space-y-8 overflow-y-auto custom-scroll">
                                <div>
                                    <label className="block text-slate-400 text-xs font-bold mb-3 uppercase">Subject Stream</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {Object.keys(curriculum).map(sub => (
                                            <button 
                                                key={sub}
                                                onClick={() => setConfig({...config, subject: sub})}
                                                className={`p-3 rounded-lg text-sm border transition-all text-left ${config.subject === sub ? 'bg-cyan-500/20 border-cyan-500 text-white' : 'border-white/10 text-slate-500 hover:bg-white/5'}`}
                                            >
                                                {sub}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-slate-400 text-xs font-bold mb-3 uppercase">Academic Level</label>
                                    <div className="flex bg-black/20 p-1 rounded-lg">
                                        {["Year 11", "Year 12"].map(l => (
                                            <button 
                                                key={l}
                                                onClick={() => setConfig({...config, level: l})}
                                                className={`flex-1 py-2 rounded-md text-xs font-bold transition-all ${config.level === l ? 'bg-slate-700 text-white shadow-lg' : 'text-slate-500'}`}
                                            >
                                                {l}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between mb-2">
                                        <label className="text-slate-400 text-xs font-bold uppercase">Question Volume</label>
                                        <span className="text-cyan-400 font-mono text-xs">{config.count} Qs</span>
                                    </div>
                                    <input 
                                        type="range" min="1" max="10" 
                                        value={config.count} 
                                        onChange={(e) => setConfig({...config, count: parseInt(e.target.value)})}
                                        className="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                                    />
                                </div>
                            </div>

                            {/* Col 2: Focus & Topics */}
                            <div className="p-8 flex flex-col h-full overflow-hidden">
                                <div className="flex justify-center mb-6">
                                    <div className="bg-black/20 p-1 rounded-full flex gap-2">
                                        <button onClick={()=>setConfig({...config, mode:'comprehensive'})} className={`px-4 py-1 rounded-full text-xs font-bold ${config.mode==='comprehensive'?'bg-cyan-600 text-white':'text-slate-500'}`}>Comprehensive</button>
                                        <button onClick={()=>setConfig({...config, mode:'targeted'})} className={`px-4 py-1 rounded-full text-xs font-bold ${config.mode==='targeted'?'bg-purple-600 text-white':'text-slate-500'}`}>Targeted</button>
                                    </div>
                                </div>
                                
                                <div className="flex-1 bg-black/20 rounded-xl p-4 overflow-y-auto custom-scroll border border-white/5">
                                    {config.mode === 'comprehensive' ? (
                                        <div className="h-full flex flex-col items-center justify-center text-center opacity-50">
                                            <i className="fa-solid fa-globe text-4xl mb-2"></i>
                                            <p className="text-sm">Full Curriculum Coverage</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {topics.map(t => (
                                                <button 
                                                    key={t}
                                                    onClick={() => toggleTopic(t)}
                                                    className={`w-full p-3 rounded-lg flex justify-between items-center text-sm border transition-all ${config.selectedTopics.includes(t) ? 'bg-purple-500/20 border-purple-500 text-white' : 'bg-transparent border-white/5 text-slate-400 hover:border-white/20'}`}
                                                >
                                                    {t}
                                                    {config.selectedTopics.includes(t) && <i className="fa-solid fa-check text-purple-400"></i>}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Col 3: Customization */}
                            <div className="p-8 flex flex-col space-y-6 overflow-y-auto custom-scroll">
                                <div>
                                    <label className="block text-slate-400 text-xs font-bold mb-3 uppercase">Prompt Engineering</label>
                                    <textarea 
                                        className="w-full h-24 glass-input rounded-xl p-3 text-sm resize-none"
                                        placeholder="e.g. 'Focus heavily on calculus applications' or 'Make questions very difficult'"
                                        value={config.instructions}
                                        onChange={(e) => setConfig({...config, instructions: e.target.value})}
                                    ></textarea>
                                </div>

                                <div 
                                    onDragOver={(e)=>e.preventDefault()} 
                                    onDrop={handleFileDrop}
                                    className={`border-2 border-dashed rounded-xl p-6 text-center transition-all ${customFiles.length > 0 ? 'border-emerald-500 bg-emerald-500/10' : 'border-white/10 hover:border-cyan-500/50'}`}
                                >
                                    <i className={`fa-solid ${customFiles.length>0?'fa-file-circle-check text-emerald-400':'fa-cloud-arrow-up text-slate-500'} text-2xl mb-2`}></i>
                                    <p className="text-xs text-slate-400">{customFiles.length > 0 ? `${customFiles.length} File(s) Ready` : "Drop PDF/Text Context Here"}</p>
                                    <input type="file" multiple className="hidden" id="fileUpload" onChange={(e)=> {
                                        if(e.target.files) {
                                            setCustomFiles(Array.from(e.target.files));
                                            setConfig(p => ({...p, customFiles: Array.from(e.target.files)}));
                                        }
                                    }} />
                                    <label htmlFor="fileUpload" className="text-[10px] text-cyan-400 underline cursor-pointer mt-2 block">or browse</label>
                                </div>

                                <div>
                                    <label className="block text-slate-400 text-xs font-bold mb-3 uppercase flex justify-between">
                                        <span>API Key Override</span>
                                        {!apiStatus && <span className="text-red-400"><i className="fa-solid fa-triangle-exclamation"></i> Required</span>}
                                    </label>
                                    <input 
                                        type="password" 
                                        className="w-full glass-input rounded-lg p-2 text-xs" 
                                        placeholder="Enter Google Gemini API Key if system fails..."
                                        value={apiKeyInput}
                                        onChange={(e) => {
                                            setApiKeyInput(e.target.value);
                                            USER_PROVIDED_KEY = e.target.value;
                                        }}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Footer Action */}
                        <button onClick={onStart} className="h-16 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold tracking-widest text-sm transition-colors flex items-center justify-center gap-3">
                            <span>START SIMULATION</span>
                            <i className="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            );
        };

        // Layer 3: Arena
        const Arena = ({ 
            questions, currentQIndex, setCurrentQIndex, 
            userAns, setUserAns, onSubmit, onGiveUp, onCheckWork, 
            isProcessing, messages, chatInput, setChatInput, onChat, 
            teacherMarks, setWbTool, setWbColor, triggerClear, wbTool, wbColor,
            timer, onFinish, apiStatus, dbStatus, onReturnMenu
        }) => {
            const [qCollapsed, setQCollapsed] = useState(false);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [mathKbOpen, setMathKbOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('tutor'); // 'tutor' or 'results'
            const [modalConfig, setModalConfig] = useState(null); // { title, message, onConfirm, onCancel }

            const scrollRef = useRef(null);

            useEffect(() => { if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages, activeTab]);

            const q = questions[currentQIndex] || {};
            const isGraded = q.status === 'correct' || q.status === 'wrong';

            // Auto switch to results when graded
            useEffect(() => {
                if (isGraded) {
                    setActiveTab('results');
                } else {
                    setActiveTab('tutor'); // Reset to tutor for new questions
                }
            }, [currentQIndex, q.status]);

            const handleClearConfirm = () => {
                triggerClear();
                setModalConfig(null);
            };

            const handleGiveUpConfirm = () => {
                onGiveUp();
                setModalConfig(null);
            };

            const handleQuitConfirm = () => {
                setModalConfig(null);
                onReturnMenu();
            };

            return (
                <div className="fixed inset-0 flex bg-slate-950 z-20">
                    <Modal 
                        isOpen={!!modalConfig} 
                        title={modalConfig?.title} 
                        message={modalConfig?.message} 
                        onConfirm={modalConfig?.onConfirm} 
                        onCancel={() => setModalConfig(null)} 
                        confirmText={modalConfig?.confirmText}
                        isDanger={modalConfig?.isDanger}
                    />

                    {/* Left Sidebar */}
                    <div className="w-20 glass-panel border-r border-white/5 flex flex-col items-center py-6 z-30">
                        {/* Status Indicator */}
                        <div className="mb-6 flex flex-col items-center mt-4">
                            {!apiStatus ? (
                                <>
                                    <div className="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444]"></div>
                                    <span className="text-[9px] font-bold text-red-500 mt-2 tracking-wider text-center">OFFLINE</span>
                                </>
                            ) : !dbStatus ? (
                                <>
                                    <div className="w-2 h-2 rounded-full bg-amber-500 shadow-[0_0_10px_#f59e0b]"></div>
                                    <span className="text-[9px] font-bold text-amber-500 mt-2 tracking-wider text-center">NO DB</span>
                                </>
                            ) : (
                                <>
                                    <div className="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]"></div>
                                    <span className="text-[9px] font-bold text-emerald-500 mt-2 tracking-wider text-center">ONLINE</span>
                                </>
                            )}
                        </div>

                        {/* Questions List (Moved Down) */}
                        <div className="flex-1 w-full flex flex-col items-center gap-4 overflow-y-auto custom-scroll no-scrollbar pt-4 pb-4">
                            {questions.map((ques, i) => (
                                <button key={i} onClick={() => !isProcessing && ques.status !== 'generating' && setCurrentQIndex(i)}
                                    className={`w-10 h-10 rounded-lg flex items-center justify-center text-xs font-bold transition-all relative
                                    ${i === currentQIndex ? 'ring-2 ring-white scale-110 z-10' : 'opacity-60 hover:opacity-100'}
                                    ${ques.status === 'generating' ? 'bg-transparent border-2 border-cyan-500/50' : 
                                      ques.status === 'correct' ? 'bg-emerald-600 text-white' : 
                                      ques.status === 'wrong' ? 'bg-red-600 text-white' : 
                                      'bg-slate-800 text-slate-300'}`}
                                >
                                    {ques.status === 'generating' ? <i className="fa-solid fa-spinner fa-spin text-cyan-400"></i> : i + 1}
                                </button>
                            ))}
                        </div>
                        
                        <div className="flex flex-col gap-4 mt-2">
                             <button onClick={() => setModalConfig({
                                title: "Quit Session?",
                                message: "Progress will be lost. Return to menu?",
                                confirmText: "Quit",
                                isDanger: true,
                                onConfirm: handleQuitConfirm
                            })} className="text-slate-500 hover:text-red-400 transition-colors" title="Exit">
                                <i className="fa-solid fa-right-from-bracket"></i>
                            </button>
                            <button onClick={onFinish} className="text-slate-500 hover:text-white transition-colors" title="Finish & Report">
                                <i className="fa-solid fa-flag-checkered"></i>
                            </button>
                        </div>
                    </div>

                    {/* Center Canvas Workspace */}
                    <div className="flex-1 relative bg-[#0f172a]">
                        <Whiteboard 
                            tool={wbTool} color={wbColor} size={2} 
                            triggerClear={triggerClear} teacherMarks={teacherMarks} 
                            getCanvasRef={(ref) => window._canvasRef = ref}
                        />

                        {/* Top Overlay Tools */}
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 glass-panel px-6 py-3 rounded-full flex items-center gap-6 shadow-2xl">
                            <button onClick={()=>setWbTool('pen')} className={`${wbTool==='pen'?'text-cyan-400 drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]':'text-slate-400'}`}><i className="fa-solid fa-pen"></i></button>
                            <button onClick={()=>setWbTool('eraser')} className={`${wbTool==='eraser'?'text-pink-400 drop-shadow-[0_0_5px_rgba(244,114,182,0.8)]':'text-slate-400'}`}><i className="fa-solid fa-eraser"></i></button>
                            <input type="color" value={wbColor} onChange={(e)=>setWbColor(e.target.value)} className="w-5 h-5 rounded-full bg-transparent border-none cursor-pointer" />
                            <div className="w-px h-4 bg-white/20"></div>
                            <button onClick={() => setModalConfig({
                                title: "Clear Board?",
                                message: "This cannot be undone.",
                                confirmText: "Clear",
                                isDanger: true,
                                onConfirm: handleClearConfirm
                            })} className="text-red-400 hover:text-red-300 text-xs font-bold">CLR</button>
                            <div className="w-px h-4 bg-white/20"></div>
                            <span className="font-mono text-white text-sm">⏱ {Math.floor(timer/60).toString().padStart(2,'0')}:{ (timer%60).toString().padStart(2,'0') }</span>
                        </div>

                        {/* Question Card Overlay */}
                        <div className={`absolute top-20 left-6 transition-all duration-300 ${qCollapsed ? 'w-12 h-12 overflow-hidden bg-slate-800/80 rounded-full cursor-pointer hover:bg-slate-700' : 'max-w-md glass-panel rounded-lg border-l-4 border-cyan-500'}`}>
                            {qCollapsed ? (
                                <div className="w-full h-full flex items-center justify-center text-cyan-400" onClick={()=>setQCollapsed(false)}>
                                    <i className="fa-solid fa-expand"></i>
                                </div>
                            ) : (
                                <div className="p-5">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex gap-2">
                                            <span className="text-[10px] font-bold uppercase tracking-widest text-cyan-400">{q.topic || "TOPIC"}</span>
                                            <span className="bg-white/10 px-1 rounded text-[10px] text-slate-300">{q.marks || 3} Marks</span>
                                        </div>
                                        <button onClick={()=>setQCollapsed(true)} className="text-slate-500 hover:text-white"><i className="fa-solid fa-minus"></i></button>
                                    </div>
                                    <div className="text-sm">
                                        {q.status === 'generating' ? <span className="animate-pulse">Decrypting...</span> : <MathText text={q.text} />}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Bottom Interaction Area */}
                        <div className="absolute bottom-10 left-1/2 -translate-x-1/2 w-full max-w-xl flex flex-col items-center gap-2">
                            {/* Math Keyboard */}
                            {mathKbOpen && (
                                <div className="w-full rounded-t-xl overflow-hidden shadow-2xl">
                                    <MathKeyboard 
                                        isOpen={mathKbOpen} setIsOpen={setMathKbOpen}
                                        onInsert={(sym) => setUserAns(p => p + sym)} 
                                    />
                                </div>
                            )}
                            
                            <div className="glass-panel p-2 rounded-xl flex gap-2 w-full shadow-2xl relative">
                                {!isGraded ? (
                                    <>
                                        <button onClick={() => setModalConfig({
                                            title: "Surrender Question?",
                                            message: "You will receive 0 marks for this question.",
                                            confirmText: "Surrender",
                                            isDanger: true,
                                            onConfirm: handleGiveUpConfirm
                                        })} className="px-4 py-2 bg-red-900/30 border border-red-500/30 text-red-400 rounded-lg text-xs font-bold hover:bg-red-900/50">GIVE UP</button>
                                        <div className="flex-1 relative">
                                            <input 
                                                className="w-full h-full bg-black/40 border border-white/10 rounded-lg px-4 text-white text-sm focus:border-cyan-500 focus:outline-none font-mono"
                                                placeholder="Type answer or use keyboard..."
                                                value={userAns}
                                                onChange={(e)=>setUserAns(e.target.value)}
                                                onKeyDown={(e)=>e.key==='Enter' && onSubmit()}
                                                onFocus={()=>setMathKbOpen(true)}
                                            />
                                            {!mathKbOpen && (
                                                <button onClick={()=>setMathKbOpen(true)} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-cyan-400">
                                                    <i className="fa-solid fa-keyboard"></i>
                                                </button>
                                            )}
                                        </div>
                                        <button onClick={onSubmit} disabled={isProcessing} className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-bold text-sm shadow-[0_0_15px_rgba(8,145,178,0.4)] transition-all">
                                            {isProcessing ? <i className="fa-solid fa-circle-notch animate-spin"></i> : "SUBMIT"}
                                        </button>
                                    </>
                                ) : (
                                    <button onClick={()=>setCurrentQIndex(p => Math.min(questions.length-1, p+1))} className="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-lg flex items-center justify-center gap-2">
                                        NEXT QUESTION <i className="fa-solid fa-forward"></i>
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Mobile Toggle for Drawer */}
                        <button onClick={()=>setDrawerOpen(!drawerOpen)} className="absolute top-4 right-4 md:hidden z-50 bg-slate-800 p-2 rounded text-white">
                            <i className="fa-solid fa-bars"></i>
                        </button>
                    </div>

                    {/* Right Drawer (Tutor/Results) */}
                    <div className={`fixed inset-y-0 right-0 w-80 md:w-96 glass-panel border-l border-white/10 z-40 transform transition-transform duration-300 ${drawerOpen ? 'translate-x-0' : 'translate-x-full md:translate-x-0'} flex flex-col`}>
                        <div className="h-14 border-b border-white/10 flex items-center justify-center gap-0">
                            <button 
                                onClick={() => setActiveTab('tutor')}
                                className={`flex-1 h-full text-xs font-bold transition-colors ${activeTab === 'tutor' ? 'text-cyan-400 border-b-2 border-cyan-400 bg-cyan-500/5' : 'text-slate-500 hover:text-slate-300'}`}
                            >
                                <i className="fa-solid fa-robot mr-2"></i>AI TUTOR
                            </button>
                            <button 
                                onClick={() => setActiveTab('results')}
                                className={`flex-1 h-full text-xs font-bold transition-colors ${activeTab === 'results' ? 'text-purple-400 border-b-2 border-purple-400 bg-purple-500/5' : 'text-slate-500 hover:text-slate-300'}`}
                            >
                                <i className="fa-solid fa-clipboard-check mr-2"></i>RESULTS
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 custom-scroll" ref={scrollRef}>
                            {activeTab === 'tutor' ? (
                                <div className="space-y-4">
                                    {messages.map((m, i) => (
                                        <div key={i} className={`flex flex-col ${m.role === 'user' ? 'items-end' : 'items-start'}`}>
                                            <div className={`max-w-[90%] p-3 rounded-xl text-sm ${m.role === 'user' ? 'bg-cyan-900/40 text-cyan-50 border border-cyan-500/20' : 'bg-slate-800/50 text-slate-300 border border-white/5'}`}>
                                                <MathText text={m.text} />
                                            </div>
                                            <span className="text-[9px] text-slate-600 mt-1 uppercase">{m.role}</span>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {isGraded ? (
                                        <div className="animate-fade-in">
                                            <div className={`p-4 rounded-xl border mb-4 text-center ${q.status === 'correct' ? 'bg-emerald-900/20 border-emerald-500/30' : 'bg-red-900/20 border-red-500/30'}`}>
                                                <div className="text-2xl font-bold text-white mb-1">{q.userMark || 0} / {q.marks || 3}</div>
                                                <div className={`text-xs font-bold uppercase tracking-wider ${q.status === 'correct' ? 'text-emerald-400' : 'text-red-400'}`}>
                                                    {q.status === 'correct' ? 'Correct Answer' : 'Incorrect'}
                                                </div>
                                            </div>
                                            
                                            {q.feedback && (
                                                <>
                                                    <div className="bg-slate-900/50 rounded-xl p-4 border border-white/5 mb-3">
                                                        <div className="text-xs font-bold text-emerald-400 mb-2 uppercase tracking-wide"><i className="fa-solid fa-thumbs-up mr-2"></i>Positives</div>
                                                        <div className="text-sm text-slate-300 leading-relaxed"><MathText text={q.feedback.positives || "N/A"} /></div>
                                                    </div>
                                                    <div className="bg-slate-900/50 rounded-xl p-4 border border-white/5">
                                                        <div className="text-xs font-bold text-amber-400 mb-2 uppercase tracking-wide"><i className="fa-solid fa-lightbulb mr-2"></i>Improvements</div>
                                                        <div className="text-sm text-slate-300 leading-relaxed"><MathText text={q.feedback.improvements || "N/A"} /></div>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-slate-500 opacity-60 mt-10">
                                            <i className="fa-solid fa-hourglass-half text-4xl mb-4"></i>
                                            <p className="text-sm">Submit an answer to see results.</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {activeTab === 'tutor' && (
                            <div className="p-4 border-t border-white/10 bg-slate-950/50">
                                {!isGraded && <button onClick={onCheckWork} disabled={isProcessing} className="w-full py-2 mb-3 bg-purple-900/30 border border-purple-500/30 text-purple-300 rounded hover:bg-purple-900/50 text-xs font-bold">CHECK WORKING</button>}
                                <div className="relative">
                                    <input 
                                        className="w-full bg-black/40 border border-white/10 rounded-lg py-2 pl-3 pr-10 text-xs text-white focus:border-cyan-500 focus:outline-none"
                                        placeholder="Ask the AI Tutor..."
                                        value={chatInput}
                                        onChange={(e)=>setChatInput(e.target.value)}
                                        onKeyPress={(e)=>e.key==='Enter' && onChat()}
                                    />
                                    <button onClick={onChat} className="absolute right-2 top-1/2 -translate-y-1/2 text-cyan-500 hover:text-white">
                                        <i className="fa-solid fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Layer 4: Debrief
        const Debrief = ({ questions, timer, onRestart }) => {
            const score = questions.reduce((acc, q) => acc + (q.userMark || 0), 0);
            const total = questions.reduce((acc, q) => acc + (q.maxMarks || 3), 0);
            const percentage = Math.round((score / total) * 100) || 0;

            const downloadPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont("helvetica", "bold"); doc.setFontSize(22);
                doc.text("ATAR HELPER SESSION REPORT", 105, 20, null, null, "center");
                doc.setFontSize(12); doc.setFont("helvetica", "normal");
                doc.text(`Score: ${score}/${total} (${percentage}%)`, 20, 40);
                doc.text(`Duration: ${Math.floor(timer/60)}m ${timer%60}s`, 20, 50);
                
                let y = 70;
                questions.forEach((q, i) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    doc.setFont("helvetica", "bold");
                    doc.text(`Q${i+1}: ${q.topic}`, 20, y);
                    y+=7;
                    doc.setFont("helvetica", "normal");
                    const qText = doc.splitTextToSize(q.text.replace(/\$/g, ''), 170);
                    doc.text(qText, 20, y);
                    y += (qText.length * 5) + 5;
                    doc.setTextColor(100);
                    doc.text(`Feedback: ${q.feedback?.improvements || 'N/A'}`, 20, y);
                    doc.setTextColor(0);
                    y += 20;
                });
                doc.save("Session_Report.pdf");
            };

            return (
                <div className="fixed inset-0 flex items-center justify-center bg-black/80 backdrop-blur z-50 fade-in">
                    <div className="glass-panel p-10 rounded-3xl text-center max-w-lg w-full border border-white/20">
                        <h2 className="text-3xl font-bold text-white mb-2">SESSION CONCLUDED</h2>
                        <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-br from-cyan-400 to-purple-500 my-8">
                            {percentage}%
                        </div>
                        <div className="flex justify-center gap-8 text-slate-400 mb-8 font-mono text-sm">
                            <div>
                                <div className="text-white font-bold">{score}/{total}</div>
                                <div>POINTS</div>
                            </div>
                            <div>
                                <div className="text-white font-bold">{Math.floor(timer/60)}m {timer%60}s</div>
                                <div>TIME</div>
                            </div>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={downloadPDF} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-bold transition">DOWNLOAD PDF</button>
                            <button onClick={onRestart} className="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-xl text-white font-bold transition">NEW TEST</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP CONTROLLER ---
        const App = () => {
            const [view, setView] = useState('gateway'); // gateway, config, arena, debrief
            const [user, setUser] = useState("");
            const [apiStatus, setApiStatus] = useState(true);
            const [dbStatus, setDbStatus] = useState(true);
            
            // Config State
            const [config, setConfig] = useState({
                subject: 'Methods', level: 'Year 12', count: 5, 
                mode: 'comprehensive', selectedTopics: [],
                instructions: "", customFiles: []
            });

            // Session State
            const [questions, setQuestions] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [loading, setLoading] = useState(false);
            const [timer, setTimer] = useState(0);
            const [isProcessing, setIsProcessing] = useState(false);
            
            // Chat & Grading
            const [messages, setMessages] = useState([]);
            const [chatInput, setChatInput] = useState("");
            const [userAns, setUserAns] = useState("");
            const [teacherMarks, setTeacherMarks] = useState([]);
            const [triggerClear, setTriggerClear] = useState(0);

            // Tools
            const [wbTool, setWbTool] = useState('pen');
            const [wbColor, setWbColor] = useState('#22d3ee');

            // --- EFFECTS ---
            useEffect(() => {
                const init = async () => {
                    const keysOk = await AI_ENGINE.initKeys();
                    setApiStatus(keysOk);
                    const dbOk = await AI_ENGINE.checkDatabase('Methods', 'Year 12');
                    setDbStatus(dbOk);
                };
                init();
            }, []);

            useEffect(() => {
                let interval;
                if(view === 'arena') interval = setInterval(() => setTimer(t => t+1), 1000);
                return () => clearInterval(interval);
            }, [view]);

            // --- HANDLERS ---
            
            const startSession = async () => {
                setLoading(true);
                // Load Context
                await AI_ENGINE.loadContext(config.subject, config.level, config.customFiles);
                
                // Initialize Placeholder Questions
                const initialQs = Array(config.count).fill(null).map((_, i) => ({ 
                    status: 'generating', text: 'Decrypting question data...', marks: 3 
                }));
                setQuestions(initialQs);
                setMessages([{ role: 'system', text: `Session Active. Subject: ${config.subject}. Good luck, ${user}.` }]);
                
                // PRE-LOADER LOGIC: Generate 2 questions before dropping curtain
                const q1 = await AI_ENGINE.generateQuestion(config.subject, config.level, config.selectedTopics);
                const q2 = await AI_ENGINE.generateQuestion(config.subject, config.level, config.selectedTopics);
                
                setQuestions(prev => {
                    const n = [...prev];
                    n[0] = { ...q1, status: 'ready', userMark: 0 };
                    n[1] = { ...q2, status: 'ready', userMark: 0 };
                    return n;
                });

                // Start Background Generator for rest
                generateBackgroundQuestions(2, config.count);

                setLoading(false);
                setView('arena');
            };

            const generateBackgroundQuestions = async (startIndex, total) => {
                for (let i = startIndex; i < total; i++) {
                    await new Promise(r => setTimeout(r, 2000)); // Rate limit
                    const q = await AI_ENGINE.generateQuestion(config.subject, config.level, config.selectedTopics);
                    
                    // Optimization: If offline mode triggered, fill rest instantly to avoid spamming errors
                    if (q.isOffline) {
                        setQuestions(prev => {
                            const n = [...prev];
                            for (let k = i; k < total; k++) {
                                n[k] = { ...q, status: 'ready', userMark: 0, text: q.text + (k > i ? ` (Var ${k})` : '') };
                            }
                            return n;
                        });
                        break; 
                    }

                    setQuestions(prev => {
                        const n = [...prev];
                        if (n[i]) n[i] = { ...q, status: 'ready', userMark: 0 };
                        return n;
                    });
                }
            };

            const handleSubmitAnswer = async () => {
                if(!userAns.trim()) return;
                setIsProcessing(true);
                setMessages(p => [...p, { role: 'user', text: `Submitted: ${userAns}` }, { role: 'ai', text: "Grading..." }]);

                const q = questions[currentQIndex];
                let imgData = null;
                if(window._canvasRef && window._canvasRef.current) {
                    imgData = window._canvasRef.current.toDataURL('image/png').split(',')[1];
                }

                try {
                    const prompt = `Role: Teacher. Grade this. 
                    Q: ${q.text}. 
                    Correct Ans: ${q.answer}. 
                    Student Ans: ${userAns}. 
                    Max Marks: ${q.marks}.
                    Check image for working out if possible.
                    Output JSON: { "mark": number, "correct": boolean, "feedback": { "positives": "", "improvements": "" } }`;

                    const resTxt = await AI_ENGINE.callGemini(prompt, imgData, true);
                    const result = JSON.parse(resTxt);

                    setQuestions(prev => {
                        const n = [...prev];
                        n[currentQIndex] = { ...n[currentQIndex], status: result.correct ? 'correct' : 'wrong', userMark: result.mark, feedback: result.feedback };
                        return n;
                    });

                    if (result.mark > 0) setTeacherMarks([{ type: 'tick', x: 0, y: 0 }]); // Canvas handles pos
                    else setTeacherMarks([{ type: 'cross', x: 0, y: 0 }]);
                    
                    setMessages(p => {
                        const n = [...p]; n.pop(); // remove 'Grading...'
                        return [...n, { role: 'ai', text: `Result: ${result.mark}/${q.marks}. ${result.correct ? 'Correct' : 'Incorrect'}.` }];
                    });

                } catch(e) {
                    // console.error(e); // Suppress log
                    if (e.message === "NO_API_KEY") {
                        setMessages(p => { const n = [...p]; n.pop(); return [...n, { role: 'system', text: "Error: No API Key Provided. Cannot Grade." }]; });
                    } else {
                        alert("Grading Error. Please try again.");
                    }
                }
                setIsProcessing(false);
            };

            const handleGiveUp = () => {
                setQuestions(prev => {
                    const n = [...prev];
                    n[currentQIndex] = { ...n[currentQIndex], status: 'wrong', userMark: 0, feedback: { improvements: "Student surrendered." } };
                    return n;
                });
                setTeacherMarks([{ type: 'cross', x: 0, y: 0 }]);
                setMessages(p => [...p, { role: 'ai', text: `The answer was: ${questions[currentQIndex].answer}` }]);
            };

            const handleCheckWork = async () => {
                if(isProcessing) return;
                setIsProcessing(true);
                setMessages(p => [...p, { role: 'ai', text: "Analyzing whiteboard..." }]);
                
                try {
                    let imgData = null;
                    if(window._canvasRef && window._canvasRef.current) {
                        imgData = window._canvasRef.current.toDataURL('image/png').split(',')[1];
                    }
                    if(!imgData) throw new Error("No board data");

                    const prompt = `Analyze the student's working for Q: ${questions[currentQIndex].text}. Give a brief hint.`;
                    const hint = await AI_ENGINE.callGemini(prompt, imgData, false);
                    
                    setMessages(p => { const n = [...p]; n.pop(); return [...n, { role: 'ai', text: hint }]; });
                } catch(e) {
                    const msg = e.message === "NO_API_KEY" ? "Offline Mode: AI features unavailable without API Key." : "Canvas empty or error.";
                    setMessages(p => { const n = [...p]; n.pop(); return [...n, { role: 'ai', text: msg }]; });
                }
                setIsProcessing(false);
            };

            const handleChat = async () => {
                if(!chatInput.trim() || isProcessing) return;
                const txt = chatInput; setChatInput("");
                setMessages(p => [...p, { role: 'user', text: txt }, { role: 'ai', text: "..." }]);
                setIsProcessing(true);
                try {
                    const ctx = `Current Q: ${questions[currentQIndex]?.text}`;
                    const res = await AI_ENGINE.callGemini(`System Context: ${ctx}. User: ${txt}. Reply concisely.`, null, false);
                    setMessages(p => { const n = [...p]; n.pop(); return [...n, { role: 'ai', text: res }]; });
                } catch(e) {
                     const msg = e.message === "NO_API_KEY" ? "Offline Mode: AI features unavailable." : "Connection error.";
                    setMessages(p => { const n = [...p]; n.pop(); return [...n, { role: 'ai', text: msg }]; });
                }
                setIsProcessing(false);
            };

            const changeQuestion = (idx) => {
                setCurrentQIndex(idx);
                setTeacherMarks([]);
                setTriggerClear(p => p+1);
                setUserAns("");
            };

            // --- RENDER ---
            return (
                <>
                    {view === 'gateway' && <Gateway onNext={() => setView('config')} setUser={setUser} />}
                    
                    {view === 'config' && (
                        <Configuration 
                            user={user} config={config} setConfig={setConfig} 
                            onStart={startSession} apiStatus={apiStatus}
                            onBack={() => setView('gateway')}
                        />
                    )}
                    
                    {view === 'arena' && (
                        <Arena 
                            questions={questions} currentQIndex={currentQIndex} setCurrentQIndex={changeQuestion}
                            userAns={userAns} setUserAns={setUserAns}
                            onSubmit={handleSubmitAnswer} onGiveUp={handleGiveUp} onCheckWork={handleCheckWork}
                            isProcessing={isProcessing} messages={messages}
                            chatInput={chatInput} setChatInput={setChatInput} onChat={handleChat}
                            teacherMarks={teacherMarks}
                            setWbTool={setWbTool} setWbColor={setWbColor} triggerClear={() => setTriggerClear(p=>p+1)}
                            wbTool={wbTool} wbColor={wbColor}
                            timer={timer} onFinish={()=>setView('debrief')}
                            apiStatus={apiStatus} dbStatus={dbStatus}
                            onReturnMenu={() => setView('config')}
                        />
                    )}

                    {view === 'debrief' && <Debrief questions={questions} timer={timer} onRestart={() => window.location.reload()} />}

                    {loading && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center fade-in">
                            <div className="loader-ring mb-4"><div></div><div></div><div></div></div>
                            <div className="text-xl font-bold text-white tracking-widest animate-pulse">INITIALIZING SESSION</div>
                            <div className="text-cyan-500 font-mono mt-2">Generating initial vector set...</div>
                        </div>
                    )}
                    
                    <GlobalFooter />
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
